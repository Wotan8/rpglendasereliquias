/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ö° CORRE√á√ÉO IMEDIATA - ALAN BILTROX
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   
   USE ESTE SCRIPT PARA CORRIGIR ALAN BILTROX AGORA!
   
   COMO USAR:
   1. Carregue a ficha do Alan Biltrox no navegador
   2. Pressione F12 para abrir o Console
   3. Copie TODO este c√≥digo
   4. Cole no Console
   5. Pressione Enter
   6. Aguarde a mensagem de sucesso
   7. P√°gina vai recarregar automaticamente
   8. ‚úÖ Alan Biltrox estar√° corrigido!
   
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

(function() {
    console.log('%c‚ö° INICIANDO CORRE√á√ÉO DO PERSONAGEM', 'color: #8b5cf6; font-size: 16px; font-weight: bold');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    // Verificar se character existe
    if (typeof window.character === 'undefined') {
        console.error('‚ùå window.character n√£o existe!');
        console.error('Certifique-se de que a ficha est√° carregada.');
        return;
    }
    
    const char = window.character;
    console.log('‚úÖ Personagem encontrado:', char.nome);
    console.log('\nüìã Verificando campos...\n');
    
    let needsSave = false;
    const fixes = [];
    
    // 1. Verificar e corrigir atributos
    const attrs = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
    attrs.forEach(attr => {
        if (typeof char[attr] !== 'number' || isNaN(char[attr])) {
            console.warn(`‚ö†Ô∏è Atributo ${attr} inv√°lido (${char[attr]}), corrigindo para 0`);
            char[attr] = 0;
            fixes.push(`Atributo ${attr} corrigido`);
            needsSave = true;
        }
    });
    
    // 2. Verificar e corrigir skills
    if (!char.skills || typeof char.skills !== 'object') {
        console.warn('‚ö†Ô∏è Skills ausentes, criando estrutura padr√£o');
        char.skills = {};
        fixes.push('Estrutura de skills criada');
        needsSave = true;
    }
    
    // Lista de skills necess√°rias
    const requiredSkills = [
        'atletismo', 'luta', 'pontaria', 'fortitude',
        'furtividade', 'crime', 'pilotagem', 'reflexos',
        'atuacao', 'intimidacao', 'intuicao', 'lbia',
        'percepcao', 'ciencias', 'diplomacia', 'medicina',
        'ocultismo', 'profissao', 'tecnologia', 'agilidade', 'abismo'
    ];
    
    requiredSkills.forEach(skill => {
        if (typeof char.skills[skill] !== 'number') {
            console.warn(`‚ö†Ô∏è Skill ${skill} ausente, adicionando com valor 0`);
            char.skills[skill] = 0;
            fixes.push(`Skill ${skill} adicionada`);
            needsSave = true;
        }
    });
    
    // 3. Verificar e corrigir campos b√°sicos
    const basicFields = {
        nome: '',
        jogador: '',
        idade: 0,
        raca: '',
        classe: '',
        virtude: '',
        vicio: '',
        tamanho: 0,
        luns: 0,
        notas: '',
        blindagem: 0,
        exp: 0
    };
    
    Object.entries(basicFields).forEach(([field, defaultValue]) => {
        if (char[field] === undefined || char[field] === null) {
            console.warn(`‚ö†Ô∏è Campo ${field} ausente, definindo valor padr√£o`);
            char[field] = defaultValue;
            fixes.push(`Campo ${field} adicionado`);
            needsSave = true;
        }
    });
    
    // Garantir que n√∫meros s√£o realmente n√∫meros
    ['idade', 'tamanho', 'luns', 'blindagem', 'exp'].forEach(field => {
        if (typeof char[field] !== 'number' || isNaN(char[field])) {
            console.warn(`‚ö†Ô∏è Campo ${field} n√£o √© n√∫mero v√°lido, corrigindo para 0`);
            char[field] = 0;
            fixes.push(`Campo ${field} corrigido para n√∫mero`);
            needsSave = true;
        }
    });
    
    // 4. Calcular e corrigir valores de HP, DET, SAN
    const vig = char.vig || 0;
    const tamanho = char.tamanho || 0;
    const prs = char.prs || 0;
    const aut = char.aut || 0;
    const int = char.int || 0;
    const abismo = char.skills?.['abismo'] || 0;
    
    const calculatedMaxHP = vig + tamanho;
    const calculatedMaxDET = prs + aut;
    const calculatedMaxSAN = Math.max((int + aut - (abismo * 2)) * 10, 0);
    
    if (typeof char.hpCurrent !== 'number' || isNaN(char.hpCurrent)) {
        console.warn(`‚ö†Ô∏è hpCurrent ausente/inv√°lido, calculando: ${calculatedMaxHP}`);
        char.hpCurrent = calculatedMaxHP;
        fixes.push(`HP atual definido como ${calculatedMaxHP}`);
        needsSave = true;
    }
    
    if (typeof char.detCurrent !== 'number' || isNaN(char.detCurrent)) {
        console.warn(`‚ö†Ô∏è detCurrent ausente/inv√°lido, calculando: ${calculatedMaxDET}`);
        char.detCurrent = calculatedMaxDET;
        fixes.push(`Determina√ß√£o atual definida como ${calculatedMaxDET}`);
        needsSave = true;
    }
    
    if (typeof char.sanCurrent !== 'number' || isNaN(char.sanCurrent)) {
        console.warn(`‚ö†Ô∏è sanCurrent ausente/inv√°lido, calculando: ${calculatedMaxSAN}`);
        char.sanCurrent = calculatedMaxSAN;
        fixes.push(`Sanidade atual definida como ${calculatedMaxSAN}`);
        needsSave = true;
    }
    
    // Ajustar valores se excederem m√°ximos
    if (char.hpCurrent > calculatedMaxHP) {
        char.hpCurrent = calculatedMaxHP;
        fixes.push(`HP ajustado para m√°ximo (${calculatedMaxHP})`);
        needsSave = true;
    }
    
    if (char.detCurrent > calculatedMaxDET) {
        char.detCurrent = calculatedMaxDET;
        fixes.push(`DET ajustada para m√°ximo (${calculatedMaxDET})`);
        needsSave = true;
    }
    
    if (char.sanCurrent > calculatedMaxSAN) {
        char.sanCurrent = calculatedMaxSAN;
        fixes.push(`SAN ajustada para m√°ximo (${calculatedMaxSAN})`);
        needsSave = true;
    }
    
    // 5. Verificar containers
    if (!Array.isArray(char.containers) || char.containers.length === 0) {
        console.warn('‚ö†Ô∏è Containers ausentes, criando mochila padr√£o');
        char.containers = [{
            id: Date.now(),
            name: 'Mochila',
            maxCapacity: 6,
            items: []
        }];
        fixes.push('Mochila padr√£o criada');
        needsSave = true;
    }
    
    // 6. Verificar imagem do personagem
    if (char.characterImage && typeof char.characterImage !== 'string') {
        console.warn('‚ö†Ô∏è characterImage inv√°lida, removendo');
        delete char.characterImage;
        fixes.push('Imagem inv√°lida removida');
        needsSave = true;
    }
    
    // RELAT√ìRIO
    console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('%cüìä RELAT√ìRIO DE CORRE√á√ÉO', 'color: #10b981; font-weight: bold');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    if (needsSave) {
        console.log(`%c‚úÖ ${fixes.length} corre√ß√µes aplicadas:`, 'color: #10b981; font-weight: bold');
        fixes.forEach((fix, i) => {
            console.log(`   ${i + 1}. ${fix}`);
        });
        
        console.log('\nüíæ Salvando no Firebase...');
        
        // Tentar salvar
        if (typeof window.saveToFirebase === 'function') {
            try {
                window.saveToFirebase();
                
                console.log('\n%c‚úÖ CORRE√á√ÉO CONCLU√çDA COM SUCESSO!', 'color: #10b981; font-size: 14px; font-weight: bold');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('\nüìã Dados corrigidos:');
                console.log('   Nome:', char.nome);
                console.log('   N√≠vel:', Math.floor(char.exp / 10) || 0);
                console.log('   EXP:', char.exp);
                console.log('   HP:', char.hpCurrent + '/' + calculatedMaxHP);
                console.log('   DET:', char.detCurrent + '/' + calculatedMaxDET);
                console.log('   SAN:', char.sanCurrent + '/' + calculatedMaxSAN);
                console.log('\nüîÑ Recarregando p√°gina em 3 segundos...\n');
                
                setTimeout(() => {
                    location.reload();
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar no Firebase:', error);
                console.log('\n‚ö†Ô∏è Tente recarregar manualmente (F5)');
            }
        } else {
            console.error('‚ùå Fun√ß√£o saveToFirebase n√£o encontrada!');
            console.log('‚ö†Ô∏è As corre√ß√µes foram aplicadas na mem√≥ria, mas n√£o puderam ser salvas.');
            console.log('üí° Tente recarregar a p√°gina e executar este script novamente.');
        }
        
    } else {
        console.log('%c‚úÖ Personagem j√° est√° correto!', 'color: #10b981; font-weight: bold');
        console.log('Nenhuma corre√ß√£o necess√°ria.\n');
        console.log('Se ainda estiver com erro, verifique:');
        console.log('1. Se aplicou a corre√ß√£o do updateAllCalculations()');
        console.log('2. Se limpou o cache do navegador');
        console.log('3. Se est√° testando em aba an√¥nima');
    }
    
    console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   
   AP√ìS EXECUTAR ESTE SCRIPT:
   
   1. Aguarde a mensagem de sucesso
   2. P√°gina vai recarregar automaticamente
   3. Ficha do Alan Biltrox deve funcionar perfeitamente! ‚úÖ
   
   SE AINDA TIVER ERRO:
   
   1. Certifique-se de ter aplicado a corre√ß√£o em updateAllCalculations()
      (veja arquivo CORRECAO_DEFINITIVA.js ou CORRECAO_PERSONAGENS_ANTIGOS.js)
   
   2. Limpe o cache: Ctrl+Shift+Delete
   
   3. Teste em aba an√¥nima: Ctrl+Shift+N
   
   4. Execute o TESTE_CONSOLE.js para diagn√≥stico completo
   
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */