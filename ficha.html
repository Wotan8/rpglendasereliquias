<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lendas e Rel√≠quias - Ficha Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #8b5cf6;
            --secondary: #ec4899;
            --dark: #1e1b4b;
            --darker: #0f172a;
            --light: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 30px;
            border: 2px solid var(--primary);
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: calc(100vw - 40px);
            flex-wrap: wrap;
        }

        .user-email {
            color: #cbd5e1;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .btn-logout {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-logout:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-logout:active {
            transform: scale(0.95);
        }

        @media (max-width: 639px) {
            .user-info {
                top: 5px;
                right: 5px;
                padding: 8px 12px;
                font-size: 0.75rem;
                gap: 8px;
            }

            .user-email {
                font-size: 0.7rem;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 70px;
            background: rgba(30, 27, 75, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        h1 {
            text-align: center;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 20px;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            padding: 0 10px;
        }

        .autosave-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-menu {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-menu:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-menu:active {
            transform: scale(0.95);
        }

        @media (max-width: 639px) {
            .btn-menu {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }
        .autosave-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .autosave-indicator.saving {
            background: rgba(245, 158, 11, 0.9);
        }

        .autosave-indicator.error {
            background: rgba(239, 68, 68, 0.9);
        }

        @media (max-width: 639px) {
            .autosave-indicator {
                top: 60px;
                left: 10px;
                font-size: 0.7rem;
                padding: 6px 12px;
            }

            .container {
                margin-top: 80px;
            }
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scroll-behavior: smooth;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .tab {
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: fit-content;
            touch-action: manipulation;
        }

        .tab:active {
            transform: scale(0.95);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: clamp(1.1rem, 4vw, 1.3rem);
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 2px;
            flex-shrink: 0;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        .grid-4 { grid-template-columns: 1fr; }

        @media (min-width: 640px) {
            .grid-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1024px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .container { padding: 30px; }
            .section { padding: 20px; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            color: #cbd5e1;
        }

        input, select, textarea {
            padding: 14px 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--light);
            font-size: clamp(0.95rem, 3vw, 1rem);
            transition: all 0.3s;
            touch-action: manipulation;
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }

        .attribute-group {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .attribute-header {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attribute-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            gap: 10px;
        }

        .attribute-item:last-child {
            border-bottom: none;
        }

        .attribute-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
        }

        .attribute-code {
            color: #94a3b8;
            font-size: clamp(0.75rem, 2.2vw, 0.85rem);
            margin-left: 4px;
        }

        .dots {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: nowrap;
        }

        .dot {
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        .dot:active {
            transform: scale(1.15);
        }

        .dot.filled {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
        }

        .skill-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 0.3s;
            gap: 8px;
        }

        .skill-item:active {
            background: rgba(139, 92, 246, 0.1);
        }

        .skill-item.inapto {
            opacity: 0.5;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .skill-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
            min-width: 0;
        }

        .skill-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.85rem, 2.5vw, 0.95rem);
            line-height: 1.3;
        }

        .skill-attrs {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: #64748b;
            line-height: 1.2;
        }

        .skill-input {
            width: 100%;
            padding: 10px 12px;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            margin-top: 0;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--light);
        }

        .skill-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .penalty {
            color: var(--danger);
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            font-weight: 600;
        }

        .characteristic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            border: 2px solid var(--primary);
            margin-bottom: 10px;
            gap: 10px;
        }

        .char-label {
            font-weight: 700;
            color: #e2e8f0;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
        }

        .char-formula {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: #64748b;
            margin-top: 4px;
        }

        .char-value {
            font-size: clamp(1.5rem, 5vw, 1.8rem);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            flex-shrink: 0;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.6);
            color: white;
            border: 2px solid var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 10px 14px;
            font-size: clamp(0.8rem, 2.5vw, 0.85rem);
            width: auto;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .button-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .button-group .btn {
                width: auto;
                flex: 1;
                min-width: 150px;
            }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            display: none;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        .exp-tracker {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .exp-value {
            font-size: clamp(2.5rem, 8vw, 3rem);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.7);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-label {
            font-size: clamp(0.75rem, 2.2vw, 0.8rem);
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 900;
            color: var(--primary);
        }

        .hp-bar-container {
            margin: 15px 0;
        }

        .hp-bar {
            width: 100%;
            height: 40px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--border);
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .hp-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hp-controls input {
            width: 80px;
            text-align: center;
            padding: 10px 8px;
        }

        .combat-helper {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .dice-roller {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dice-input {
            width: 80px;
        }

        .roll-result {
            font-size: clamp(1.8rem, 6vw, 2rem);
            font-weight: 900;
            color: var(--danger);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.7);
            min-width: 80px;
            text-align: center;
        }

        .container-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            gap: 10px;
            flex-wrap: wrap;
        }

        .container-name {
            font-weight: 700;
            font-size: clamp(1rem, 3vw, 1.1rem);
            color: var(--primary);
        }

        .container-capacity {
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            color: #94a3b8;
        }

        .container-capacity.overload {
            color: var(--danger);
            font-weight: 700;
        }

        .inventory-item {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 5px;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
        }

        .item-details {
            font-size: clamp(0.75rem, 2.2vw, 0.85rem);
            color: #94a3b8;
            word-wrap: break-word;
        }

        .class-ability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            gap: 10px;
        }

        .class-ability-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
            flex: 1;
        }

        .test-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .test-name {
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 8px;
            font-size: clamp(0.95rem, 3vw, 1.05rem);
        }

        .test-formula {
            font-size: clamp(0.8rem, 2.3vw, 0.85rem);
            color: #94a3b8;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }

        .test-result {
            font-size: clamp(1.2rem, 4vw, 1.4rem);
            font-weight: 900;
            color: var(--warning);
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
        }

        .resource-tracker {
            background: rgba(139, 92, 246, 0.15);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resource-header {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: clamp(1rem, 3vw, 1.1rem);
        }

        .resource-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .resource-value {
            font-size: clamp(1.8rem, 6vw, 2.2rem);
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }

        .info-box {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: clamp(0.8rem, 2.3vw, 0.85rem);
            color: #cbd5e1;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--warning);
        }

        @media (max-width: 639px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                border-radius: 12px;
            }

            h1 {
                margin-bottom: 5px;
            }

            .subtitle {
                margin-bottom: 15px;
            }

            .tabs {
                gap: 4px;
                padding-bottom: 6px;
                margin-bottom: 15px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .section {
                padding: 10px;
                margin-bottom: 10px;
            }

            .section-title {
                margin-bottom: 10px;
                font-size: 1rem;
            }

            .attribute-group {
                padding: 8px;
            }

            .attribute-header {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .attribute-item {
                padding: 8px 0;
            }

            .dots {
                gap: 3px;
            }

            .dot {
                width: 26px;
                height: 26px;
                min-width: 26px;
                min-height: 26px;
                border-width: 2px;
            }

            .skill-item {
                padding: 8px;
                gap: 6px;
            }

            .skill-header {
                gap: 6px;
            }

            .skill-name {
                font-size: 0.85rem;
            }

            .skill-attrs {
                font-size: 0.7rem;
            }

            .hp-controls {
                gap: 6px;
            }

            .hp-controls input {
                width: 70px;
                padding: 8px 6px;
            }

            .hp-controls .btn-small {
                padding: 8px 10px;
                font-size: 0.75rem;
            }

            .button-group {
                padding-bottom: 20px;
            }

            textarea {
                min-height: 250px;
                font-size: 0.9rem;
            }
        }

        @media (min-width: 640px) and (max-width: 1023px) {
            .skill-header {
                flex-direction: row;
            }

            .dots {
                gap: 5px;
            }

            .dot {
                width: 30px;
                height: 30px;
                min-width: 30px;
                min-height: 30px;
            }
        }

        @media (min-width: 1024px) {
            .skill-item {
                flex-direction: row;
                align-items: center;
                padding: 12px;
            }

            .skill-header {
                flex: 1;
            }

            .skill-input {
                margin-top: 0;
            }

            .dot {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
                border-width: 3px;
            }

            .dots {
                gap: 6px;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        @media (min-width: 640px) {
            .container {
                background: rgba(30, 27, 75, 0.98);
            }

            .section {
                background: rgba(15, 23, 42, 0.8);
            }
        }

        /* ESTILOS PARA UPLOAD DE IMAGEM */
        .character-image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .character-image-preview {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .character-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-image-placeholder {
            font-size: 5rem;
            color: var(--primary);
            opacity: 0.3;
        }

        .image-upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .image-upload-label:active {
            transform: translateY(0);
        }

        #characterImageInput {
            display: none;
        }

        .btn-remove-image {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 2px solid var(--danger);
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-remove-image:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.05);
        }

    </style>
</head>
<body>
    <!-- TELA DE CARREGAMENTO -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">‚öîÔ∏è Carregando Ficha...</div>
    </div>

    <!-- INFORMA√á√ïES DO USU√ÅRIO -->
    <div class="user-info" id="userInfo" style="display: none;">
        <span class="user-email" id="userEmail">Carregando...</span>
        <button class="btn-menu" onclick="voltarMenu()">üìã MENU</button>
        <button class="btn-logout" onclick="logout()">üö™ SAIR</button>
    </div>

    <div class="autosave-indicator" id="autosaveIndicator">üíæ Salvando na nuvem...</div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>‚öîÔ∏è LENDAS E REL√çQUIAS ‚öîÔ∏è</h1>
        <p class="subtitle">Sistema de Ficha Digital com Firebase - Auto-Save na Nuvem ‚òÅÔ∏è</p>

        <div class="alert alert-success" id="alertSuccess"></div>
        <div class="alert alert-danger" id="alertError"></div>

        <div class="tabs" id="tabContainer">
            <button class="tab active" onclick="switchTab('basico')">üìã B√°sico</button>
            <button class="tab" onclick="switchTab('atributos')">üí™ Atributos</button>
            <button class="tab" onclick="switchTab('habilidades')">üéØ Habilidades</button>
            <button class="tab" onclick="switchTab('caracteristicas')">üìä Caracter√≠sticas</button>
            <button class="tab" onclick="switchTab('classe')">‚≠ê Classe</button>
            <button class="tab" onclick="switchTab('combate')">‚öîÔ∏è Combate</button>
            <button class="tab" onclick="switchTab('inventario')">üéí Invent√°rio</button>
            <button class="tab" onclick="switchTab('aliados')">üë• Aliados</button>
            <button class="tab" onclick="switchTab('propriedades')">üè† Propriedades</button>
            <button class="tab" onclick="switchTab('notas')">üìù Notas</button>
        </div>

        <!-- ABA B√ÅSICO -->
        <div id="basico" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Imagem do Personagem</h2>
                <div class="character-image-section">
                    <div class="character-image-preview" id="characterImagePreview">
                        <div class="character-image-placeholder">üé≠</div>
                    </div>
                    <label for="characterImageInput" class="image-upload-label">
                        üì∑ Escolher Imagem
                    </label>
                    <input type="file" id="characterImageInput" accept="image/*">
                    <button class="btn-remove-image" id="removeImageBtn" style="display: none;" onclick="removeCharacterImage()">
                        üóëÔ∏è Remover Imagem
                    </button>
                    <p style="color: #94a3b8; font-size: 0.85rem; text-align: center;">
                        Formatos aceitos: JPG, PNG, GIF, WebP (m√°x. 2MB)
                    </p>
                </div>
                <h2 class="section-title">Informa√ß√µes B√°sicas</h2>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Nome do Personagem</label>
                        <input type="text" id="nome" placeholder="Digite o nome...">
                    </div>
                    <div class="form-group">
                        <label>Jogador</label>
                        <input type="text" id="jogador" placeholder="Seu nome...">
                    </div>
                    <div class="form-group">
                        <label>Idade</label>
                        <input type="number" id="idade" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Ra√ßa</label>
                        <select id="raca">
                            <option value="">Selecione...</option>
                            <option value="Humano">Humano</option>
                            <option value="Elorin">Elorin</option>
                            <option value="Karu-Selvagem">Karu-Selvagem</option>
                            <option value="Picxi">Picxi</option>
                            <option value="Yotun">Yotun</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Classe</label>
                        <select id="classe">
                            <option value="">Selecione...</option>
                            <option value="Ca√ßador">Ca√ßador</option>
                            <option value="Druida">Druida</option>
                            <option value="Guerreiro">Guerreiro</option>
                            <option value="Adepto">Adepto (Necromante)</option>
                            <option value="Ladino">Ladino</option>
                            <option value="Pallacerdote">Pallacerdote</option>
                            <option value="Ritualista">Ritualista (Abismancia)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Virtude</label>
                        <select id="virtude">
                            <option value="">Selecione...</option>
                            <option value="Caridade">Caridade</option>
                            <option value="Esperan√ßa">Esperan√ßa</option>
                            <option value="F√©">F√©</option>
                            <option value="Fortaleza">Fortaleza</option>
                            <option value="Justi√ßa">Justi√ßa</option>
                            <option value="Prud√™ncia">Prud√™ncia</option>
                            <option value="Temperan√ßa">Temperan√ßa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>V√≠cio</label>
                        <select id="vicio">
                            <option value="">Selecione...</option>
                            <option value="Avareza">Avareza</option>
                            <option value="Gula">Gula</option>
                            <option value="Inveja">Inveja</option>
                            <option value="Ira">Ira</option>
                            <option value="Lux√∫ria">Lux√∫ria</option>
                            <option value="Orgulho">Orgulho</option>
                            <option value="Pregui√ßa">Pregui√ßa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Aura de Imortalidade (AI)</label>
                        <input type="number" id="auraImortalidade" value="1" min="0" max="10" inputmode="numeric">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Caracter√≠sticas Raciais</h2>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Tamanho</label>
                        <input type="number" id="tamanho" value="5" min="1" max="15" inputmode="numeric">
                    </div>

                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h2 class="section-title">‚≠ê Experi√™ncia (EXP)</h2>
                <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">PONTOS DE EXP DISPON√çVEIS</div>
                    <div style="font-size: 3rem; font-weight: 900; color: #f59e0b; text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);" id="exp-display">0</div>
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 8px;">XP</div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(245, 158, 11, 0.3);">
                        <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1rem;">üí° Custos de Evolu√ß√£o</h3>
                        <ul style="color: #cbd5e1; line-height: 1.8; font-size: 0.85rem; text-align: left; list-style: none; padding: 0;">
                            <li>‚ö° <strong>Atributos:</strong> (n√≠vel + 1) √ó 5 EXP</li>
                            <li>üéØ <strong>Habilidades:</strong> (n√≠vel + 1) √ó 4 EXP</li>
                            <li>‚≠ê <strong>Hab. Classe:</strong> (n√≠vel + 1) √ó 2 EXP</li>
                            <li>‚ú® <strong>Hab. Pallacerdote/Ritualista:</strong> (n√≠vel + 1) √ó 4 EXP</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA ATRIBUTOS -->
        <div id="atributos" class="tab-content">
            <div class="section">
                <h2 class="section-title">Atributos do Personagem</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Toque nas bolinhas para preencher/esvaziar.</p>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;"></th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">‚ö° Poder</th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">üéØ Refinamento</th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">üõ°Ô∏è Resist√™ncia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üß† Mental</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Intelig√™ncia</span><br>
                                            <span class="attribute-code">[INT]</span>
                                        </div>
                                        <div class="dots" id="dots-int" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Racioc√≠nio</span><br>
                                            <span class="attribute-code">[RAC]</span>
                                        </div>
                                        <div class="dots" id="dots-rac" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Perseveran√ßa</span><br>
                                            <span class="attribute-code">[PRS]</span>
                                        </div>
                                        <div class="dots" id="dots-prs" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üí™ F√≠sico</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">For√ßa</span><br>
                                            <span class="attribute-code">[FOR]</span>
                                        </div>
                                        <div class="dots" id="dots-for" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Destreza</span><br>
                                            <span class="attribute-code">[DES]</span>
                                        </div>
                                        <div class="dots" id="dots-des" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Vigor</span><br>
                                            <span class="attribute-code">[VIG]</span>
                                        </div>
                                        <div class="dots" id="dots-vig" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üí¨ Social</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Presen√ßa</span><br>
                                            <span class="attribute-code">[PRE]</span>
                                        </div>
                                        <div class="dots" id="dots-pre" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Manipula√ß√£o</span><br>
                                            <span class="attribute-code">[MAN]</span>
                                        </div>
                                        <div class="dots" id="dots-man" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Autocontrole</span><br>
                                            <span class="attribute-code">[AUT]</span>
                                        </div>
                                        <div class="dots" id="dots-aut" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA HABILIDADES -->
        <div id="habilidades" class="tab-content">
            <div class="section">
                <h2 class="section-title">Habilidades</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Cada habilidade tem 5 n√≠veis. Toque nas bolinhas.</p>

                <div class="grid grid-3">
                    <div class="attribute-group">
                        <div class="attribute-header">üß† Mental <span class="penalty">(-3 se inapto)</span></div>
                        <div id="skills-mental"></div>
                    </div>

                    <div class="attribute-group">
                        <div class="attribute-header">üí™ F√≠sico <span class="penalty">(-1 se inapto)</span></div>
                        <div id="skills-fisico"></div>
                    </div>

                    <div class="attribute-group">
                        <div class="attribute-header">üí¨ Social <span class="penalty">(-1 se inapto)</span></div>
                        <div id="skills-social"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA CARACTER√çSTICAS -->
        <div id="caracteristicas" class="tab-content">
            <div class="section">
                <h2 class="section-title">Caracter√≠sticas</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Calculadas automaticamente.</p>

                <div class="grid grid-2">
                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Iniciativa</div>
                            <div class="char-formula">RAC+DES+AUT+Agil-Tam</div>
                        </div>
                        <div class="char-value" id="calc-iniciativa">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Rea√ß√£o</div>
                            <div class="char-formula">Min(DES,RAC)+Agil</div>
                        </div>
                        <div class="char-value" id="calc-reacao">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Desloc. Terrestre</div>
                            <div class="char-formula">FOR+DES+Tam+Agil</div>
                        </div>
                        <div class="char-value" id="calc-deslocamento">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">VIT Max</div>
                            <div class="char-formula">VIG+Tamanho</div>
                        </div>
                        <div class="char-value" id="calc-vitalidade-max">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">DET Max</div>
                            <div class="char-formula">PRS+AUT</div>
                        </div>
                        <div class="char-value" id="calc-determinacao-max">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Carga Max</div>
                            <div class="char-formula">FOR+VIG</div>
                        </div>
                        <div class="char-value" id="calc-carga">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Sanidade Atual</div>
                            <div class="char-formula">Edit√°vel na aba Combate</div>
                        </div>
                        <div class="char-value" id="calc-sanidade">80</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Blindagem</div>
                            <div class="char-formula">Armadura</div>
                        </div>
                        <div class="char-value" id="calc-blindagem">0</div>
                    </div>
                    <div class="characteristic-item" style="grid-column: 1 / -1; border: 3px solid var(--warning); background: rgba(245, 158, 11, 0.1);">
                        <div>
                            <div class="char-label" style="font-size: 1.3rem; color: var(--warning);">‚ö° Classe de Poder (CP)</div>
                            <div class="char-formula" style="font-size: 0.8rem;">‚åà2¬∑OF + DF + RS + MB‚åâ √ó AI</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                            <div class="char-value" id="calc-cp" style="color: var(--warning);">0</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div id="calc-cp-letra" style="font-size: 1.8rem; font-weight: 900; color: var(--warning);">E</div>
                                <div id="calc-cp-nome" style="font-size: 1rem; font-weight: 700; color: var(--warning); text-transform: uppercase;">CIVIL/NOVATO</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA CLASSE -->
        <div id="classe" class="tab-content">          
            <div id="class-content"></div>
        </div>

        <!-- ABA COMBATE -->
        <div id="combate" class="tab-content">
            <div class="section">
                <h2 class="section-title">Status de Combate</h2>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">‚ù§Ô∏è Vitalidade</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="hp-fill" style="width: 100%;">
                            <span id="hp-text">5 / 5</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustHP(-1)">-1</button>
                        <button class="btn btn-secondary btn-small" onclick="adjustHP(-5)">-5</button>
                        <input type="number" id="hp-current" value="5" onchange="updateHPBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustHP(1)">+1</button>
                        <button class="btn btn-primary btn-small" onclick="adjustHP(5)">+5</button>
                        <button class="btn btn-secondary btn-small" onclick="resetHP()">Max</button>
                    </div>
                </div>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">‚ö° Determina√ß√£o</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="det-fill" style="width: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));">
                            <span id="det-text">3 / 3</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustDET(-1)">-1</button>
                        <input type="number" id="det-current" value="3" onchange="updateDETBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustDET(1)">+1</button>
                        <button class="btn btn-secondary btn-small" onclick="resetDET()">Max</button>
                    </div>
                </div>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">üß† Sanidade</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="san-fill" style="width: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6);">
                            <span id="san-text">100 / 100</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustSAN(-1)">-1</button>
                        <button class="btn btn-secondary btn-small" onclick="adjustSAN(-5)">-5</button>
                        <input type="number" id="san-current" onchange="updateSANBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustSAN(1)">+1</button>
                        <button class="btn btn-primary btn-small" onclick="adjustSAN(5)">+5</button>
                        <button class="btn btn-secondary btn-small" onclick="resetSAN()">Max</button>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h2 class="section-title">‚ö†Ô∏è Condi√ß√µes</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Adicione condi√ß√µes que afetam seu personagem (Ex: Fadiga, Fratura, Envenenado, etc.)
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addCondition()">‚ûï Adicionar Condi√ß√£o</button>
                </div>

                <div id="conditions-list"></div>
            </div>

            <!-- Bloco de Gra√ßa de Palla (apenas para Pallacerdote) -->
            <div class="section" id="graca-section" style="display: none; margin-top: 20px;">
                <h2 class="section-title" style="background: linear-gradient(135deg, #fbbf24, #fde047); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    üíé Gra√ßa de Palla
                </h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Ajuste sua Gra√ßa atual durante o combate. M√°ximo baseado em PRE + Ess√™ncia.
                </p>
                
                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700; color: #fde047;">üíé Gra√ßa Atual</label>
                    <div class="hp-bar" style="border: 2px solid #fbbf24;">
                        <div class="hp-fill" id="graca-combate-fill" style="width: 0%; background: linear-gradient(90deg, #fbbf24, #fde047);">
                            <span id="graca-combate-text" style="color: #1e1b4b; font-weight: 700;">0 / 0</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <input type="number" id="graca-current" value="0" onchange="updateGracaBar()" inputmode="numeric" 
                            style="background: rgba(251, 191, 36, 0.2); border: 2px solid #fbbf24; color: #fde047;">
                    </div>
                </div>
            </div>

            <!-- Bloco de Fantoches (apenas para Adepto) -->
            <div class="section" id="fantoches-section" style="display: none; margin-top: 20px;">
                <h2 class="section-title">üßü Fantoches</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Controle seus fantoches ativos durante o combate. M√°ximo baseado em INT + Lideran√ßa + Servos.
                </p>
                
                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">üßü Fantoches Ativos</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="fantoches-fill" style="width: 0%; background: linear-gradient(90deg, #800080, #a020f0);">
                            <span id="fantoches-text">0 / 0</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustFantoches(-1)">-1</button>
                        <button class="btn btn-secondary btn-small" onclick="adjustFantoches(-5)">-5</button>
                        <input type="number" id="fantoches-current" value="0" onchange="updateFantochesBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustFantoches(1)">+1</button>
                        <button class="btn btn-primary btn-small" onclick="adjustFantoches(5)">+5</button>
                        <button class="btn btn-secondary btn-small" onclick="resetFantoches()">Max</button>
                    </div>
                </div>
            </div>

            <div class="section" id="alliesCombatSection" style="display: none; margin-top: 20px;">
                <h2 class="section-title">üë• Status dos Aliados</h2>
                <div id="allies-combat-list"></div>
            </div>

            <div class="combat-helper">
                <h3 style="color: var(--danger); margin-bottom: 12px; font-size: 1.1rem;">üé≤ Rolador de Dados</h3>
                <p style="color: #94a3b8; margin-bottom: 12px; font-size: 0.85rem;">Sucessos: 8, 9, 10. Falha: 1.</p>
                <div class="dice-roller">
                    <div class="form-group" style="width: auto;">
                        <label>Dados</label>
                        <input type="number" id="dice-count" class="dice-input" value="1" min="1" max="20" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-small" onclick="rollDice()" style="flex: 1;">üé≤ ROLAR</button>
                    <div class="roll-result" id="roll-result">‚Äî</div>
                </div>
                <div id="roll-details" style="margin-top: 12px; color: #94a3b8; font-size: 0.85rem;"></div>
            </div>
        </div>

        <!-- ABA INVENT√ÅRIO -->
        <div id="inventario" class="tab-content">
            <div class="section">
                <h2 class="section-title">üí∞ LUNS (DINHEIRO)</h2>
                
                <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">RIQUEZA TOTAL</div>
                        <div style="font-size: 2.5rem; font-weight: 900; color: #f59e0b; text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);" id="luns-display">0</div>
                        <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">Luns</div>
                    </div>
                    
                    <div style="border-top: 1px solid rgba(245, 158, 11, 0.3); padding-top: 15px; margin-top: 15px;">
                        <p style="color: #cbd5e1; font-size: 0.85rem; text-align: center; font-style: italic;">
                            üí° Sua riqueza √© calculada automaticamente baseada nos itens tipo "Lunis" em seu invent√°rio.
                        </p>
                    </div>
                </div>
                
                <!-- Campo oculto para manter compatibilidade -->
                <input type="number" id="luns" value="0" min="0" style="display: none;">
            </div>

            <div class="section">
                <h2 class="section-title">Sistema de Invent√°rio</h2>
                <div id="containers-list"></div>
            </div>

            <!-- Modal para Criar/Editar Item -->
            <div id="itemModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
                <div style="max-width: 600px; margin: 20px auto; background: var(--dark); border-radius: 16px; padding: 20px; border: 2px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--primary); margin: 0;" id="modalTitle">Criar Item</h2>
                        <button onclick="closeItemModal()" style="background: var(--danger); color: white; border: none; border-radius: 8px; padding: 8px 16px; cursor: pointer; font-weight: 700;">‚úñ Fechar</button>
                    </div>
                    
                    <form id="itemForm" onsubmit="return false;">
                        <!-- Campos B√°sicos -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Imagem do Item</label>
                            <input type="file" id="itemImagem" accept="image/*" onchange="previewItemImage()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            <div id="itemImagePreview" style="margin-top: 10px; text-align: center;"></div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Nome do Item*</label>
                            <input type="text" id="itemName" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Descri√ß√£o</label>
                            <textarea id="itemDescription" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);"></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Dureza (0-10)*</label>
                                <input type="number" id="itemDureza" min="0" max="10" value="0" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            </div>
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tamanho do Item (1-10)*</label>
                                <input type="number" id="itemTamanho" min="1" max="10" value="1" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Refor√ßo*</label>
                                <input type="number" id="itemReforco" min="0" value="0" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            </div>
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Integridade*</label>
                                <div style="display: flex; gap: 5px;">
                                    <input type="number" id="itemIntegridade" min="0" value="10" required style="flex: 1; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                    <button type="button" onclick="repairItem()" title="Reparar Item" style="background: var(--success); color: white; border: none; border-radius: 8px; padding: 0 12px; cursor: pointer; font-size: 1.2rem;">üîß</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Peso Unit√°rio*</label>
                                <input type="number" id="itemPeso" min="0" step="0.1" value="1" required oninput="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            </div>
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Peso Total</label>
                                <input type="text" id="itemPesoTotal" readonly value="1.00" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.5); color: #94a3b8;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tipo de Item*</label>
                            <select id="itemTipo" onchange="updateItemTypeFields()" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                <option value="">Selecione um tipo...</option>
                                <option value="Arma">Arma</option>
                                <option value="Vestimenta">Vestimenta</option>
                                <option value="Proj√©til">Proj√©til</option>
                                <option value="Objeto">Objeto</option>
                                <option value="Container">Container</option>
                                <option value="Lunis">Lunis</option>
                            </select>
                        </div>
                        
                        <!-- Campos Condicionais -->
                        <div id="conditionalFields"></div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" onclick="saveItem()" style="flex: 1; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; padding: 12px; cursor: pointer; font-weight: 700; font-size: 1rem;">üíæ Salvar Item</button>
                            <button type="button" onclick="closeItemModal()" style="background: var(--danger); color: white; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer; font-weight: 700;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ABA ALIADOS -->
        <div id="aliados" class="tab-content">
            <div class="section">
                <h2 class="section-title">üë• Aliados</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Gerencie seus aliados, companheiros e montarias. Clique em um aliado para editar sua ficha completa.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addAlly()">‚ûï Adicionar Aliado</button>
                </div>

                <div id="allies-list"></div>
            </div>
        </div>

        <!-- ABA PROPRIEDADES -->
        <div id="propriedades" class="tab-content">
            <div class="section">
                <h2 class="section-title">üè† Propriedades</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Gerencie suas propriedades, im√≥veis, estabelecimentos e ve√≠culos. Clique em uma propriedade para editar seus detalhes completos.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addProperty()">‚ûï Adicionar Propriedade</button>
                </div>

                <div id="properties-list"></div>
            </div>
        </div>

        <!-- ABA NOTAS -->
        <div id="notas" class="tab-content">
            <div class="section">
                <h2 class="section-title">Notas do Personagem</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Escreva suas anota√ß√µes, hist√≥rias, objetivos ou qualquer informa√ß√£o importante sobre seu personagem.
                    Suas notas s√£o salvas automaticamente na nuvem e exportadas junto com a ficha.
                </p>
                
                <div class="form-group">
                    <textarea id="notas-textarea" placeholder="Digite suas notas aqui...

Exemplos:
- Background do personagem
- Objetivos e miss√µes
- NPCs importantes
- Itens especiais
- Estrat√©gias de combate
- Anota√ß√µes da sess√£o"></textarea>
                </div>
            </div>
        </div>

        </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        // ============= CONFIGURA√á√ÉO FIREBASE =============
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, getDocs, deleteDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA6r79XcsMr3KZUT1YZ8vQntIGspgULXcE",
          authDomain: "rpg-lendasereliquias.firebaseapp.com",
          projectId: "rpg-lendasereliquias",
          storageBucket: "rpg-lendasereliquias.firebasestorage.app",
          messagingSenderId: "546994339773",
          appId: "1:546994339773:web:0116cf7c8667f113075cd4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.db = db;

        window.currentUser = null;
        window.currentCharacterId = null;
        let currentUser = null;
        let currentCharacterId = null;
        let previousCharacterState = null;
        let isEnsuringingEquipados = false;

        /**
         * Garante que o documento do personagem tenha o ownerUid definido para o usu√°rio atual.
         * Sempre utiliza merge para evitar sobrescrever campos existentes.
         * @param {import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').DocumentReference} characterRef
         */
        async function ensureOwnerUid(characterRef) {
            const user = auth.currentUser;
            if (!user) {
                throw new Error('N√£o autenticado.');
            }

            const snap = await getDoc(characterRef);
            if (!snap.exists()) {
                await setDoc(characterRef, { ownerUid: user.uid }, { merge: true });
                return;
            }

            const data = snap.data() || {};
            if (!data.ownerUid) {
                await setDoc(characterRef, { ownerUid: user.uid }, { merge: true });
            }
        }

        /**
         * Garante que o container Equipados existe
         */
        async function ensureEquipadosContainer(characterId) {
            // Prevenir chamadas simult√¢neas
            if (isEnsuringingEquipados) {
                console.log('‚è≥ J√° est√° criando/verificando Equipados...');
                return;
            }
            
            try {
                isEnsuringingEquipados = true;
                
                if (!currentUser) {
                    console.error('‚ùå Usu√°rio n√£o autenticado');
                    return;
                }
                
                const char = getChar();
                const containers = await loadContainersFromFirebase(characterId);
                
                // Verificar se j√° existe Equipados (por nome, n√£o apenas na mem√≥ria)
                let equipados = containers.find(c => c.name === 'Equipados');
                
                if (!equipados) {
                    // Criar container Equipados
                    const atletismo = char.skills['atletismo'] || 1;
                    const vig = char.vig || 1;
                    const forca = char.for || 1;
                    
                    const maxSize = forca * vig * atletismo;
                    
                    equipados = {
                        id: 'equipados-' + Date.now(),
                        name: 'Equipados',
                        ownerId: currentUser.uid,
                        characterId: characterId,
                        maxCapacity: forca + vig,
                        maxSize: maxSize,
                        itemIds: []
                    };
                    
                    await saveContainerToFirebase(equipados);
                    console.log(`‚úÖ Container Equipados criado com maxSize: ${maxSize} (${forca} √ó ${vig}${atletismo > 0 ? ` √ó ${atletismo}` : ''})`);
                } else {
                    console.log('‚úÖ Container Equipados j√° existe');
                }
                
                // Recarregar invent√°rio
                await loadInventoryFromFirebase(characterId);
            } catch (error) {
                console.error('Erro ao garantir container Equipados:', error);
            } finally {
                isEnsuringingEquipados = false;
            }
        }

        // ============= CARREGAR DO FIREBASE =============
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const characterId = urlParams.get('id') || currentUser.uid;
                currentCharacterId = characterId;
                window.currentCharacterId = characterId;
                const userDoc = doc(db, 'characters', characterId);
                const docSnap = await getDoc(userDoc);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('‚úÖ Ficha carregada do Firebase:', data);
                    
                    delete data.lastUpdate;
                    delete data.userEmail;
                    delete data.containers; // N√£o usar containers do documento antigo
                    
                    window.character = {
                        ...window.character,
                        ...data,
                        allies: data.allies || [],
                        properties: data.properties || []
                    };
                    
                    // Carregar containers e itens das cole√ß√µes
                    await loadInventoryFromFirebase(characterId);
                    
                    // ‚úÖ GARANTIR que container Equipados existe (importante para personagens antigos)
                    if (!window.character.containers || !window.character.containers.find(c => c.name === 'Equipados')) {
                        console.log('‚ö†Ô∏è Container Equipados n√£o encontrado. Criando automaticamente...');
                        await ensureEquipadosContainer(characterId);
                        // Recarregar invent√°rio ap√≥s criar Equipados
                        await loadInventoryFromFirebase(characterId);
                    }
                    
                    previousCharacterState = JSON.parse(JSON.stringify(window.character));
                    showAlert('‚úÖ Ficha carregada da nuvem!', 'success');
                } else {
                    console.log('üìù Primeira vez! Criando ficha nova...');
                    
                    // Criar container Equipados inicial
                    await ensureEquipadosContainer(characterId);
                    
                    previousCharacterState = JSON.parse(JSON.stringify(window.character));
                    showAlert('üìù Bem-vindo! Crie seu personagem.', 'success');
                }
            } catch (error) {
                console.error('Erro ao carregar ficha:', error);
                showAlert('‚ö†Ô∏è Erro ao carregar ficha. Usando dados locais.', 'danger');
            }
        }

        // ============= FUN√á√ÉO DE INICIALIZA√á√ÉO =============
        async function init() {
            try {
                console.log('üöÄ Iniciando sistema...');
                
                const attributes = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
                attributes.forEach(attr => createAttributeDots(attr, 5)); // 5 N√çVEIS
                
                createSkills();
            
                const char = getChar();
                
                loadCharacterData();
            
                // Tentar atualizar c√°lculos, mas n√£o travar se falhar
                try {
                    if (window.currentCharacterId && window.currentUser) {
                        updateAllCalculations();
                    } else {
                        console.warn('‚ö†Ô∏è Aguardando inicializa√ß√£o completa antes de updateAllCalculations');
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Erro ao atualizar c√°lculos iniciais (n√£o cr√≠tico):', error);
                }
                
                setupEventListeners();
                setupInputListeners();
                
                updateContainers();
                updateEXPDisplay();
                updateConditions();
                updateLunsDisplay();

                // Update allies and properties (defensivo - aguarda fun√ß√µes estarem dispon√≠veis)
                if (typeof window.updateAlliesList === 'function') {
                    updateAlliesList();
                } else {
                    console.warn('‚ö†Ô∏è updateAlliesList ainda n√£o dispon√≠vel');
                }

                if (typeof window.updatePropertiesList === 'function') {
                    updatePropertiesList();
                } else {
                    console.warn('‚ö†Ô∏è updatePropertiesList ainda n√£o dispon√≠vel');
                }

                if (typeof window.updateAlliesCombat === 'function') {
                    updateAlliesCombat();
                } else {
                    console.warn('‚ö†Ô∏è updateAlliesCombat ainda n√£o dispon√≠vel');
                }
                
                console.log('‚úÖ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO na inicializa√ß√£o:', error);
                alert('Erro ao inicializar ficha. Verifique o console (F12).');
            }
        }

        // ============= VERIFICAR AUTENTICA√á√ÉO =============
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user;
                console.log('‚úÖ Usu√°rio logado:', user.email);
                
                // ADICIONAR ESTAS LINHAS:
                try {
                    // Limpar poss√≠veis dados corrompidos
                    const urlParams = new URLSearchParams(window.location.search);
                    const characterId = urlParams.get('id');
                    
                    if (characterId) {
                        console.log('üîç Tentando carregar personagem:', characterId);
                        
                        // Verificar se o documento existe antes de carregar
                        const testDoc = await getDoc(doc(db, 'characters', characterId));
                        if (!testDoc.exists()) {
                            console.error('‚ùå Personagem n√£o encontrado:', characterId);
                            alert('Personagem n√£o encontrado! Redirecionando...');
                            window.location.href = 'personagens.html';
                            return;
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar personagem:', error);
                    alert('Erro ao carregar personagem. Tente novamente.');
                    window.location.href = 'personagens.html';
                    return;
                }

                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                await loadFromFirebase();
                await init();
            } else {
                console.log('‚ùå Usu√°rio n√£o autenticado. Redirecionando...');
                window.location.href = 'index.html';
            }
        });

        // ============= LOGOUT =============
        window.logout = async function() {
            if (confirm('üö™ Tem certeza que deseja sair?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    showAlert('‚ùå Erro ao sair. Tente novamente.', 'danger');
                }
            }
        };

        // ============= VOLTAR PARA MENU =============
        window.voltarMenu = function() {
            if (confirm('üìã Voltar para o menu de personagens?')) {
                window.location.href = 'personagens.html';
            }
        };

        // ============= SALVAR NO FIREBASE =============
        window.saveToFirebase = async function() {
            if (!currentUser) return;
            
            const indicator = document.getElementById('autosaveIndicator');
            indicator.textContent = 'üíæ Salvando...';
            indicator.classList.add('show', 'saving');
            
            try {
                const char = getChar();
                const characterId = currentCharacterId || currentUser.uid;
                const userDoc = doc(db, 'characters', characterId);

                await ensureOwnerUid(userDoc);

                await setDoc(userDoc, {
                    ...char,
                    ownerUid: currentUser.uid,
                    lastUpdate: new Date().toISOString(),
                    userEmail: currentUser.email
                }, { merge: true });
                
                // ‚úÖ SISTEMA DE DETEC√á√ÉO DE MUDAN√áAS
                if (previousCharacterState) {
                    const changes = detectChanges(previousCharacterState, char);
                    
                    if (changes.length > 0) {
                        try {
                            const logsRef = collection(db, 'logs');
                            
                            // Criar um log para cada mudan√ßa
                            for (const change of changes) {
                                await addDoc(logsRef, {
                                    user: currentUser.email,
                                    action: change,
                                    character: char.nome || 'Personagem sem nome',
                                    type: 'player-update',
                                    timestamp: new Date().toISOString()
                                });
                            }
                            
                            console.log(`‚úÖ ${changes.length} log(s) criado(s) com sucesso`);
                        } catch (logError) {
                            console.error('‚ö†Ô∏è Erro ao criar log (n√£o cr√≠tico):', logError);
                        }
                    }
                }
                
                // Atualizar estado anterior
                previousCharacterState = JSON.parse(JSON.stringify(char));
                
                indicator.textContent = '‚úÖ Salvo na nuvem!';
                indicator.classList.remove('saving', 'error');
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                indicator.textContent = '‚ùå Erro ao salvar!';
                indicator.classList.remove('saving');
                indicator.classList.add('error', 'show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        };

        // ============= FUN√á√ïES DE CONTAINERS NO FIREBASE =============
        /**
         * Busca todos os containers de um personagem
         */
        async function loadContainersFromFirebase(characterId) {
            try {
                const containersRef = collection(db, 'containers');
                const q = query(containersRef, where('characterId', '==', characterId));
                const querySnapshot = await getDocs(q);
                
                const containers = [];
                querySnapshot.forEach((doc) => {
                    containers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Ordenar: Equipados sempre primeiro
                containers.sort((a, b) => {
                    if (a.name === 'Equipados') return -1;
                    if (b.name === 'Equipados') return 1;
                    return 0;
                });
                
                return containers;
            } catch (error) {
                console.error('Erro ao carregar containers:', error);
                return [];
            }
        }

        /**
         * Salva ou atualiza um container no Firebase
         */
        async function saveContainerToFirebase(container) {
            try {
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                const containerRef = doc(db, 'containers', container.id);
                await setDoc(containerRef, {
                    name: container.name,
                    ownerId: currentUser.uid, // ‚úÖ Sempre usar o uid do usu√°rio autenticado
                    characterId: container.characterId || currentCharacterId, // Vincular ao personagem
                    maxCapacity: container.maxCapacity,
                    maxSize: container.maxSize || 0,
                    itemIds: container.itemIds || [],
                    isContainerItem: container.isContainerItem || false,
                    linkedContainerId: container.linkedContainerId || null,
                    // Informa√ß√µes f√≠sicas (se for um Item de Container)
                    description: container.description || '',
                    dureza: container.dureza || 0,
                    tamanho: container.tamanho || 1,
                    integridade: container.integridade || 0,
                    peso: container.peso || 0
                }, { merge: true });
                
                console.log('‚úÖ Container salvo:', container.name);
            } catch (error) {
                console.error('Erro ao salvar container:', error);
                throw error;
            }
        }

        /**
         * Remove um container do Firebase
         */
        async function deleteContainerFromFirebase(containerId) {
            try {
                const containerRef = doc(db, 'containers', containerId);
                await deleteDoc(containerRef);
                console.log('‚úÖ Container removido do Firebase');
            } catch (error) {
                console.error('Erro ao remover container:', error);
                throw error;
            }
        }

        // ============= FUN√á√ïES DE ITENS NO FIREBASE =============

        /**
         * Busca todos os itens de um personagem
         */
        async function loadItemsFromFirebase(characterId) {
            try {
                console.log(`üîç [loadItemsFromFirebase] Iniciando busca com characterId:`, characterId);
                
                const itemsRef = collection(db, 'items');
                const q = query(itemsRef, where('characterId', '==', characterId));
                const querySnapshot = await getDocs(q);
                
                console.log(`üîç [loadItemsFromFirebase] Query executada. Documentos encontrados:`, querySnapshot.size);
                
                const items = [];
                querySnapshot.forEach((doc) => {
                    const itemData = {
                        id: doc.id,
                        ...doc.data()
                    };
                    console.log(`üì¶ [loadItemsFromFirebase] Item encontrado:`, itemData);
                    items.push(itemData);
                });
                
                console.log(`‚úÖ [loadItemsFromFirebase] Total de itens retornados:`, items.length);
                return items;
            } catch (error) {
                console.error('‚ùå [loadItemsFromFirebase] Erro ao carregar itens:', error);
                return [];
            }
        }

        /**
         * Salva ou atualiza um item no Firebase
         */
        async function saveItemToFirebase(item) {
            try {
                if (!currentUser) {
                    throw new Error('Usu√°rio n√£o autenticado');
                }
                
                const itemRef = doc(db, 'items', item.id);
                await setDoc(itemRef, {
                    name: item.name,
                    tipo: item.tipo,
                    tipoLun: item.tipoLun || null,
                    ownerId: currentUser.uid, // ‚úÖ Sempre usar o uid do usu√°rio autenticado
                    characterId: item.characterId || currentCharacterId, // Vincular ao personagem
                    containerId: item.containerId, // 'est√° com algu√©m' para Equipados
                    quantity: item.quantity || 1,
                    description: item.description || '',
                    dureza: item.dureza || 0,
                    tamanho: item.tamanho || 1,
                    reforco: item.reforco || 0,
                    integridade: item.integridade || 0,
                    peso: item.peso || 0,
                    packSize: item.packSize || 1,
                    totalWeight: item.totalWeight || item.peso,
                    imagem: item.imagem || null,
                    isContainerItem: item.isContainerItem || false,
                    linkedContainerId: item.linkedContainerId || null,
                    dano: item.dano || 0, // Arma e Proj√©til
                    reacao: item.reacao || 0, // Arma
                    blindagem: item.blindagem || 0, // Vestimenta
                    maxCapacity: item.maxCapacity || 0, // Container
                    maxSize: item.maxSize || 0 // Container
                }, { merge: true });
                
                console.log('‚úÖ Item salvo:', item.name);
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                throw error;
            }
        }

        /**
         * Remove um item do Firebase
         */
        async function deleteItemFromFirebase(itemId) {
            try {
                const itemRef = doc(db, 'items', itemId);
                await deleteDoc(itemRef);
                console.log('‚úÖ Item removido do Firebase');
            } catch (error) {
                console.error('Erro ao remover item:', error);
                throw error;
            }
        }

        /**
         * Move todos os itens de um container para outro
         */
        async function moveAllItemsToContainer(fromContainerId, toContainerId, characterId) {
            try {
                const itemsRef = collection(db, 'items');
                const q = query(itemsRef, where('characterId', '==', characterId), where('containerId', '==', fromContainerId));
                const querySnapshot = await getDocs(q);
                
                const updates = [];
                querySnapshot.forEach((doc) => {
                    updates.push(updateDoc(doc.ref, { containerId: toContainerId }));
                });
                
                await Promise.all(updates);
                console.log('‚úÖ Itens movidos com sucesso');
            } catch (error) {
                console.error('Erro ao mover itens:', error);
                throw error;
            }
        }

        // ============= DETECTAR MUDAN√áAS =============
        function detectChanges(oldChar, newChar) {
            const changes = [];
            
            // 1. ATRIBUTOS
            const attributes = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
            attributes.forEach(attr => {
                if (oldChar[attr] !== newChar[attr]) {
                    const attrName = attr.toUpperCase();
                    changes.push(`${attrName}: ${oldChar[attr]} ‚Üí ${newChar[attr]}`);
                }
            });
            
            // 2. DADOS B√ÅSICOS
            if (oldChar.nome !== newChar.nome) {
                changes.push(`Mudou nome para "${newChar.nome}"`);
            }
            if (oldChar.classe !== newChar.classe) {
                changes.push(`Mudou classe de "${oldChar.classe}" para "${newChar.classe}"`);
            }
            if (oldChar.raca !== newChar.raca) {
                changes.push(`Mudou ra√ßa de "${oldChar.raca}" para "${newChar.raca}"`);
            }
            if (oldChar.idade !== newChar.idade) {
                changes.push(`Mudou idade: ${oldChar.idade} ‚Üí ${newChar.idade}`);
            }
            if (oldChar.virtude !== newChar.virtude) {
                changes.push(`Mudou virtude para "${newChar.virtude}"`);
            }
            if (oldChar.vicio !== newChar.vicio) {
                changes.push(`Mudou v√≠cio para "${newChar.vicio}"`);
            }
            if (oldChar.tamanho !== newChar.tamanho) {
                changes.push(`Tamanho: ${oldChar.tamanho} ‚Üí ${newChar.tamanho}`);
            }
            if (oldChar.auraImortalidade !== newChar.auraImortalidade) {
                changes.push(`Aura de Imortalidade: ${oldChar.auraImortalidade} ‚Üí ${newChar.auraImortalidade}`);
            }
            
            // 3. EXP e LUNS
            if (oldChar.exp !== newChar.exp) {
                const diff = newChar.exp - oldChar.exp;
                if (diff > 0) {
                    changes.push(`üìà Ganhou ${diff} EXP (Total: ${newChar.exp})`);
                } else {
                    changes.push(`üìâ Gastou ${Math.abs(diff)} EXP (Total: ${newChar.exp})`);
                }
            }
            if (oldChar.luns !== newChar.luns) {
                const diff = newChar.luns - oldChar.luns;
                if (diff > 0) {
                    changes.push(`üí∞ Ganhou ${diff} Luns (Total: ${newChar.luns})`);
                } else {
                    changes.push(`üí∏ Gastou ${Math.abs(diff)} Luns (Total: ${newChar.luns})`);
                }
            }
            
            // 4. HP e SANIDADE
            if (oldChar.hpCurrent !== newChar.hpCurrent) {
                const diff = newChar.hpCurrent - oldChar.hpCurrent;
                if (diff > 0) {
                    changes.push(`‚ù§Ô∏è Curou ${diff} HP (${newChar.hpCurrent}/${newChar.hpMax})`);
                } else {
                    changes.push(`üíî Perdeu ${Math.abs(diff)} HP (${newChar.hpCurrent}/${newChar.hpMax})`);
                }
            }
            if (oldChar.sanCurrent !== newChar.sanCurrent) {
                const diff = newChar.sanCurrent - oldChar.sanCurrent;
                if (diff > 0) {
                    changes.push(`üß† Recuperou ${diff} Sanidade (${newChar.sanCurrent}/100)`);
                } else {
                    changes.push(`üòµ Perdeu ${Math.abs(diff)} Sanidade (${newChar.sanCurrent}/100)`);
                }
            }
            
            // 5. PER√çCIAS (SKILLS)
            Object.keys(newChar.skills).forEach(skillId => {
                if (oldChar.skills[skillId] !== newChar.skills[skillId]) {
                    const skillName = skillId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    changes.push(`üéØ ${skillName}: ${oldChar.skills[skillId]} ‚Üí ${newChar.skills[skillId]}`);
                }
            });
            
            // 6. HABILIDADES DE CLASSE
            Object.keys(newChar.classAbilities || {}).forEach(abilityId => {
                const oldLevel = oldChar.classAbilities?.[abilityId] || 0;
                const newLevel = newChar.classAbilities[abilityId];
                if (oldLevel !== newLevel) {
                    const abilityName = abilityId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    changes.push(`‚≠ê ${abilityName}: ${oldLevel} ‚Üí ${newLevel}`);
                }
            });
            
            // 7. INVENT√ÅRIO (CONTAINERS E ITENS)
            const oldContainers = oldChar.containers || [];
            const newContainers = newChar.containers || [];
            
            // Containers adicionados
            newContainers.forEach(newCont => {
                if (!oldContainers.find(c => c.id === newCont.id)) {
                    changes.push(`üéí Adicionou container "${newCont.name}"`);
                }
            });
            
            // Containers removidos
            oldContainers.forEach(oldCont => {
                if (!newContainers.find(c => c.id === oldCont.id)) {
                    changes.push(`üóëÔ∏è Removeu container "${oldCont.name}"`);
                }
            });
            
            // Itens adicionados/removidos
            newContainers.forEach(newCont => {
                const oldCont = oldContainers.find(c => c.id === newCont.id);
                if (oldCont) {
                    // Itens adicionados
                    (newCont.items || []).forEach(newItem => {
                        if (!(oldCont.items || []).find(i => i.id === newItem.id)) {
                            changes.push(`‚ûï Adicionou "${newItem.name}" em ${newCont.name}`);
                        }
                    });
                    
                    // Itens removidos
                    (oldCont.items || []).forEach(oldItem => {
                        if (!(newCont.items || []).find(i => i.id === oldItem.id)) {
                            changes.push(`‚ûñ Removeu "${oldItem.name}" de ${oldCont.name}`);
                        }
                    });
                    
                    // Quantidade alterada
                    (newCont.items || []).forEach(newItem => {
                        const oldItem = (oldCont.items || []).find(i => i.id === newItem.id);
                        if (oldItem && oldItem.quantity !== newItem.quantity) {
                            changes.push(`üî¢ "${newItem.name}": ${oldItem.quantity} ‚Üí ${newItem.quantity}`);
                        }
                    });
                }
            });
            
            // 8. CONDI√á√ïES
            const oldConditions = oldChar.conditions || [];
            const newConditions = newChar.conditions || [];
            
            newConditions.forEach(cond => {
                if (!oldConditions.includes(cond)) {
                    changes.push(`‚ö†Ô∏è Adicionou condi√ß√£o: ${cond}`);
                }
            });
            
            oldConditions.forEach(cond => {
                if (!newConditions.includes(cond)) {
                    changes.push(`‚úÖ Removeu condi√ß√£o: ${cond}`);
                }
            });
            
            // 9. ALIADOS
            const oldAllies = oldChar.allies || [];
            const newAllies = newChar.allies || [];
            
            newAllies.forEach(ally => {
                if (!oldAllies.find(a => a.id === ally.id)) {
                    changes.push(`üë• Adicionou aliado: ${ally.nome}`);
                }
            });
            
            oldAllies.forEach(ally => {
                if (!newAllies.find(a => a.id === ally.id)) {
                    changes.push(`üëã Removeu aliado: ${ally.nome}`);
                }
            });
            
            // 10. PROPRIEDADES
            const oldProps = oldChar.properties || [];
            const newProps = newChar.properties || [];
            
            newProps.forEach(prop => {
                if (!oldProps.find(p => p.id === prop.id)) {
                    changes.push(`üè† Adicionou propriedade: ${prop.nome}`);
                }
            });
            
            oldProps.forEach(prop => {
                if (!newProps.find(p => p.id === prop.id)) {
                    changes.push(`üèöÔ∏è Removeu propriedade: ${prop.nome}`);
                }
            });
            
            return changes;
        }

        /**
         * Carrega containers e itens do Firebase
         */
        async function loadInventoryFromFirebase(characterId) {
            try {
                console.log(`üîç [loadInventoryFromFirebase] Iniciando com characterId:`, characterId);
                
                // Carregar containers
                const containers = await loadContainersFromFirebase(characterId);
                console.log(`üì¶ [loadInventoryFromFirebase] Containers carregados:`, containers.length, containers);
                
                // Carregar itens
                const allItems = await loadItemsFromFirebase(characterId);
                console.log(`üì¶ [loadInventoryFromFirebase] Itens carregados:`, allItems.length, allItems);
                
                // Organizar itens por container
                const containersWithItems = containers.map(container => {
                    console.log(`üîç [loadInventoryFromFirebase] Processando container:`, container.name, `(ID: ${container.id})`);
                    
                    const items = allItems.filter(item => {
                        if (container.name === 'Equipados') {
                            const match = item.containerId === 'est√° com algu√©m';
                            console.log(`  üìå Item "${item.name}" - containerId: "${item.containerId}" - Match Equipados: ${match}`);
                            return match;
                        }
                        const match = item.containerId === container.id;
                        console.log(`  üìå Item "${item.name}" - containerId: "${item.containerId}" - containerID: "${container.id}" - Match: ${match}`);
                        return match;
                    });
                    
                    console.log(`‚úÖ [loadInventoryFromFirebase] Container "${container.name}" ficou com ${items.length} itens`);
                    
                    return {
                        ...container,
                        items: items
                    };
                });
                
                window.character.containers = containersWithItems;
                console.log('‚úÖ Invent√°rio carregado:', containersWithItems);
                updateLunsDisplay();

            } catch (error) {
                console.error('‚ùå [loadInventoryFromFirebase] Erro ao carregar invent√°rio:', error);
                window.character.containers = [];
            }
        }

        // ============= ALIADOS =============
        window.addAlly = function() {
            const char = getChar();
            const nome = prompt('Nome do aliado:');
            if (!nome) return;
            
            const allyId = 'ally-' + Date.now();
            
            if (!char.allies) char.allies = [];
            
            char.allies.push({
                id: allyId,
                nome: nome,
                tipoRaca: '',
                funcao: '',
                idade: 0,
                virtude: '',
                vicio: '',
                lealdade: 3,
                auraImortalidade: 0,
                tamanho: 5,
                int: 1, for: 1, pre: 1, rac: 1, des: 1, man: 1, prs: 1, vig: 1, aut: 1,
                blindagem: 0,
                hpCurrent: 5,
                sanCurrent: 100,
                ataquesTalentos: '',
                inventario: [],
                notas: ''
            });
            
            updateAlliesList();
            updateAlliesCombat();
            autoSave();
            showAlert('‚úÖ Aliado criado! Clique nele para editar detalhes.', 'success');
        };

        window.removeAlly = function(allyId) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja remover este aliado permanentemente?')) return;
            
            const char = getChar();
            char.allies = char.allies.filter(a => a.id !== allyId);
            updateAlliesList();
            updateAlliesCombat();
            autoSave();
            showAlert('üóëÔ∏è Aliado removido!', 'success');
        };

        window.openAlly = function(allyId) {
            const urlParams = new URLSearchParams(window.location.search);
            const characterId = urlParams.get('id') || currentUser.uid;
            window.location.href = `aliado.html?characterId=${characterId}&allyId=${allyId}`;
        };

        function updateAlliesList() {
            const char = getChar();
            const list = document.getElementById('allies-list');
            
            if (!char.allies || char.allies.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhum aliado ainda. Adicione um companheiro, montaria ou servo!</p>';
                return;
            }
            
            list.innerHTML = char.allies.map(ally => {
                const vitalidadeMax = (ally.vig || 1) + (ally.tamanho || 5);
                const sanidadeMax = 100;
                
                // N√ÉO sobrescrever valores existentes, apenas garantir que existam
                if (ally.hpCurrent === undefined || ally.hpCurrent === null) {
                    ally.hpCurrent = vitalidadeMax;
                }
                if (ally.sanCurrent === undefined || ally.sanCurrent === null) {
                    ally.sanCurrent = 80;
                }
                
                const hpPercent = Math.round((ally.hpCurrent / vitalidadeMax) * 100);
                const sanPercent = Math.round((ally.sanCurrent / sanidadeMax) * 100);
                
                return `
                    <div class="container-card" style="cursor: pointer;" onclick="openAlly('${ally.id}')">
                        <div class="container-header">
                            <div class="container-name">üë§ ${ally.nome || 'Sem nome'}</div>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeAlly('${ally.id}')">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">
                                <strong>Tipo:</strong> ${ally.tipoRaca || '‚Äî'} | 
                                <strong>Fun√ß√£o:</strong> ${ally.funcao || '‚Äî'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    ‚ù§Ô∏è Vitalidade: ${ally.hpCurrent} / ${vitalidadeMax} (${hpPercent}%)
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${hpPercent}%; height: 100%; background: linear-gradient(90deg, var(--danger), var(--success)); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    üß† Sanidade: ${ally.sanCurrent} / ${sanidadeMax} (${sanPercent}%)
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${sanPercent}%; height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; border-top: 1px solid var(--border); text-align: center; color: var(--primary); font-weight: 600; font-size: 0.85rem;">
                            ‚úèÔ∏è CLIQUE PARA EDITAR FICHA COMPLETA
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Expor fun√ß√£o para uso global
        window.updateAlliesList = updateAlliesList;

        function updateAlliesCombat() {
            const char = getChar();
            const section = document.getElementById('alliesCombatSection');
            const list = document.getElementById('allies-combat-list');
            
            if (!char.allies || char.allies.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            list.innerHTML = char.allies.map(ally => {
                const vitalidadeMax = (ally.vig || 1) + (ally.tamanho || 5);
                const sanidadeMax = 100;
                
                // N√ÉO sobrescrever valores existentes, apenas garantir que existam
                if (ally.hpCurrent === undefined || ally.hpCurrent === null) {
                    ally.hpCurrent = vitalidadeMax;
                }
                if (ally.sanCurrent === undefined || ally.sanCurrent === null) {
                    ally.sanCurrent = 80;
                }
                
                return `
                    <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-weight: 700; color: var(--light); font-size: 1.1rem; margin-bottom: 12px;">
                            üë§ ${ally.nome || 'Sem nome'}
                        </div>
                        
                        <!-- Vitalidade -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">‚ù§Ô∏è Vitalidade</label>
                            <div class="hp-bar">
                                <div class="hp-fill" id="ally-hp-fill-${ally.id}" style="width: ${(ally.hpCurrent / vitalidadeMax) * 100}%;">
                                    <span id="ally-hp-text-${ally.id}">${ally.hpCurrent} / ${vitalidadeMax}</span>
                                </div>
                            </div>
                            <div class="hp-controls">
                                <button class="btn btn-secondary btn-small" onclick="adjustAllyHP('${ally.id}', -1)">-1</button>
                                <button class="btn btn-secondary btn-small" onclick="adjustAllyHP('${ally.id}', -5)">-5</button>
                                <input type="number" id="ally-hp-${ally.id}" value="${ally.hpCurrent}" onchange="updateAllyHPBar('${ally.id}')" inputmode="numeric" style="width: 80px; text-align: center; padding: 8px;">
                                <button class="btn btn-primary btn-small" onclick="adjustAllyHP('${ally.id}', 1)">+1</button>
                                <button class="btn btn-primary btn-small" onclick="adjustAllyHP('${ally.id}', 5)">+5</button>
                                <button class="btn btn-secondary btn-small" onclick="resetAllyHP('${ally.id}')">Max</button>
                            </div>
                        </div>
                        
                        <!-- Sanidade -->
                        <div>
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">üß† Sanidade</label>
                            <div class="hp-bar">
                                <div class="hp-fill" id="ally-san-fill-${ally.id}" style="width: ${(ally.sanCurrent / sanidadeMax) * 100}%; background: linear-gradient(90deg, #6366f1, #8b5cf6);">
                                    <span id="ally-san-text-${ally.id}">${ally.sanCurrent} / ${sanidadeMax}</span>
                                </div>
                            </div>
                            <div class="hp-controls">
                                <button class="btn btn-secondary btn-small" onclick="adjustAllySAN('${ally.id}', -1)">-1</button>
                                <button class="btn btn-secondary btn-small" onclick="adjustAllySAN('${ally.id}', -5)">-5</button>
                                <input type="number" id="ally-san-${ally.id}" value="${ally.sanCurrent}" onchange="updateAllySANBar('${ally.id}')" inputmode="numeric" style="width: 80px; text-align: center; padding: 8px;">
                                <button class="btn btn-primary btn-small" onclick="adjustAllySAN('${ally.id}', 1)">+1</button>
                                <button class="btn btn-primary btn-small" onclick="adjustAllySAN('${ally.id}', 5)">+5</button>
                                <button class="btn btn-secondary btn-small" onclick="resetAllySAN('${ally.id}')">Max</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Expor fun√ß√£o para uso global
        window.updateAlliesCombat = updateAlliesCombat;

        window.adjustAllyHP = function(allyId, amount) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            ally.hpCurrent = Math.max(0, Math.min((ally.hpCurrent || max) + amount, max));
            
            const input = document.getElementById(`ally-hp-${allyId}`);
            if (input) input.value = ally.hpCurrent;
            
            updateAllyHPBar(allyId);
            
            // For√ßar salvamento imediato
            saveToFirebase();
        };

        window.updateAllyHPBar = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            const input = document.getElementById(`ally-hp-${allyId}`);
            if (input) {
                ally.hpCurrent = Math.max(0, Math.min(parseInt(input.value) || 0, max));
                input.value = ally.hpCurrent;
            }
            
            const fill = document.getElementById(`ally-hp-fill-${allyId}`);
            const text = document.getElementById(`ally-hp-text-${allyId}`);
            if (fill && text) {
                const percent = (ally.hpCurrent / max) * 100;
                fill.style.width = percent + '%';
                text.textContent = `${ally.hpCurrent} / ${max}`;
            }
            
            if (typeof window.updateAlliesList === 'function') {
                window.updateAlliesList();
            }
            
            // For√ßar salvamento imediato
            saveToFirebase();
        };

        window.resetAllyHP = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            ally.hpCurrent = max;
            
            const input = document.getElementById(`ally-hp-${allyId}`);
            if (input) input.value = ally.hpCurrent;
            
            updateAllyHPBar(allyId);
        };

        window.adjustAllySAN = function(allyId, amount) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = 100;
            ally.sanCurrent = Math.max(0, Math.min((ally.sanCurrent || 80) + amount, max));
            
            const input = document.getElementById(`ally-san-${allyId}`);
            if (input) input.value = ally.sanCurrent;
            
            updateAllySANBar(allyId);
            
            // For√ßar salvamento imediato
            saveToFirebase();
        };

        window.updateAllySANBar = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = 100;
            const input = document.getElementById(`ally-san-${allyId}`);
            if (input) {
                ally.sanCurrent = Math.max(0, Math.min(parseInt(input.value) || 0, max));
                input.value = ally.sanCurrent;
            }
            
            const fill = document.getElementById(`ally-san-fill-${allyId}`);
            const text = document.getElementById(`ally-san-text-${allyId}`);
            if (fill && text) {
                const percent = (ally.sanCurrent / max) * 100;
                fill.style.width = percent + '%';
                text.textContent = `${ally.sanCurrent} / ${max}`;
            }
            
            if (typeof window.updateAlliesList === 'function') {
                window.updateAlliesList();
            }
            
            // For√ßar salvamento imediato
            saveToFirebase();
        };

        window.resetAllySAN = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = 100;
            ally.sanCurrent = max;
            
            const input = document.getElementById(`ally-san-${allyId}`);
            if (input) input.value = ally.sanCurrent;
            
            updateAllySANBar(allyId);
        };

        // ============= PROPRIEDADES =============
        window.addProperty = function() {
            const char = getChar();
            const nome = prompt('Nome da propriedade:');
            if (!nome) return;
            
            const propertyId = 'property-' + Date.now();
            
            if (!char.properties) char.properties = [];
            
            char.properties.push({
                id: propertyId,
                nome: nome,
                tipo: '',
                categoria: '',
                localizacao: '',
                tamanho: '',
                estado: '',
                material: '',
                qualidade: '',
                integridade: 100,
                blindagem: 0,
                conforto: 0,
                saneamento: 0,
                seguranca: 0,
                capPessoas: 0,
                capCarga: 0,
                notoriedade: 0,
                receita: 0,
                despesas: 0,
                impostos: 0,
                modulos: {},
                modulosSobre: '',
                protocolos: '',
                horarioOperacao: '',
                funcionarios: [],
                inventario: [],
                portas: 1,
                janelas: 0,
                passagensSecretas: 0,
                trancas: '',
                alarmes: '',
                riscosLocais: '',
                pendenciasAtuais: '',
                reputacao: '',
                dataAquisicao: '',
                proprietariosAnteriores: '',
                ocorrenciasMarcantes: '',
                upgrades: [],
                notas: ''
            });
            
            updatePropertiesList();
            autoSave();
            showAlert('‚úÖ Propriedade criada! Clique nela para editar detalhes.', 'success');
        };

        window.removeProperty = function(propertyId) {
            if (!confirm('‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Tem certeza que deseja remover esta propriedade permanentemente? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è')) return;
            
            const char = getChar();
            char.properties = char.properties.filter(p => p.id !== propertyId);
            updatePropertiesList();
            autoSave();
            showAlert('üóëÔ∏è Propriedade removida!', 'success');
        };

        window.openProperty = function(propertyId) {
            const urlParams = new URLSearchParams(window.location.search);
            const characterId = urlParams.get('id') || currentUser.uid;
            window.location.href = `propriedade.html?characterId=${characterId}&propertyId=${propertyId}`;
        };

        function updatePropertiesList() {
            const char = getChar();
            const list = document.getElementById('properties-list');
            
            if (!char.properties || char.properties.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhuma propriedade ainda. Adicione uma taverna, casa, oficina ou estabelecimento!</p>';
                return;
            }
            
            list.innerHTML = char.properties.map(property => {
                const integPercent = Math.round((property.integridade / 100) * 100);
                let integColor = 'var(--success)';
                if (integPercent < 30) integColor = 'var(--danger)';
                else if (integPercent < 70) integColor = 'var(--warning)';
                
                return `
                    <div class="container-card" style="cursor: pointer;" onclick="openProperty('${property.id}')">
                        <div class="container-header">
                            <div class="container-name">üè† ${property.nome || 'Sem nome'}</div>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeProperty('${property.id}')">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">
                                <strong>Tipo:</strong> ${property.tipo || '‚Äî'} | 
                                <strong>Localiza√ß√£o:</strong> ${property.localizacao || '‚Äî'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    üèóÔ∏è Integridade: ${property.integridade}% | 
                                    üõ°Ô∏è Blindagem: ${property.blindagem}
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${integPercent}%; height: 100%; background: ${integColor}; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.8rem; color: #94a3b8;">
                                <div>‚≠ê Qualidade: ${property.qualidade || '‚Äî'}</div>
                                <div>üë• Cap: ${property.capPessoas || 0}</div>
                                <div>üì¶ Carga: ${property.capCarga || 0}</div>
                            </div>
                        </div>
                        <div style="padding: 12px; border-top: 1px solid var(--border); text-align: center; color: var(--primary); font-weight: 600; font-size: 0.85rem;">
                            ‚úèÔ∏è CLIQUE PARA EDITAR DETALHES COMPLETOS
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.updatePropertiesList = updatePropertiesList;

        // Expor fun√ß√µes do Firebase para uso global
        window.saveContainerToFirebase = saveContainerToFirebase;
        window.saveItemToFirebase = saveItemToFirebase;
        window.deleteContainerFromFirebase = deleteContainerFromFirebase;
        window.deleteItemFromFirebase = deleteItemFromFirebase;
        window.loadInventoryFromFirebase = loadInventoryFromFirebase;
        window.ensureEquipadosContainer = ensureEquipadosContainer;
        window.loadContainersFromFirebase = loadContainersFromFirebase;

        // Expor fun√ß√µes para uso global
        window.updateAlliesList = updateAlliesList;
        window.updatePropertiesList = updatePropertiesList;
        window.updateAlliesCombat = updateAlliesCombat;
    </script>

    <!-- L√ìGICA DO SISTEMA -->
    <script>
        // ============= DADOS DO SISTEMA =============
        const SKILLS = {
            mental: [
                { name: 'Abismo', attr: '[PRS]', penalty: -3, hasInput: false },
                { name: 'Alquimia', attr: '[RAC]', penalty: -3, hasInput: false },
                { name: 'Ess√™ncia', attr: '[INT/RAC/PRS]', penalty: -3, hasInput: false },
                { name: 'Herbalismo', attr: '[INT/PRS]', penalty: -3, hasInput: false },
                { name: 'Hist√≥ria', attr: '[INT]', penalty: -3, hasInput: false },
                { name: 'Investiga√ß√£o', attr: '[INT/RAC]', penalty: -3, hasInput: false },
                { name: 'Of√≠cio Intelectual', attr: '', penalty: -3, hasInput: true, placeholder: 'Ex: Escriba, Cart√≥grafo...' },
                { name: 'Rel√≠quia', attr: '[INT]', penalty: -3, hasInput: false },
                { name: 'Runomancia', attr: '[INT/RAC]', penalty: -3, hasInput: false }
            ],
            fisico: [
                { name: 'Arma', attr: '[FOR/DES]', penalty: -1, hasInput: false },
                { name: 'Disparo', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Atletismo', attr: '[VIG]', penalty: -1, hasInput: false },
                { name: 'Briga', attr: '[FOR]', penalty: -1, hasInput: false },
                { name: 'Agilidade', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Furtividade', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Montaria', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Of√≠cio Bra√ßal', attr: '', penalty: -1, hasInput: true, placeholder: 'Ex: Ferreiro, Lenhador...' },
                { name: 'Sobreviv√™ncia', attr: '[VIG]', penalty: -1, hasInput: false }
            ],
            social: [
                { name: 'Barganha', attr: '[MAN]', penalty: -1, hasInput: false },
                { name: 'Diplomacia', attr: '[MAN]', penalty: -1, hasInput: false },
                { name: 'Domar', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Empatia', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Intimida√ß√£o', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Lideran√ßa', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Malandragem', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Performance', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Sedu√ß√£o', attr: '[MAN]', penalty: -1, hasInput: false }
            ]
        };

        const CLASS_ABILITIES = {
            'Ca√ßador': {
                abilities: [
                    { id: 'erudi√ß√£o-ofensiva', name: 'Erudi√ß√£o Ofensiva', maxLevel: 5 },
                    { id: 'macera√ß√£o', name: 'Macera√ß√£o', maxLevel: 5 },
                    { id: 'dosagem', name: 'Dosagem', maxLevel: 5 },
                    { id: 'precis√£o', name: 'Precis√£o', maxLevel: 5 },
                    { id: 'marcar-presa', name: 'Marcar Presa', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'üèπ Disparo', formula: 'DES + Disparo + Precis√£o + Equipamento', calculate: (char) => {
                        const disparo = char.skills['disparo'] || 0;
                        const precisao = char.classAbilities?.['precis√£o'] || 0;
                        return char.des + disparo + precisao;
                    }},
                    { name: 'üéØ Disparo Furtivo', formula: 'DES + Disparo + Furtividade + Precis√£o', calculate: (char) => {
                        const disparo = char.skills['disparo'] || 0;
                        const furtividade = char.skills['furtividade'] || 0;
                        const precisao = char.classAbilities?.['precis√£o'] || 0;
                        return char.des + disparo + furtividade + precisao;
                    }},
                    { name: 'üë£ Rastreamento', formula: 'RAC + PRE + Sobreviv√™ncia', calculate: (char) => {
                        const sobrevivencia = char.skills['sobreviv√™ncia'] || 0;
                        return char.rac + char.pre + sobrevivencia;
                    }},
                    { name: 'üß™ Preparar Lo√ß√£o', formula: 'RAC + Herbalismo + Macera√ß√£o', calculate: (char) => {
                        const herbalismo = char.skills['herbalismo'] || 0;
                        const maceracao = char.classAbilities?.['macera√ß√£o'] || 0;
                        return char.rac + herbalismo + maceracao;
                    }},
                    { name: 'üíâ Dosagem', formula: 'INT + Herbalismo + Dosagem', calculate: (char) => {
                        const herbalismo = char.skills['herbalismo'] || 0;
                        const dosagem = char.classAbilities?.['dosagem'] || 0;
                        return char.int + herbalismo + dosagem;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'kits-ingredientes', name: 'Kits/Ingredientes', max: 10, info: 'Usados na prepara√ß√£o de lo√ß√µes' }
                ],
                info: `<strong>Papel:</strong> Rastreio, combate √† dist√¢ncia e alquimancia ofensiva.<br>
                    <strong>Recursos:</strong> Determina√ß√£o e Ingredientes.<br>
                    <strong>Marca de Ca√ßa:</strong> Ganhe (1 + Marcar Presa) em rastreamento e ataques contra o alvo marcado.<br>
                    <strong>Dica:</strong> Prepare lo√ß√µes antes do combate e marque os inimigos mais perigosos.`
            },
            'Druida': {
                abilities: [
                    { id: 'erudi√ß√£o-ofensiva', name: 'Erudi√ß√£o Ofensiva', maxLevel: 5 },
                    { id: 'erudi√ß√£o-defensiva', name: 'Erudi√ß√£o Defensiva', maxLevel: 5 },
                    { id: 'macera√ß√£o', name: 'Macera√ß√£o', maxLevel: 5 },
                    { id: 'dosagem', name: 'Dosagem', maxLevel: 5 },
                    { id: 'aliado-animal', name: 'Aliado Animal', maxLevel: 5 },
                    { id: 'linguagem-animal', name: 'Linguagem Animal', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'ü¶¥ Domar Aliado', formula: 'PRE + Domar + Aliado Animal', calculate: (char) => {
                        const domar = char.skills['domar'] || 0;
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        return char.pre + domar + aliadoAnimal;
                    }},
                    { name: 'üó£Ô∏è Comandar Aliado', formula: 'PRE + Lideran√ßa + Aliado Animal', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        return char.pre + lideranca + aliadoAnimal;
                    }},
                    { name: 'üê∫ Convocar Manada (-1 DET)', formula: 'PRE + Lideran√ßa + Linguagem Animal', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const linguagemAnimal = char.classAbilities?.['linguagem-animal'] || 0;
                        return char.pre + lideranca + linguagemAnimal;
                    }},
                    { name: 'üîÑ Fus√£o Selvagem (-1 DET)', formula: 'PRE + Aliado Animal + Linguagem Animal', calculate: (char) => {
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        const linguagemAnimal = char.classAbilities?.['linguagem-animal'] || 0;
                        return char.pre + aliadoAnimal + linguagemAnimal;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'kits-ingredientes', name: 'Kits/Ingredientes', max: 10, info: 'Usados na prepara√ß√£o de lo√ß√µes' },
                    { id: 'aliados-ativos', name: 'Aliados Ativos', max: 'aliado-animal', info: 'M√°ximo = n√≠vel de Aliado Animal' }
                ],
                info: `<strong>Papel:</strong> Suporte, comunh√£o animal e alquimancia.<br>
                    <strong>Fus√£o Selvagem:</strong> Emissor (controla animal) ou Receptor (ganha poderes).<br>
                    <strong>Dica:</strong> Proteja quem estiver em transe durante Fus√£o Selvagem.`
            },
            'Guerreiro': {
                abilities: [
                    { id: 'armas-haste', name: 'Armas de Haste', maxLevel: 5 },
                    { id: 'armas-pesadas', name: 'Armas Pesadas', maxLevel: 5 },
                    { id: 'armas-uma-mao', name: 'Armas de Uma M√£o', maxLevel: 5 },
                    { id: 'armas-duas-maos', name: 'Armas de Duas M√£os', maxLevel: 5 },
                    { id: 'armas-duplas', name: 'Armas Duplas', maxLevel: 5 },
                    { id: 'armas-arremessaveis', name: 'Armas Arremess√°veis', maxLevel: 5 },
                    { id: 'escudo', name: 'Escudo', maxLevel: 5 },
                    { id: 'postura-combate', name: 'Postura de Combate', maxLevel: 5 },
                    { id: 'contra-ataque', name: 'Contra-Ataque', maxLevel: 5 },
                    { id: 'impeto', name: '√çmpeto', maxLevel: 5 },
                    { id: 'guerrilha', name: 'Guerrilha', maxLevel: 5 },
                    { id: 'controle', name: 'Controle', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'üëä M√£os Vazias', formula: 'FOR + Briga', calculate: (char) => {
                        const briga = char.skills['briga'] || 0;
                        return char.for + briga;
                    }},
                    { name: 'üî± Arma de Haste', formula: 'FOR/DES + Arma + Armas de Haste', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const haste = char.classAbilities?.['armas-haste'] || 0;
                        return Math.max(char.for, char.des) + arma + haste;
                    }},
                    { name: '‚öíÔ∏è Arma Pesada', formula: 'FOR + Arma + Armas Pesadas', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const pesada = char.classAbilities?.['armas-pesadas'] || 0;
                        return char.for + arma + pesada;
                    }},
                    { name: '‚öîÔ∏è Arma de Uma M√£o', formula: 'FOR/DES + Arma + Armas de Uma M√£o', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const umaMao = char.classAbilities?.['armas-uma-mao'] || 0;
                        return Math.max(char.for, char.des) + arma + umaMao;
                    }},
                    { name: 'üó°Ô∏è Arma de Duas M√£os', formula: 'FOR/DES + Arma + Armas de Duas M√£os', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const duasMaos = char.classAbilities?.['armas-duas-maos'] || 0;
                        return Math.max(char.for, char.des) + arma + duasMaos;
                    }},
                    { name: '‚öîÔ∏è‚öîÔ∏è Armas Duplas', formula: 'FOR/DES + Arma + Armas Duplas', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const duplas = char.classAbilities?.['armas-duplas'] || 0;
                        return Math.max(char.for, char.des) + arma + duplas;
                    }},
                    { name: 'üéØ Arremesso', formula: 'FOR/DES + Disparo + Armas Arremess√°veis', calculate: (char) => {
                        const disparo = char.skills['disparo'] || 0;
                        const arremessaveis = char.classAbilities?.['armas-arremessaveis'] || 0;
                        return Math.max(char.for, char.des) + disparo + arremessaveis;
                    }},
                    { name: 'üõ°Ô∏è Escudo (Absorve Dano)', formula: 'N√≠vel de Escudo', calculate: (char) => char.classAbilities?.['escudo'] || 0 },
                    { name: 'üîÑ Contra-Ataque', formula: 'Rea√ß√£o + Contra-Ataque', calculate: (char) => {
                        const reacao = char.rac + (char.classAbilities?.['contra-ataque'] || 0);
                        const contraAtaque = char.classAbilities?.['contra-ataque'] || 0;
                        return reacao + contraAtaque;
                    }},
                    { name: 'üí™ Inspirar', formula: 'MAN + Lideran√ßa + Guerrilha', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const guerrilha = char.classAbilities?.['guerrilha'] || 0;
                        return char.man + lideranca + guerrilha;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [],
                info: `<strong>Papel:</strong> Combate direto, controle de campo.<br>
                    <strong>Manobras:</strong> 1 DET cada. M√°x 1/turno.<br>
                    <strong>Posturas:</strong> Ofensiva (+ataque, sem rea√ß√£o) ou Defensiva (+rea√ß√£o, sem ataque).<br>
                    <strong>Dica:</strong> Alterne posturas conforme a situa√ß√£o.`
            },
            'Adepto': {
                abilities: [
                    { id: 'contato-setimo', name: 'Contato com o S√©timo', maxLevel: 5 },
                    { id: 'selo-profano', name: 'Selo do Profano', maxLevel: 5 },
                    { id: 'talisma-profano', name: 'Talism√£ Profano', maxLevel: 5 },
                    { id: 'fragmento-identidade', name: 'Fragmento de Identidade', maxLevel: 5 },
                    { id: 'servos', name: 'Servos', maxLevel: 5 },
                    { id: 'vozes-tumulo', name: 'Vozes do T√∫mulo', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'servos-permanentes', name: 'Servos Permanentes', max: 'servos', info: 'M√°ximo = n√≠vel de Servos' },
                    { id: 'fantoches-ativos', name: 'Fantoches Ativos', max: 'calc-fantoches', info: 'M√°ximo = INT + Lideran√ßa + Servos' }
                ],
                info: `<strong>Papel:</strong> Necromancia, controle de mortos-vivos.<br>
                    <strong>Fragmentos:</strong> 0-5. Mais fragmentos = mais poder, menos controle.<br>
                    <strong>Talism√£ Profano:</strong> OBRIGAT√ìRIO para rituais.<br>
                    <strong>Dica:</strong> Fragmentos 2-3 equilibram poder e controle.`
            },
            'Ladino': {
                abilities: [
                    { id: 'armas-punho', name: 'Armas de Punho', maxLevel: 5 },
                    { id: 'ferramentas-crime', name: 'Ferramentas do Crime', maxLevel: 5 },
                    { id: 'precis√£o', name: 'Precis√£o', maxLevel: 5 },
                    { id: 'arrombamento', name: 'Arrombamento', maxLevel: 5 },
                    { id: 'prestidigita√ß√£o', name: 'Prestidigita√ß√£o', maxLevel: 5 },
                    { id: 'furtividade-ii', name: 'Furtividade II', maxLevel: 5 },
                    { id: 'malandragem-ii', name: 'Malandragem II', maxLevel: 5 },
                    { id: 'olho-brechas', name: 'Olho Para Brechas', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'üî™ Punhal', formula: 'DES + Arma + Armas Punho', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const punho = char.classAbilities?.['armas-punho'] || 0;
                        return char.des + arma + punho;
                    }},
                    { name: 'ü©∏ Punhal Furtivo', formula: 'DES + Arma + Punho + Furtividade + Furtividade II', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const punho = char.classAbilities?.['armas-punho'] || 0;
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + arma + punho + furt + furtII;
                    }},
                    { name: 'üîì Abrir Fechaduras', formula: 'DES + Arrombamento + Ferramentas', calculate: (char) => {
                        const arromb = char.classAbilities?.['arrombamento'] || 0;
                        const ferram = char.classAbilities?.['ferramentas-crime'] || 0;
                        return char.des + arromb + ferram;
                    }},
                    { name: 'ü§è Furto', formula: 'DES + Prestidigita√ß√£o + Furtividade I e II', calculate: (char) => {
                        const presti = char.classAbilities?.['prestidigita√ß√£o'] || 0;
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + presti + furt + furtII;
                    }},
                    { name: 'üïµÔ∏è Discri√ß√£o', formula: 'DES + Furtividade + Furtividade II', calculate: (char) => {
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + furt + furtII;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE + Olho Para Brechas', calculate: (char) => {
                        const olho = char.classAbilities?.['olho-brechas'] || 0;
                        return char.rac + char.pre + olho;
                    }}
                ],
                resources: [
                    { id: 'kit-larapio', name: 'Kit de Lar√°pio', max: 1, info: 'Ferramentas para arrombamento' }
                ],
                info: `<strong>Papel:</strong> Furtividade, manipula√ß√£o, dano oportunista.<br>
                    <strong>VULNERABILIDADE:</strong> Recebe 2√ó dano f√≠sico!<br>
                    <strong>Dica:</strong> Mantenha-se furtivo e evite combate direto.`
            },
            'Pallacerdote': {
                abilities: [
                    { id: 'simbolo-sagrado', name: 'S√≠mbolo Sagrado', maxLevel: 5 },
                    { id: 'devocao-palla', name: 'Devo√ß√£o em Palla', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'üôè Prece Breve (-1 DET ‚Üí +1 Gra√ßa)', formula: 'PRE + Ess√™ncia + S√≠mbolo Sagrado', calculate: (char) => {
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.pre + essencia + simbolo;
                    }},
                    { name: 'üòá Ben√ß√£o', formula: 'PRE + Performance + Ess√™ncia + S√≠mbolo', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.pre + performance + essencia + simbolo;
                    }},
                    { name: 'üì£ S√∫plica', formula: 'MAN + Performance + Ess√™ncia + S√≠mbolo', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.man + performance + essencia + simbolo;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'graca', name: 'Gra√ßa', max: 'devocao-palla', info: 'M√°ximo = n√≠vel de Devo√ß√£o (substitui DET nas preces)' }
                ],
                info: `<strong>Papel:</strong> Suporte, cura e controle por luz.<br>
                    <strong>Gra√ßa:</strong> Substitui Determina√ß√£o nas preces.<br>
                    <strong>Dica:</strong> Use Gra√ßa para preces e guarde DET para emerg√™ncias.`
            },
            'Ritualista': {
                abilities: [
                    { id: 'contato-oitavo', name: 'Contato com o Oitavo', maxLevel: 5 },
                    { id: 'selo-abissal', name: 'Selo Abissal', maxLevel: 5 },
                    { id: 'sacrificio', name: 'Sacrif√≠cio', maxLevel: 5 },
                    { id: 'resistencia-loucura', name: 'Resist√™ncia a Loucura', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Contato (Abertura)', formula: 'PRS + Performance + CA + Contato + Sacrif√≠cio', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const contato = char.classAbilities?.['contato-oitavo'] || 0;
                        const sacrificio = char.classAbilities?.['sacrificio'] || 0;
                        return char.prs + performance + contato + sacrificio;
                    }},
                    { name: 'Selo (Controle)', formula: 'RAC + Abismo + Selo + Sacrif√≠cio', calculate: (char) => {const abismo = char.skills['abismo'] || 0;
                        const selo = char.classAbilities?.['selo-abissal'] || 0;
                        const sacrificio = char.classAbilities?.['sacrificio'] || 0;
                        return char.rac + abismo + selo + sacrificio;
                    }},
                    { name: 'CA (Contato Abissal)', formula: 'N√≠vel de Contato com o Oitavo', calculate: (char) => char.classAbilities?.['contato-oitavo'] || 0 },
                    { name: 'Despertar', formula: 'AUT + Ess√™ncia vs (CA - Abismo)', calculate: (char) => {
                        const essencia = char.skills['ess√™ncia'] || 0;
                        return char.aut + essencia;
                    }},
                    { name: 'üëÅÔ∏è Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'ruptura-venire', name: 'Ruptura Venire (RV)', max: 10, info: 'Acumulado de falhas em Despertar' }
                ],
                info: `<strong>Papel:</strong> Controle do campo por rituais abissais.<br>
                    <strong>CA:</strong> Define poder dos rituais.<br>
                    <strong>Despertar:</strong> AUT + Ess√™ncia vs (CA - Abismo). Falha = -1 Sanidade.<br>
                    <strong>Dica:</strong> CA alto = mais poder, mais risco.`
            }
        };

        // STATE
        window.character = {
            nome: '', jogador: '', idade: 0, raca: '', classe: '', virtude: '', vicio: '',
            tamanho: 5, luns: 0, auraImortalidade: 1,
            int: 1, for: 1, pre: 1, rac: 1, des: 1, man: 1, prs: 1, vig: 1, aut: 1,
            skills: {},
            skillInputs: {},
            classAbilities: {},
            classResources: {},
            hpCurrent: 5, detCurrent: 3, sanCurrent: 80, blindagem: 0,
            containers: [], // Agora containers n√£o s√£o mais salvos no documento do personagem
            notas: '',
            exp: 0,
            characterImage: '',
            recipes: [], // Receitas de Lo√ß√£o (Ca√ßador: Ofensivas | Druida: Defensivas e Ofensivas)
            ritos: [], // Ritos de Pallacerdote (Prece e Liturgia)
            circuloPalla: 'Di√°cono da Luz', // C√≠rculo atual do Pallacerdote
            gracaAtual: 0, // Gra√ßa atual do Pallacerdote
        };

        function getChar() {
            return window.character;
        }

        function renderClassContent(classe) {
            const char = getChar();
            const classData = CLASS_ABILITIES[classe];
            const classContent = document.getElementById('class-content');
            
            let html = `
                <div class="section">
                    <h2 class="section-title">üéØ Habilidades de ${classe}</h2>
                    <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                        Clique nas bolinhas para aumentar o n√≠vel. 
                        ${classe === 'Pallacerdote' || classe === 'Ritualista' ? 'Custo: N√≠vel √ó 4 EXP' : 'Custo: N√≠vel √ó 2 EXP'}
                    </p>
                    <div class="grid grid-2">
            `;
            
            classData.abilities.forEach(ability => {
                if (!char.classAbilities[ability.id]) {
                    char.classAbilities[ability.id] = 0;
                }
                
                html += `
                    <div class="class-ability-item">
                        <div class="class-ability-name">${ability.name}</div>
                        <div class="dots" id="dots-class-${ability.id}"></div>
                    </div>
                `;
            });
            
            html += `</div></div>`;

            // Bloco C√≠rculo e Gra√ßa de Palla (apenas para Pallacerdote)
            if (classe === 'Pallacerdote') {
                const essencia = char.skills['ess√™ncia'] || 0;
                const maxGraca = char.pre + essencia;
                const gracaAtual = char.gracaAtual || 0;
                const circuloAtual = char.circuloPalla || 'Di√°cono da Luz';
                
                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title" style="background: linear-gradient(135deg, #fbbf24, #fde047); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ‚ú® C√≠rculo e Gra√ßa de Palla
                        </h2>
                        <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                            Defina seu c√≠rculo atual e acompanhe sua Gra√ßa de Palla (ajust√°vel na aba Combate).
                        </p>
                        
                        <div style="display: grid; gap: 20px;">
                            <!-- C√≠rculo de Palla -->
                            <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(253, 224, 71, 0.1)); border: 2px solid #fbbf24; border-radius: 12px; padding: 20px;">
                                <label style="display: block; color: #fde047; font-weight: 700; margin-bottom: 10px; font-size: 1.1rem;">
                                    üåü C√≠rculo Atual:
                                </label>
                                <select id="circulo-palla-select" 
                                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.9); color: #fde047; font-size: 1rem; cursor: pointer; font-weight: 700;">
                                    <option value="Di√°cono da Luz" ${circuloAtual === 'Di√°cono da Luz' ? 'selected' : ''}>‚≠ê Di√°cono da Luz</option>
                                    <option value="S√°bio da Luz" ${circuloAtual === 'S√°bio da Luz' ? 'selected' : ''}>‚ú® S√°bio da Luz</option>
                                    <option value="Bispo da Luz" ${circuloAtual === 'Bispo da Luz' ? 'selected' : ''}>üåü Bispo da Luz</option>
                                </select>
                            </div>

                            <!-- Gra√ßa de Palla -->
                            <div style="background: linear-gradient(135deg, rgba(253, 224, 71, 0.1), rgba(250, 204, 21, 0.1)); border: 2px solid #fde047; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 700; color: #fde047; font-size: 1.1rem;">
                                        üíé Gra√ßa de Palla
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #fbbf24;">
                                        <span id="graca-classe-atual">${gracaAtual}</span> / <span id="graca-classe-max">${maxGraca}</span>
                                    </div>
                                </div>
                                
                                <div class="hp-bar" style="margin-bottom: 10px; border: 2px solid #fbbf24;">
                                    <div class="hp-fill" id="graca-classe-fill" 
                                        style="width: ${maxGraca > 0 ? (gracaAtual / maxGraca) * 100 : 0}%; background: linear-gradient(90deg, #fbbf24, #fde047);">
                                        <span style="font-size: 0.9rem; color: #1e1b4b; font-weight: 700;">${gracaAtual} / ${maxGraca}</span>
                                    </div>
                                </div>
                                
                                <div style="color: #cbd5e1; font-size: 0.8rem;">
                                    <strong>üìä C√°lculo:</strong> M√°ximo = PRE (${char.pre}) + Ess√™ncia (${essencia}) = ${maxGraca}<br>
                                    <strong>üìù Atual:</strong> Ajust√°vel na aba "Combate"<br>
                                    <em style="color: #fde047;">üí° A Gra√ßa pode substituir Determina√ß√£o em algumas preces.</em>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Bloco Servos e Fantoches (apenas para Adepto)
            if (classe === 'Adepto') {
                const maxServos = char.classAbilities?.['servos'] || 0;
                const lideranca = char.skills?.['lideran√ßa'] || 0;
                const servosHabilidade = char.classAbilities?.['servos'] || 0;
                const maxFantoches = char.int + lideranca + servosHabilidade;
                
                // Contar servos atuais (aliados com fun√ß√£o 'Servo Zumbi')
                const servosAtuais = (char.allies || []).filter(ally => 
                    (ally.funcao || '').toLowerCase().includes('servo zumbi')
                ).length;
                
                const fantochesAtuais = char.fantochesAtivos || 0;
                
                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title">üßü Servos e Fantoches</h2>
                        <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                            Acompanhe seus servos permanentes e fantoches tempor√°rios.
                        </p>
                        
                        <div style="display: grid; gap: 15px;">
                            <!-- Servos Permanentes -->
                            <div style="background: rgba(128, 0, 128, 0.1); border: 2px solid #800080; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 700; color: #a78bfa; font-size: 1.1rem;">
                                        ‚ö∞Ô∏è Servos Permanentes
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #800080;">
                                        <span id="servos-atual">${servosAtuais}</span> / <span id="servos-max">${maxServos}</span>
                                    </div>
                                </div>
                                
                                <div class="hp-bar" style="margin-bottom: 10px;">
                                    <div class="hp-fill" id="servos-fill" style="width: ${maxServos > 0 ? (servosAtuais / maxServos) * 100 : 0}%; background: linear-gradient(90deg, #800080, #a020f0);">
                                        <span style="font-size: 0.9rem;">${servosAtuais} / ${maxServos}</span>
                                    </div>
                                </div>
                                
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    <strong>üìä C√°lculo:</strong> M√°ximo = Habilidade Servos (${maxServos})<br>
                                    <strong>üìù Atual:</strong> Contado dos Aliados com fun√ß√£o "Servo Zumbi"<br>
                                    <em>üí° Adicione aliados na aba "Aliados" com a fun√ß√£o "Servo Zumbi" para contabilizar aqui.</em>
                                </div>
                            </div>
                            
                            <!-- Fantoches Tempor√°rios -->
                            <div style="background: rgba(128, 0, 128, 0.1); border: 2px solid #800080; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <div style="font-weight: 700; color: #a78bfa; font-size: 1.1rem;">
                                        üßü Fantoches Ativos
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: 900; color: #800080;">
                                        <span id="fantoches-atual">${fantochesAtuais}</span> / <span id="fantoches-max">${maxFantoches}</span>
                                    </div>
                                </div>
                                
                                <div class="hp-bar" style="margin-bottom: 10px;">
                                    <div class="hp-fill" id="fantoches-classe-fill" style="width: ${maxFantoches > 0 ? (fantochesAtuais / maxFantoches) * 100 : 0}%; background: linear-gradient(90deg, #800080, #a020f0);">
                                        <span style="font-size: 0.9rem;">${fantochesAtuais} / ${maxFantoches}</span>
                                    </div>
                                </div>
                                
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    <strong>üìä C√°lculo:</strong> M√°ximo = INT (${char.int}) + Lideran√ßa (${lideranca}) + Servos (${servosHabilidade}) = ${maxFantoches}<br>
                                    <strong>üìù Atual:</strong> Definido na aba "Combate"<br>
                                    <em>üí° V√° para a aba "Combate" para ajustar fantoches durante batalhas.</em>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Bloco Marca de Ca√ßa (apenas para Ca√ßador)
            if (classe === 'Ca√ßador') {
                const marcarPresa = char.classAbilities['marcar-presa'] || 0;
                const bonusCaca = 1 + marcarPresa;
                
                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title">üéØ Marca de Ca√ßa</h2>
                        <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem; font-style: italic;">
                            Pode apagar ou trocar o Alvo caso consiga abat√™-lo. Para trocar de Alvo sem o abater, deve pagar 1 Determina√ß√£o.
                        </p>
                        
                        <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid var(--primary); border-radius: 12px; padding: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #cbd5e1; font-weight: 700; margin-bottom: 8px;">üéØ Alvo:</label>
                                <input type="text" id="marca-alvo" value="${char.marcaCaca?.alvo || ''}" 
                                    placeholder="Nome do alvo marcado..." 
                                    style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light); font-size: 1rem;">
                            </div>
                            
                            <div style="margin-bottom: 15px; background: rgba(139, 92, 246, 0.2); padding: 15px; border-radius: 8px; border: 2px solid var(--primary);">
                                <label style="display: block; color: #f59e0b; font-weight: 700; margin-bottom: 5px; font-size: 1.1rem;">‚ö° B√¥nus de Ca√ßa:</label>
                                <div style="font-size: 2rem; font-weight: 900; color: var(--primary); text-align: center;">
                                    +${bonusCaca}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem; text-align: center; margin-top: 5px;">
                                    (1 + Marcar Presa)
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; color: #cbd5e1; font-weight: 700; margin-bottom: 8px;">üìù Sobre o Alvo:</label>
                                <textarea id="marca-sobre" 
                                    placeholder="Descreva informa√ß√µes sobre o alvo, fraquezas, comportamento..."
                                    style="width: 100%; min-height: 100px; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light); font-size: 0.9rem; resize: vertical;"
                                >${char.marcaCaca?.sobre || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Bloco Rituais (apenas para Adepto)
            if (classe === 'Adepto') {
                // Definir todos os rituais com requisitos e c√°lculos
                const rituais = [
                    {
                        nome: 'Ritual de Reanima√ß√£o',
                        objetivo: 'Novo Servo Permanente',
                        custo: '1 DET e 1 SAN',
                        tempo: '~30 min',
                        quando: 'Fora de combate',
                        requisito: { tipo: 'multi', reqs: [
                            { tipo: 'resource', nome: 'Espa√ßo para Servo' },
                            { tipo: 'class', nome: 'talisma-profano', nivel: 1 }
                        ]},
                        passos: [
                            {
                                nome: '1¬∫ PASSO: CONTROLE DA RU√çNA',
                                calculo: 'Vigor m√°x. do cad√°ver - Controle da Ru√≠na',
                                descricao: 'Define o Potencial M√°ximo de Vigor (PMV) do servo.',
                                teste: 'PMV = Vigor m√°x. cad√°ver - (INT + Selo Profano)',
                                calcular: (char) => {
                                    const seloProfano = char.classAbilities?.['selo-profano'] || 0;
                                    return char.int + seloProfano;
                                }
                            },
                            {
                                nome: '2¬∫ PASSO: CONTATO',
                                calculo: 'PRS + Performance + Contato S√©timo + Talism√£ Profano',
                                descricao: 'Teste vs (PRS + AUT) do cad√°ver. Se falhar, cad√°ver √© consumido.',
                                teste: 'PRS + Performance + Contato S√©timo + Talism√£',
                                calcular: (char) => {
                                    const performance = char.skills?.['performance'] || 0;
                                    const contato = char.classAbilities?.['contato-setimo'] || 0;
                                    const talisma = char.classAbilities?.['talisma-profano'] || 0;
                                    return char.prs + performance + contato + talisma;
                                }
                            },
                            {
                                nome: '3¬∫ PASSO: DEFINIR VIGOR',
                                calculo: 'Menor entre (Total do Contato ou PMV)',
                                descricao: 'Define as capacidades e degrada√ß√£o do servo.',
                                teste: 'VIGOR = min(Teste de Contato, PMV)',
                                calcular: (char) => 0
                            },
                            {
                                nome: '4¬∫ PASSO: DEFINIR FRAGMENTOS',
                                calculo: 'N√≠vel de Fragmento de Identidade',
                                descricao: 'Define consci√™ncia do servo. De 0 (instinto raso) a 5 (identidade quase plena).',
                                teste: 'FRAGMENTOS = Fragmento de Identidade',
                                calcular: (char) => char.classAbilities?.['fragmento-identidade'] || 0
                            }
                        ]
                    },
                    {
                        nome: 'Ritual dos Fantoches',
                        objetivo: 'Novos Servos Imediatos',
                        custo: '1 SAN',
                        tempo: '2 A√ß√µes (‚âà 3-8 seg)',
                        quando: 'Em qualquer momento',
                        duracao: '1 cena',
                        raio: '5m',
                        requisito: { tipo: 'multi', reqs: [
                            { tipo: 'custom', verificar: (char) => {
                                const lideranca = char.skills?.['lideran√ßa'] || 0;
                                const servos = char.classAbilities?.['servos'] || 0;
                                const limiteFantoches = char.int + lideranca + servos;
                                const fantochesAtivos = char.resources?.['fantoches-ativos'] || 0;
                                return fantochesAtivos < limiteFantoches;
                            }, texto: 'Ter Limite de Fantoches dispon√≠vel' },
                            { tipo: 'class', nome: 'talisma-profano', nivel: 1 }
                        ]},
                        passos: [
                            {
                                nome: '1¬∫ PASSO: CONVOCAR',
                                calculo: 'PRS + Lideran√ßa + Talism√£ Profano',
                                descricao: 'Dificuldade = Quantidade de cad√°veres. Se falhar, perde SAN igual √† qtd de cad√°veres.',
                                teste: 'PRS + Lideran√ßa + Talism√£ vs Qtd Cad√°veres',
                                calcular: (char) => {
                                    const lideranca = char.skills?.['lideran√ßa'] || 0;
                                    const talisma = char.classAbilities?.['talisma-profano'] || 0;
                                    return char.prs + lideranca + talisma;
                                }
                            }
                        ]
                    },
                    {
                        nome: 'Vozes do T√∫mulo',
                        objetivo: 'Extrair mem√≥rias e emo√ß√µes',
                        custo: '2 SAN',
                        tempo: 'Minutos ou horas',
                        quando: 'Fora de combate',
                        raio: '20m',
                        requisito: { tipo: 'multi', reqs: [
                            { tipo: 'class', nome: 'talisma-profano', nivel: 1 },
                            { tipo: 'skill', nome: 'ess√™ncia', nivel: 2 },
                            { tipo: 'class', nome: 'vozes-tumulo', nivel: 1 }
                        ]},
                        passos: [
                            {
                                nome: '1¬∫ PASSO: VOZES DO T√öMULO',
                                calculo: 'PRE + Ess√™ncia + Vozes do T√∫mulo',
                                descricao: 'Cada sucesso extra traz mais informa√ß√µes.',
                                teste: 'PRE + Ess√™ncia + Vozes (Dif. min 1)',
                                calcular: (char) => {
                                    const essencia = char.skills?.['ess√™ncia'] || 0;
                                    const vozes = char.classAbilities?.['vozes-tumulo'] || 0;
                                    return char.pre + essencia + vozes;
                                }
                            }
                        ]
                    }
                ];

                // Fun√ß√£o para verificar requisito
                const verificarRequisitoRitual = (req, char) => {
                    if (req.tipo === 'multi') {
                        return req.reqs.every(r => verificarRequisitoRitual(r, char));
                    }
                    if (req.tipo === 'atributo') {
                        const atributos = {
                            'FOR': char.for, 'DES': char.des, 'VIG': char.vig,
                            'RAC': char.rac, 'PRE': char.pre, 'PRS': char.prs,
                            'INT': char.int, 'MAN': char.man
                        };
                        return atributos[req.nome] >= req.nivel;
                    }
                    if (req.tipo === 'skill') {
                        return (char.skills?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'class') {
                        return (char.classAbilities?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'resource') {
                        // Verificar se tem espa√ßo para servos
                        if (req.nome === 'Espa√ßo para Servo') {
                            const maxServos = char.classAbilities?.['servos'] || 0;
                            const servosAtuais = char.resources?.['servos-permanentes'] || 0;
                            return servosAtuais < maxServos;
                        }
                        return true;
                    }
                    if (req.tipo === 'custom') {
                        return req.verificar(char);
                    }
                    return false;
                };

                // Filtrar rituais dispon√≠veis
                const rituaisDisponiveis = rituais.filter(r => verificarRequisitoRitual(r.requisito, char));
                const rituaisIndisponiveis = rituais.filter(r => !verificarRequisitoRitual(r.requisito, char));

                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title">üîÆ Rituais</h2>
                        <div style="background: rgba(128, 0, 128, 0.1); border: 2px solid #800080; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 10px;">
                                <strong>‚ÑπÔ∏è Sobre Rituais:</strong><br>
                                ‚Ä¢ Rituais requerem Talism√£ Profano<br>
                                ‚Ä¢ Custam Determina√ß√£o e/ou Sanidade<br>
                                ‚Ä¢ Rituais em <span style="color: #800080; font-weight: 700;">p√∫rpura</span> = dispon√≠veis<br>
                                ‚Ä¢ Rituais em <span style="color: #64748b; font-weight: 700;">cinza</span> = requisitos n√£o atendidos
                            </p>
                        </div>
                `;

                // Rituais dispon√≠veis
                if (rituaisDisponiveis.length > 0) {
                    html += `<h3 style="color: #800080; margin: 15px 0 10px 0; font-size: 1.1rem;">‚úÖ Rituais Dispon√≠veis</h3>`;
                    
                    rituaisDisponiveis.forEach(ritual => {
                        // Montar texto de requisitos
                        let reqTextos = [];
                        if (ritual.requisito.tipo === 'multi') {
                            ritual.requisito.reqs.forEach(r => {
                                if (r.tipo === 'class') {
                                    const nomeFormatado = r.nome.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                                    reqTextos.push(`${nomeFormatado} ${r.nivel}`);
                                } else if (r.tipo === 'skill') {
                                    const nomeFormatado = r.nome.charAt(0).toUpperCase() + r.nome.slice(1);
                                    reqTextos.push(`${nomeFormatado} ${r.nivel}`);
                                } else if (r.tipo === 'resource') {
                                    reqTextos.push(r.nome);
                                } else if (r.tipo === 'custom') {
                                    reqTextos.push(r.texto);
                                }
                            });
                        }
                        const reqTexto = reqTextos.join('; ');
                        
                        html += `
                            <div style="background: rgba(128, 0, 128, 0.15); border-left: 4px solid #800080; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #800080; margin-bottom: 8px;">
                                    üîÆ ${ritual.nome}
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-bottom: 10px; font-size: 0.75rem; color: #94a3b8;">
                                    <div><strong>üéØ Objetivo:</strong> ${ritual.objetivo}</div>
                                    <div><strong>üí∞ Custo:</strong> ${ritual.custo}</div>
                                    <div><strong>‚è±Ô∏è Tempo:</strong> ${ritual.tempo}</div>
                                    <div><strong>üìç Quando:</strong> ${ritual.quando}</div>
                                    ${ritual.duracao ? `<div><strong>‚è≥ Dura√ß√£o:</strong> ${ritual.duracao}</div>` : ''}
                                    ${ritual.raio ? `<div><strong>üìè Raio:</strong> ${ritual.raio}</div>` : ''}
                                </div>
                                
                                ${reqTexto ? `<div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 10px;">
                                    <strong>‚ö†Ô∏è Requer:</strong> ${reqTexto}
                                </div>` : ''}
                                
                                <div style="margin-top: 12px;">
                                    ${ritual.passos.map((passo, idx) => {
                                        const valor = passo.calcular(char);
                                        return `
                                            <div style="background: rgba(139, 92, 246, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                                    <div style="font-weight: 700; color: #a78bfa; font-size: 0.9rem;">
                                                        ${passo.nome}
                                                    </div>
                                                    ${(valor > 0 || passo.nome.includes('FRAGMENTOS')) ? `<div style="background: #800080; color: white; padding: 6px 12px; border-radius: 15px; font-weight: 900; font-size: 1rem; box-shadow: 0 2px 8px rgba(128, 0, 128, 0.3);">
                                                        ${valor}
                                                    </div>` : ''}
                                                </div>
                                                <div style="color: #cbd5e1; font-size: 0.8rem; margin-bottom: 4px;">
                                                    <strong>Teste:</strong> ${passo.teste}
                                                </div>
                                                <div style="color: #94a3b8; font-size: 0.75rem; line-height: 1.4;">
                                                    ${passo.descricao}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    });
                }

                // Rituais indispon√≠veis
                if (rituaisIndisponiveis.length > 0) {
                    html += `<h3 style="color: #64748b; margin: 20px 0 10px 0; font-size: 1.1rem;">üîí Rituais Bloqueados</h3>`;
                    
                    rituaisIndisponiveis.forEach(ritual => {
                        // Montar texto de requisitos
                        let reqTextos = [];
                        if (ritual.requisito.tipo === 'multi') {
                            ritual.requisito.reqs.forEach(r => {
                                if (r.tipo === 'class') {
                                    const nomeFormatado = r.nome.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');
                                    reqTextos.push(`${nomeFormatado} ${r.nivel}`);
                                } else if (r.tipo === 'skill') {
                                    const nomeFormatado = r.nome.charAt(0).toUpperCase() + r.nome.slice(1);
                                    reqTextos.push(`${nomeFormatado} ${r.nivel}`);
                                } else if (r.tipo === 'resource') {
                                    reqTextos.push(r.nome);
                                } else if (r.tipo === 'custom') {
                                    reqTextos.push(r.texto);
                                }
                            });
                        }
                        const reqTexto = reqTextos.join('; ');
                        
                        html += `
                            <div style="background: rgba(100, 116, 139, 0.1); border-left: 4px solid #64748b; padding: 15px; border-radius: 8px; margin-bottom: 12px; opacity: 0.6;">
                                <div style="font-size: 1rem; font-weight: 700; color: #64748b; margin-bottom: 8px;">
                                    üîí ${ritual.nome}
                                </div>
                                
                                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px;">
                                    <strong>üéØ Objetivo:</strong> ${ritual.objetivo}
                                </div>
                                
                                ${reqTexto ? `<div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px;">
                                    <strong>‚ö†Ô∏è Requer:</strong> ${reqTexto}
                                </div>` : ''}
                                
                                <div style="color: #94a3b8; font-size: 0.75rem;">
                                    ${ritual.passos.map(p => p.nome).join(' ‚Üí ')}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
            }

            // Bloco Manobras (apenas para Guerreiro)
            if (classe === 'Guerreiro') {
                // Definir todas as manobras com requisitos e c√°lculos
                const manobras = [
                    {
                        nome: 'Postura Ofensiva',
                        calculo: 'Postura de Combate',
                        requisito: { tipo: 'atributo', nome: 'RAC', nivel: 3 },
                        descricao: 'Gaste 1 a√ß√£o para ativar/desativar. Aumenta seu ataque. N√£o tem rea√ß√£o enquanto estiver ativa.',
                        calcular: (char) => char.classAbilities?.['postura-combate'] || 0
                    },
                    {
                        nome: 'Postura Defensiva',
                        calculo: 'Rea√ß√£o + Postura de Combate',
                        requisito: { tipo: 'atributo', nome: 'PRS', nivel: 3 },
                        descricao: 'Aumenta sua Rea√ß√£o, mas limita a 1 a√ß√£o por turno e impede ataques.',
                        calcular: (char) => {
                            const agilidade = char.skills?.['agilidade'] || 0;
                            const reacao = Math.min(char.des, char.rac) + agilidade;
                            const postura = char.classAbilities?.['postura-combate'] || 0;
                            return reacao + postura;
                        }
                    },
                    {
                        nome: 'Investida',
                        calculo: '√çmpeto',
                        requisito: { tipo: 'custom', verificar: (char) => {
                            const agilidade = char.skills?.['agilidade'] || 0;
                            const deslocamento = char.for + char.des + char.tamanho + agilidade;
                            return deslocamento >= 15;
                        }, texto: 'Deslocamento Terrestre ‚â• 15' },
                        descricao: 'Usar ap√≥s uma a√ß√£o de movimento na dire√ß√£o do alvo. Avan√ßa contra o alvo com for√ßa brutal.',
                        calcular: (char) => char.classAbilities?.['impeto'] || 0
                    },
                    {
                        nome: 'Romper Defesa',
                        calculo: '√çmpeto',
                        requisito: { tipo: 'skill', nome: 'performance', nivel: 3 },
                        descricao: 'Ignora a Rea√ß√£o do alvo no ataque.',
                        calcular: (char) => char.classAbilities?.['impeto'] || 0
                    },
                    {
                        nome: 'Golpe Preciso',
                        calculo: 'Guerrilha',
                        requisito: { tipo: 'atributo', nome: 'DES', nivel: 4 },
                        descricao: 'Ignora a blindagem do inimigo.',
                        calcular: (char) => char.classAbilities?.['guerrilha'] || 0
                    },
                    {
                        nome: 'Golpe Girat√≥rio',
                        calculo: 'Controle + Postura de Combate',
                        requisito: { tipo: 'skill', nome: 'atletismo', nivel: 3 },
                        descricao: 'Ataca todos os alvos adjacentes. Usa a maior Rea√ß√£o e Blindagem entre eles, para subtrair no ataque.',
                        calcular: (char) => {
                            const controle = char.classAbilities?.['controle'] || 0;
                            const postura = char.classAbilities?.['postura-combate'] || 0;
                            return controle + postura;
                        }
                    },
                    {
                        nome: 'Avan√ßo T√°tico',
                        calculo: 'Nenhum b√¥nus (apenas ataque b√°sico)',
                        requisito: { tipo: 'class', nome: 'guerrilha', nivel: 4 },
                        descricao: 'Move metade do deslocamento e ataca com uma mesma a√ß√£o.',
                        calcular: (char) => 0
                    },
                    {
                        nome: 'Duelo Mortal',
                        calculo: 'Postura de Combate',
                        requisito: { tipo: 'skill', nome: 'intimida√ß√£o', nivel: 3 },
                        descricao: 'N√£o gasta Determina√ß√£o. O Alvo deve estar vivo e ser capaz de se defender. Declara um √∫nico inimigo, e ganha b√¥nus nos testes de ataque e defesa contra ele. N√£o pode atacar outros.',
                        calcular: (char) => char.classAbilities?.['postura-combate'] || 0
                    },
                    {
                        nome: 'Inspirar',
                        calculo: 'MAN + Lideran√ßa + Guerrilha',
                        requisito: { tipo: 'atributo', nome: 'PRE', nivel: 3 },
                        descricao: 'Gasta 2 a√ß√µes. Sucessos viram b√¥nus na primeira a√ß√£o de todos os aliados.',
                        calcular: (char) => {
                            const lideranca = char.skills?.['lideran√ßa'] || 0;
                            const guerrilha = char.classAbilities?.['guerrilha'] || 0;
                            return char.man + lideranca + guerrilha;
                        }
                    },
                    {
                        nome: 'Imobilizar',
                        calculo: 'FOR + Briga + Controle',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'O alvo testa pra resistir e o guerreiro para prender o inimigo. O Guerreiro s√≥ pode fazer 1 a√ß√£o.',
                        calcular: (char) => {
                            const briga = char.skills?.['briga'] || 0;
                            const controle = char.classAbilities?.['controle'] || 0;
                            return char.for + briga + controle;
                        }
                    },
                    {
                        nome: 'Atordoar',
                        calculo: 'Controle',
                        requisito: { tipo: 'atributo', nome: 'VIG', nivel: 3 },
                        descricao: 'Cada acerto remove 1 a√ß√£o do alvo. E a cada 2 acertos ele sofre 1 de dano.',
                        calcular: (char) => char.classAbilities?.['controle'] || 0
                    },
                    {
                        nome: 'C√≥lera',
                        calculo: 'V√°rios efeitos especiais',
                        requisito: { tipo: 'class', nome: 'impeto', nivel: 4 },
                        descricao: 'Se um aliado NPC cair: ative 1x. Se um jogador cair: ative pelo resto do combate.\n ‚Ä¢ Se matar um inimigo: recebe +1 a√ß√£o.\n ‚Ä¢ Se for atingido: causa o mesmo dano de volta.\n ‚Ä¢ Se o inimigo errar: ganha 1 a√ß√£o para ataque (com + √çmpeto) sem rea√ß√£o do inimigo.',
                        calcular: (char) => 0
                    }
                ];

                // Fun√ß√£o para verificar requisito
                const verificarRequisito = (req, char) => {
                    if (req.tipo === 'nenhum') return true;
                    if (req.tipo === 'atributo') {
                        const atributos = {
                            'FOR': char.for, 'DES': char.des, 'VIG': char.vig,
                            'RAC': char.rac, 'PRE': char.pre, 'PRS': char.prs,
                            'INT': char.int, 'MAN': char.man
                        };
                        return atributos[req.nome] >= req.nivel;
                    }
                    if (req.tipo === 'skill') {
                        return (char.skills?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'class') {
                        return (char.classAbilities?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'custom') {
                        return req.verificar(char);
                    }
                    return false;
                };

                // Filtrar manobras dispon√≠veis
                const manobrasDisponiveis = manobras.filter(m => verificarRequisito(m.requisito, char));
                const manobrasIndisponiveis = manobras.filter(m => !verificarRequisito(m.requisito, char));

                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title">‚öîÔ∏è Manobras</h2>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid var(--primary); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 10px;">
                                <strong>‚ÑπÔ∏è Regras:</strong><br>
                                ‚Ä¢ Todas custam 1 Determina√ß√£o<br>
                                ‚Ä¢ Pode usar 1 por turno (salvo indica√ß√£o contr√°ria)<br>
                                ‚Ä¢ Manobras em <span style="color: var(--success); font-weight: 700;">verde</span> = dispon√≠veis<br>
                                ‚Ä¢ Manobras em <span style="color: #64748b; font-weight: 700;">cinza</span> = requisitos n√£o atendidos
                            </p>
                        </div>
                `;

                // Manobras dispon√≠veis
                if (manobrasDisponiveis.length > 0) {
                    html += `<h3 style="color: var(--success); margin: 15px 0 10px 0; font-size: 1.1rem;">‚úÖ Manobras Dispon√≠veis</h3>`;
                    
                    manobrasDisponiveis.forEach(manobra => {
                        const valor = manobra.calcular(char);
                        const reqTexto = manobra.requisito.tipo === 'atributo' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'skill' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'class' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'custom' ? manobra.requisito.texto :
                                       'Nenhum';
                        
                        html += `
                            <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--success); padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--success); margin-bottom: 4px;">
                                            ‚öîÔ∏è ${manobra.nome}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #94a3b8;">
                                            <strong>Requer:</strong> ${reqTexto}
                                        </div>
                                    </div>
                                    ${valor > 0 ? `<div style="background: var(--success); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 900; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        +${valor}
                                    </div>` : ''}
                                </div>
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 6px;">
                                    <strong>C√°lculo:</strong> ${manobra.calculo}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem; line-height: 1.4;">
                                    ${manobra.descricao}
                                </div>
                            </div>
                        `;
                    });
                }

                // Manobras indispon√≠veis
                if (manobrasIndisponiveis.length > 0) {
                    html += `<h3 style="color: #64748b; margin: 20px 0 10px 0; font-size: 1.1rem;">üîí Manobras Bloqueadas</h3>`;
                    
                    manobrasIndisponiveis.forEach(manobra => {
                        const reqTexto = manobra.requisito.tipo === 'atributo' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'skill' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'class' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'custom' ? manobra.requisito.texto :
                                       'Nenhum';
                        
                        html += `
                            <div style="background: rgba(100, 116, 139, 0.1); border-left: 4px solid #64748b; padding: 15px; border-radius: 8px; margin-bottom: 12px; opacity: 0.6;">
                                <div style="font-size: 1rem; font-weight: 700; color: #64748b; margin-bottom: 4px;">
                                    üîí ${manobra.nome}
                                </div>
                                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px;">
                                    <strong>Requer:</strong> ${reqTexto}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    ${manobra.descricao}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
            }

            // Bloco Manobras (apenas para Ladino)
            if (classe === 'Ladino') {
                // Definir todas as manobras com requisitos e c√°lculos
                const manobras = [
                    {
                        nome: 'Acrobacia',
                        calculo: 'DES + Agilidade + Atletismo',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Gaste 2 a√ß√µes para usar. Manobra manual. Desloca-se por/atrav√©s de obst√°culos at√© o m√°ximo de Deslocamento Terrestre (sem provocar contra-ataques) e, ao fim, realiza 1 ataque com punhal. Com 5+ sucessos, ignora 1 ponto de Rea√ß√£o do alvo no ataque.',
                        calcular: (char) => {
                            const agilidade = char.skills?.['agilidade'] || 0;
                            const atletismo = char.skills?.['atletismo'] || 0;
                            return char.des + agilidade + atletismo;
                        }
                    },
                    {
                        nome: 'Golpe Pelas Costas',
                        calculo: 'DES + Arma + Punhal + Furtividade I e II + B.Arma (+Dano)',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Condi√ß√£o: estar furtivo. Ignora Blindagem e causa +1 dano para cada 2 sucessos. <strong>B.Arma:</strong> O valor √© adicionado no +Dano da arma.',
                        calcular: (char) => {
                            const arma = char.skills?.['arma'] || 0;
                            const punho = char.classAbilities?.['armas-punho'] || 0;
                            const furt = char.skills?.['furtividade'] || 0;
                            const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                            const bonus = char.weaponInfo?.bonus || 0;
                            return char.des + arma + punho + furt + furtII + bonus;
                        }
                    },
                    {
                        nome: 'Golpe Preciso',
                        calculo: 'DES + Punhal + Precis√£o',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Ignora a Blindagem do alvo neste ataque. <strong>Punhal:</strong> DES + Arma + Armas Punho.',
                        calcular: (char) => {
                            const arma = char.skills?.['arma'] || 0;
                            const punho = char.classAbilities?.['armas-punho'] || 0;
                            const precisao = char.classAbilities?.['precis√£o'] || 0;
                            return char.des + arma + punho + precisao;
                        }
                    },
                    {
                        nome: 'Troca De M√£os',
                        calculo: 'DES + Prestidigita√ß√£o vs Percep√ß√£o do alvo',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Gatilho (n√£o gasta determina√ß√£o): Ap√≥s acertar um ataque com punhal. Manobra manual. Executa Furto ou esconde um item como a√ß√£o gratuita no mesmo turno. Se o alvo vencer no teste disputado, ele pode escolher gastar 1 rea√ß√£o do turno para evitar a "Troca de M√£os" ou deixar acontecer.',
                        calcular: (char) => {
                            const presti = char.classAbilities?.['prestidigita√ß√£o'] || 0;
                            return char.des + presti;
                        }
                    },
                    {
                        nome: 'Retirada √Ågil',
                        calculo: 'DES + Agilidade',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Gatilho: ap√≥s atacar. Move at√© 3m sem provocar contra-ataques e sem reduzir Rea√ß√£o.',
                        calcular: (char) => {
                            const agilidade = char.skills?.['agilidade'] || 0;
                            return char.des + agilidade;
                        }
                    },
                    {
                        nome: 'Desarme',
                        calculo: 'DES + Arma + Precis√£o vs FOR + Briga do alvo',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Manobra manual. Se sucesso, o ladino desarma o alvo, retirando sua arma da sua m√£o; Com +3 sucessos, al√©m de desarmar ele pode tomar posse da arma alvo em suas m√£os; Com +5 sucessos, o ladino desarma e pode guardar em uma bolsa, em sua roupa ou arremessar at√© 3m sem que o alvo perceba onde foi sua arma.',
                        calcular: (char) => {
                            const arma = char.skills?.['arma'] || 0;
                            const precisao = char.classAbilities?.['precis√£o'] || 0;
                            return char.des + arma + precisao;
                        }
                    },
                    {
                        nome: 'Passos Sombrio',
                        calculo: 'DES + Furtividade I e Furtividade II vs Percep√ß√£o do alvo',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'Se vencer, o ladino faz um movimento de at√© metade do seu Deslocamento Terrestre, entrando em modo furtivo.',
                        calcular: (char) => {
                            const furt = char.skills?.['furtividade'] || 0;
                            const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                            return char.des + furt + furtII;
                        }
                    },
                    {
                        nome: 'Engodo',
                        calculo: 'MAN + Malandragem + Performance vs RAC + AUT',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'No pr√≥ximo ataque contra esse alvo, ignora Rea√ß√£o do alvo.',
                        calcular: (char) => {
                            const malan = char.skills?.['malandragem'] || 0;
                            const performance = char.skills?.['performance'] || 0;
                            return char.man + malan + performance;
                        }
                    },
                    {
                        nome: 'Sombra Acelerada',
                        calculo: 'Sem b√¥nus num√©rico',
                        requisito: { tipo: 'nenhum' },
                        descricao: 'No seu turno, pode abdicar da Rea√ß√£o para ganhar 1 a√ß√£o extra (movimento ou ataque). N√£o pode combinar com Ataque Total.',
                        calcular: (char) => 0
                    },
                    {
                        nome: 'Ataque Mudo',
                        calculo: 'DES + Arma + Punhal + Precis√£o + B.Arma (+Dano)',
                        requisito: { tipo: 'custom', verificar: (char) => {
                            const malan = char.skills?.['malandragem'] || 0;
                            const agilidade = char.skills?.['agilidade'] || 0;
                            return malan >= 2 && agilidade >= 2;
                        }, texto: 'Malandragem 2 e Agilidade 2' },
                        descricao: 'Custo: 2 Determina√ß√£o. Teste: (DES + Furtividade I e Furtividade II + Prestidigita√ß√£o vs Percep√ß√£o). Se vencer: este ataque ignora Rea√ß√£o e Blindagem e causa dano direto √† Vitalidade. <strong>B.Arma:</strong> O valor √© adicionado no +Dano da arma. <strong>Punhal:</strong> DES + Arma + Armas Punho. Limites: N√£o funciona contra construtos/elementais; 1√ó por cena no mesmo alvo.',
                        calcular: (char) => {
                            const arma = char.skills?.['arma'] || 0;
                            const punho = char.classAbilities?.['armas-punho'] || 0;
                            const precisao = char.classAbilities?.['precis√£o'] || 0;
                            const bonus = char.weaponInfo?.bonus || 0;
                            return char.des + arma + punho + precisao + bonus;
                        }
                    }
                ];

                // Fun√ß√£o para verificar requisito
                const verificarRequisito = (req, char) => {
                    if (req.tipo === 'nenhum') return true;
                    if (req.tipo === 'atributo') {
                        const atributos = {
                            'FOR': char.for, 'DES': char.des, 'VIG': char.vig,
                            'RAC': char.rac, 'PRE': char.pre, 'PRS': char.prs,
                            'INT': char.int, 'MAN': char.man
                        };
                        return atributos[req.nome] >= req.nivel;
                    }
                    if (req.tipo === 'skill') {
                        return (char.skills?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'class') {
                        return (char.classAbilities?.[req.nome] || 0) >= req.nivel;
                    }
                    if (req.tipo === 'custom') {
                        return req.verificar(char);
                    }
                    return false;
                };

                // Filtrar manobras dispon√≠veis
                const manobrasDisponiveis = manobras.filter(m => verificarRequisito(m.requisito, char));
                const manobrasIndisponiveis = manobras.filter(m => !verificarRequisito(m.requisito, char));

                html += `
                    <div class="section" style="margin-top: 20px;">
                        <h2 class="section-title">üó°Ô∏è Manobras</h2>
                        <div style="background: rgba(136, 8, 8, 0.1); border: 2px solid #880808; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                            <p style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 10px;">
                                <strong>‚ÑπÔ∏è Regras:</strong><br>
                                ‚Ä¢ Todas custam 1 Determina√ß√£o<br>
                                ‚Ä¢ Pode usar 1 por turno (salvo indica√ß√£o contr√°ria)<br>
                                ‚Ä¢ Manobras em <span style="color: #880808; font-weight: 700;">vermelho</span> = dispon√≠veis<br>
                                ‚Ä¢ Manobras em <span style="color: #64748b; font-weight: 700;">cinza</span> = requisitos n√£o atendidos
                            </p>
                        </div>
                `;

                // Manobras dispon√≠veis
                if (manobrasDisponiveis.length > 0) {
                    html += `<h3 style="color: #880808; margin: 15px 0 10px 0; font-size: 1.1rem;">‚úÖ Manobras Dispon√≠veis</h3>`;
                    
                    manobrasDisponiveis.forEach(manobra => {
                        const valor = manobra.calcular(char);
                        const reqTexto = manobra.requisito.tipo === 'atributo' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'skill' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'class' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'custom' ? manobra.requisito.texto :
                                       'Nenhum';
                        
                        html += `
                            <div style="background: rgba(136, 8, 8, 0.1); border-left: 4px solid #880808; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 700; color: #880808; margin-bottom: 4px;">
                                            üó°Ô∏è ${manobra.nome}
                                        </div>
                                        <div style="font-size: 0.75rem; color: #94a3b8;">
                                            <strong>Requer:</strong> ${reqTexto}
                                        </div>
                                    </div>
                                    ${valor > 0 ? `<div style="background: #880808; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 900; font-size: 1.2rem; box-shadow: 0 4px 12px rgba(136, 8, 8, 0.4);">
                                        +${valor}
                                    </div>` : ''}
                                </div>
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 6px;">
                                    <strong>C√°lculo:</strong> ${manobra.calculo}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem; line-height: 1.4;">
                                    ${manobra.descricao}
                                </div>
                            </div>
                        `;
                    });
                }

                // Manobras indispon√≠veis
                if (manobrasIndisponiveis.length > 0) {
                    html += `<h3 style="color: #64748b; margin: 20px 0 10px 0; font-size: 1.1rem;">üîí Manobras Bloqueadas</h3>`;
                    
                    manobrasIndisponiveis.forEach(manobra => {
                        const reqTexto = manobra.requisito.tipo === 'atributo' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'skill' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'class' ? `${manobra.requisito.nome} ${manobra.requisito.nivel}` :
                                       manobra.requisito.tipo === 'custom' ? manobra.requisito.texto :
                                       'Nenhum';
                        
                        html += `
                            <div style="background: rgba(100, 116, 139, 0.1); border-left: 4px solid #64748b; padding: 15px; border-radius: 8px; margin-bottom: 12px; opacity: 0.6;">
                                <div style="font-size: 1rem; font-weight: 700; color: #64748b; margin-bottom: 4px;">
                                    üîí ${manobra.nome}
                                </div>
                                <div style="font-size: 0.75rem; color: #94a3b8; margin-bottom: 8px;">
                                    <strong>Requer:</strong> ${reqTexto}
                                </div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">
                                    ${manobra.descricao}
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div>`;
            }

            html += `
                <div class="section">
                    <h2 class="section-title">‚ö° Testes R√°pidos</h2>
                    <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                        Valores calculados automaticamente com seus atributos e habilidades.
                    </p>
                    <div id="class-tests-container"></div>
                </div>
            `;
            
            // Se√ß√£o de Receitas (Ca√ßador e Druida)
            if (classe === 'Ca√ßador' || classe === 'Druida') {
                const tituloReceitas = classe === 'Ca√ßador' ? 'üß™ Receitas de Lo√ß√£o Ofensiva' : 'üß™ Receitas de Lo√ß√µes';
                html += `
                    <div class="section">
                        <h2 class="section-title">${tituloReceitas}</h2>
                        <button class="btn btn-primary" onclick="openRecipeModal()" style="margin-bottom: 15px;">
                            ‚ûï Adicionar Receita
                        </button>
                        <div id="recipes-list"></div>
                    </div>
                `;
            }

            // Se√ß√£o de Prece e Liturgia (Pallacerdote)
            if (classe === 'Pallacerdote') {
                html += `
                    <div class="section">
                        <h2 class="section-title" style="background: linear-gradient(135deg, #fbbf24, #fde047); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ‚ú® Prece e Liturgia
                        </h2>
                        <button class="btn btn-primary" onclick="openRitoModal()" 
                            style="margin-bottom: 15px; background: linear-gradient(135deg, #fbbf24, #fde047); border: 2px solid #fde047;">
                            ‚ûï Adicionar Rito
                        </button>
                        <div id="ritos-list"></div>
                    </div>
                `;
            }

            html += `
                <div class="section">
                    <h2 class="section-title">üìñ Informa√ß√µes da Classe</h2>
                    <div class="info-box">
                        ${classData.info}
                    </div>
                </div>
            `;

            classContent.innerHTML = html;

            // Atualizar lista de receitas se for Ca√ßador ou Druida
            if (classe === 'Ca√ßador' || classe === 'Druida') {
                updateRecipesList();
            }

            // Atualizar lista de ritos se for Pallacerdote
            if (classe === 'Pallacerdote') {
                updateRitosList();
            }
            
            classData.abilities.forEach(ability => {
                createClassAbilityDots(ability.id, ability.maxLevel);
            });
            
            updateClassTests();
            
            console.log('Classe renderizada com sucesso!');

            // Event listeners para Marca de Ca√ßa
            if (classe === 'Ca√ßador') {
                const alvoInput = document.getElementById('marca-alvo');
                const sobreTextarea = document.getElementById('marca-sobre');
                
                if (alvoInput) {
                    alvoInput.addEventListener('input', (e) => {
                        if (!char.marcaCaca) char.marcaCaca = {};
                        char.marcaCaca.alvo = e.target.value;
                        autoSave();
                    });
                }
                
                if (sobreTextarea) {
                    sobreTextarea.addEventListener('input', (e) => {
                        if (!char.marcaCaca) char.marcaCaca = {};
                        char.marcaCaca.sobre = e.target.value;
                        autoSave();
                    });
                }
            }

            // Event listener para C√≠rculo de Palla
            if (classe === 'Pallacerdote') {
                const circuloSelect = document.getElementById('circulo-palla-select');
                
                if (circuloSelect) {
                    circuloSelect.addEventListener('change', (e) => {
                        char.circuloPalla = e.target.value;
                        autoSave();
                        showAlert(`‚ú® C√≠rculo alterado para: ${e.target.value}`, 'success');
                    });
                }
            }
        }

        function setupEventListeners() {
            const inputs = {
                'nome': 'nome', 
                'jogador': 'jogador', 
                'idade': 'idade',
                'raca': 'raca', 
                'classe': 'classe', 
                'virtude': 'virtude',
                'vicio': 'vicio', 
                'tamanho': 'tamanho', 
                'luns': 'luns',
                'auraImortalidade': 'auraImortalidade'
            };
            
            Object.entries(inputs).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`‚ö†Ô∏è Campo ${id} n√£o encontrado no DOM`);
                    return;
                }
                
                // Listener para 'change' (blur, selects)
                el.addEventListener('change', (e) => {
                    try {
                        const char = getChar();
                        const oldValue = char[key];
                        
                        char[key] = ['idade', 'tamanho', 'luns'].includes(key) 
                            ? parseInt(e.target.value) || 0 
                            : e.target.value;
                        
                        console.log(`[CHANGE] ${key}: "${oldValue}" ‚Üí "${char[key]}"`);
                        
                        if (key === 'tamanho') {
                            try {
                                updateAllCalculations();
                            } catch (err) {
                                console.error('Erro ao atualizar c√°lculos:', err);
                                // Continua mesmo com erro
                            }
                        }
                        
                        if (key === 'classe') {
                            const newClasse = e.target.value;
                            
                            // Se j√° tinha uma classe bloqueada, n√£o deixa mudar
                            if (char.classeLocked && char.classe && char.classe !== newClasse) {
                                alert('‚ùå Voc√™ j√° escolheu sua classe e n√£o pode alter√°-la!');
                                e.target.value = char.classe; // Volta para a classe original
                                return;
                            }
                            
                            // Se selecionou uma classe v√°lida
                            if (newClasse && CLASS_ABILITIES[newClasse]) {
                                // Pergunta se tem certeza
                                const confirmacao = confirm(`‚ö†Ô∏è ATEN√á√ÉO! ‚ö†Ô∏è\n\nVoc√™ deseja escolher a classe: ${newClasse}?\n\nAp√≥s confirmar, voc√™ N√ÉO PODER√Å MAIS MUDAR sua classe!\n\nTem certeza?`);
                                
                                if (confirmacao) {
                                    // Confirma a escolha
                                    char.classe = newClasse;
                                    char.classeLocked = true; // Bloqueia a classe permanentemente
                                    
                                    // Renderiza o conte√∫do da classe na aba
                                    renderClassContent(newClasse);
                                    
                                    // Desabilita o select para n√£o permitir mudan√ßas
                                    e.target.disabled = true;
                                    e.target.style.opacity = '0.6';
                                    e.target.style.cursor = 'not-allowed';
                                    
                                    showAlert(`‚úÖ Classe ${newClasse} selecionada e bloqueada com sucesso!`, 'success');
                                    autoSave();
                                } else {
                                    // Se cancelou, volta para vazio ou mant√©m a classe anterior
                                    e.target.value = char.classe || '';
                                    return;
                                }
                            }
                        }
                        
                        // GARANTIR que salva mesmo se houver erro
                        autoSave();
                        
                    } catch (error) {
                        console.error(`‚ùå Erro ao processar mudan√ßa em ${key}:`, error);
                    }
                });
                
                // Listener para 'input' (digita√ß√£o em tempo real)
                if (el.type === 'text' || el.type === 'number') {
                    el.addEventListener('input', (e) => {
                        try {
                            const char = getChar();
                            
                            char[key] = ['idade', 'tamanho', 'luns'].includes(key) 
                                ? parseInt(e.target.value) || 0 
                                : e.target.value;
                            
                            console.log(`[INPUT] ${key} = "${char[key]}"`);
                            
                            if (key === 'tamanho') {
                                try {
                                    updateAllCalculations();
                                } catch (err) {
                                    console.error('Erro ao atualizar c√°lculos:', err);
                                    // Continua mesmo com erro
                                }
                            }
                            
                            // GARANTIR que salva mesmo se houver erro
                            autoSave();
                            
                        } catch (error) {
                            console.error(`‚ùå Erro ao processar input em ${key}:`, error);
                        }
                    });
                }
            });

            // Listener para notas
            const notasTextarea = document.getElementById('notas-textarea');
            if (notasTextarea) {
                notasTextarea.addEventListener('input', (e) => {
                    try {
                        const char = getChar();
                        char.notas = e.target.value;
                        console.log('[INPUT] Notas atualizadas');
                        autoSave();
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar notas:', error);
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Textarea de notas n√£o encontrado');
            }
            
            console.log('‚úÖ Event listeners configurados com sucesso');
        }

        // ============= FIX: ADICIONAR INPUT LISTENERS PARA CAMPOS DE TEXTO =============
        // Adiciona event listener 'input' para campos de texto salvarem enquanto digita
        function setupInputListeners() {
            const textFields = ['nome', 'jogador'];
            
            textFields.forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (el) {
                    el.addEventListener('input', (e) => {
                        const char = getChar();
                        char[fieldId] = e.target.value;
                        console.log(`[INPUT] ${fieldId} atualizado:`, e.target.value);
                        autoSave();
                    });
                }
            });
        }

        // ============= SISTEMA DE UPLOAD DE IMAGEM =============

        // Event listener para upload de imagem
        document.getElementById('characterImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Verificar tamanho (m√°x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('‚ùå Imagem muito grande! M√°ximo 2MB.', 'danger');
                e.target.value = '';
                return;
            }

            // Verificar tipo
            if (!file.type.startsWith('image/')) {
                showAlert('‚ùå Por favor, selecione uma imagem v√°lida.', 'danger');
                e.target.value = '';
                return;
            }

            // Ler e converter para base64
            const reader = new FileReader();
            reader.onload = function(event) {
                const char = getChar();
                char.characterImage = event.target.result;
                updateCharacterImageDisplay();
                autoSave();
                showAlert('‚úÖ Imagem carregada!', 'success');
            };
            reader.onerror = function() {
                showAlert('‚ùå Erro ao carregar imagem.', 'danger');
                e.target.value = '';
            };
            reader.readAsDataURL(file);
        });

        // Fun√ß√£o para exibir imagem do personagem
        function updateCharacterImageDisplay() {
            const char = getChar();
            const preview = document.getElementById('characterImagePreview');
            const removeBtn = document.getElementById('removeImageBtn');

            if (char.characterImage) {
                preview.innerHTML = `<img src="${char.characterImage}" alt="Personagem">`;
                removeBtn.style.display = 'inline-block';
            } else {
                preview.innerHTML = '<div class="character-image-placeholder">üé≠</div>';
                removeBtn.style.display = 'none';
            }
        }

        // Fun√ß√£o para remover imagem
        window.removeCharacterImage = function() {
            if (confirm('‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover imagem do personagem? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è')) {
                const char = getChar();
                char.characterImage = '';
                updateCharacterImageDisplay();
                document.getElementById('characterImageInput').value = '';
                autoSave();
                showAlert('üóëÔ∏è Imagem removida.', 'success');
            }
        };

        let autoSaveTimeout;
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            
            autoSaveTimeout = setTimeout(() => {
                try {
                    if (window.saveToFirebase) {
                        console.log('üíæ Salvando dados...');
                        window.saveToFirebase();
                    } else {
                        console.warn('‚ö†Ô∏è Fun√ß√£o saveToFirebase n√£o dispon√≠vel');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar:', error);
                    // Mostrar alerta visual para o usu√°rio
                    const indicator = document.getElementById('autosaveIndicator');
                    if (indicator) {
                        indicator.textContent = '‚ùå Erro ao salvar!';
                        indicator.classList.add('show', 'error');
                        indicator.classList.remove('saving');
                        
                        setTimeout(() => {
                            indicator.classList.remove('show');
                        }, 3000);
                    }
                }
            }, 1000);
        }

        function createAttributeDots(attrName, maxDots) {
            const container = document.getElementById(`dots-${attrName}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const char = getChar();
            for (let i = 1; i <= maxDots; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (i <= char[attrName]) dot.classList.add('filled');
                
                dot.addEventListener('click', () => {
                    upgradeAttribute(attrName, i);
                });
                
                container.appendChild(dot);
            }
        }

        function updateAttributeDots(attrName) {
            const char = getChar();
            const dots = document.querySelectorAll(`#dots-${attrName} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < char[attrName]);
            });
        }


        function upgradeClassAbility(abilityId, targetLevel) {
            const char = getChar();
            const currentLevel = char.classAbilities[abilityId] || 0;
            
            // Se est√° diminuindo, permite sem custo
            if (targetLevel < currentLevel) {
                if (confirm(`‚ö†Ô∏è Tem certeza que deseja DIMINUIR esta habilidade de ${currentLevel} para ${targetLevel}?`)) {
                    char.classAbilities[abilityId] = targetLevel;
                    updateClassAbilityDots(abilityId);
                    updateClassTests();
                    updateClassResourcesDisplay();
                    updateAllCalculations();
                    autoSave();
                }
                return;
            }
            
            // Se est√° no mesmo n√≠vel, ignora
            if (targetLevel === currentLevel) return;
            
            // Determinar multiplicador baseado na classe
            const classe = char.classe;
            let multiplier = 2; // Padr√£o
            if (classe === 'Pallacerdote' || classe === 'Ritualista (Abismancia)') {
                multiplier = 4;
            }
            
            // Calcular custo total
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * multiplier;
            }
            
            // Verificar EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa de: ${totalCost} EXP\nVoc√™ tem: ${currentEXP} EXP\nFaltam: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            // Confirmar
            const levelDiff = targetLevel - currentLevel;
            const abilityName = abilityId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const message = levelDiff === 1 
                ? `Deseja aumentar ${abilityName} de ${currentLevel} para ${targetLevel}?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`
                : `Deseja aumentar ${abilityName} de ${currentLevel} para ${targetLevel} (+${levelDiff} n√≠veis)?\n\nCusto total: ${totalCost} EXP (√ó${multiplier})`;
            
            if (confirm(message)) {
                char.classAbilities[abilityId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateClassAbilityDots(abilityId);
                updateClassTests();
                updateClassResourcesDisplay();
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${abilityName} aumentado para ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }

        function createClassAbilityDots(abilityId, maxLevel) {
            const container = document.getElementById(`dots-class-${abilityId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const char = getChar();
            for (let i = 1; i <= maxLevel; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (i <= (char.classAbilities[abilityId] || 0)) {
                    dot.classList.add('filled');
                }
                
                dot.addEventListener('click', () => {
                    upgradeClassAbility(abilityId, i);
                });
                
                container.appendChild(dot);
            }
        }

        function updateClassAbilityDots(abilityId) {
            const char = getChar();
            const dots = document.querySelectorAll(`#dots-class-${abilityId} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < (char.classAbilities[abilityId] || 0));
            });
        }


        function upgradeSkill(skillId, targetLevel, skillDiv) {
            const char = getChar();
            const currentLevel = char.skills[skillId] || 0;
            
            // Se est√° diminuindo, permite sem custo
            if (targetLevel < currentLevel) {
                if (confirm(`‚ö†Ô∏è Tem certeza que deseja DIMINUIR esta habilidade de ${currentLevel} para ${targetLevel}?`)) {
                    char.skills[skillId] = targetLevel;
                    updateSkillDots(skillId);
                    skillDiv.classList.toggle('inapto', targetLevel === 0);
                    updateAllCalculations();
                    updateClassTests();
                    autoSave();
                }
                return;
            }
            
            // Se est√° no mesmo n√≠vel, ignora
            if (targetLevel === currentLevel) return;
            
            // Calcular custo total
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 4;
            }
            
            // Verificar EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa de: ${totalCost} EXP\nVoc√™ tem: ${currentEXP} EXP\nFaltam: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            // Confirmar
            const levelDiff = targetLevel - currentLevel;
            const skillName = skillId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const message = levelDiff === 1 
                ? `Deseja aumentar ${skillName} de ${currentLevel} para ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Deseja aumentar ${skillName} de ${currentLevel} para ${targetLevel} (+${levelDiff} n√≠veis)?\n\nCusto total: ${totalCost} EXP`;
            
            if (confirm(message)) {
                char.skills[skillId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateSkillDots(skillId);
                skillDiv.classList.toggle('inapto', targetLevel === 0);
                updateAllCalculations();
                updateClassTests();
                updateEXPDisplay();
                showAlert(`‚úÖ ${skillName} aumentado para ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }

        function createSkills() {
            const char = getChar();
            Object.keys(SKILLS).forEach(category => {
                const container = document.getElementById(`skills-${category}`);
                if (!container) return;
                
                SKILLS[category].forEach(skill => {
                    const skillId = skill.name.toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
                    if (!char.skills[skillId]) char.skills[skillId] = 0;
                    if (!char.skillInputs[skillId]) char.skillInputs[skillId] = '';
                    
                    const skillDiv = document.createElement('div');
                    skillDiv.className = 'skill-item';
                    if (char.skills[skillId] === 0) skillDiv.classList.add('inapto');
                    
                    skillDiv.innerHTML = `
                        <div class="skill-header">
                            <div class="skill-info">
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-attrs">${skill.attr}</div>
                            </div>
                            <div class="dots" id="skill-${skillId}"></div>
                        </div>
                        <input type="text" class="skill-input" id="input-${skillId}" placeholder="Ex: ${skill.placeholder || 'Especialidade...'}" value="${char.skillInputs[skillId] || ''}" style="margin-top: 8px;">
                    `;
                    
                    container.appendChild(skillDiv);
                    
                    const inputEl = skillDiv.querySelector(`#input-${skillId}`);
                    if (inputEl) {
                        inputEl.addEventListener('change', (e) => {
                            char.skillInputs[skillId] = e.target.value;
                            autoSave();
                        });
                    }
                    
                    const dotsContainer = skillDiv.querySelector('.dots');
                    for (let i = 1; i <= 5; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        if (i <= char.skills[skillId]) dot.classList.add('filled');
                        
                        dot.addEventListener('click', () => {
                            upgradeSkill(skillId, i, skillDiv);
                        });
                        
                        dotsContainer.appendChild(dot);
                    }
                });
            });
        }

        function updateSkillDots(skillId) {
            const char = getChar();
            const dots = document.querySelectorAll(`#skill-${skillId} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < char.skills[skillId]);
            });
        }

        function calculateCP() {
            const char = getChar();
            const agilidade = char.skills['agilidade'] || 0;
            
            // OF (Ofensa) - Maior Parada de Ataque
            const arma = char.skills['arma'] || 0;
            const disparo = char.skills['disparo'] || 0;
            const briga = char.skills['briga'] || 0;
            
            // Considerar tamb√©m habilidades de classe para armas
            let bonusArma = 0;
            if (char.classAbilities) {
                const weaponSkills = ['armas-haste', 'armas-pesadas', 'armas-uma-mao', 'armas-duas-maos', 'armas-duplas', 'armas-arremessaveis', 'armas-punho'];
                weaponSkills.forEach(skill => {
                    const val = char.classAbilities[skill] || 0;
                    if (val > bonusArma) bonusArma = val;
                });
            }
            
            const paradaArma = Math.max(char.for, char.des) + arma + bonusArma;
            const paradaDisparo = char.des + disparo + (char.classAbilities?.['precis√£o'] || 0);
            const paradaBriga = char.for + briga;
            
            const PMA = Math.max(paradaArma, paradaDisparo, paradaBriga);
            const OF = Math.ceil(PMA / 3);
            
            // DF (Defesa)
            const REA = Math.min(char.des, char.rac + agilidade);
            const BL = char.blindagem || 0;
            const DF = Math.ceil((REA + BL) / 3);
            
            // RS (Resist√™ncia/Sustenta√ß√£o)
            const VIT = char.vig + char.tamanho;
            const DET = char.prs + char.aut;
            const RS = Math.ceil((VIT + Math.floor(DET / 2)) / 3);
            
            // MB (Mobilidade)
            const DESL = char.for + char.des + char.tamanho + agilidade;
            const MB = Math.ceil(DESL / 6);
            
            // CP Final
            const AI = char.auraImortalidade || 1;
            const cpBase = Math.ceil(2 * OF + DF + RS + MB);
            const CP = cpBase * AI;
            
            // Determinar Letra e Nome
            let letra = 'E';
            let nome = 'CIVIL/NOVATO';
            let corLetra = '#94a3b8';
            
            if (CP >= 301) { 
                letra = 'ULTRA'; 
                nome = 'ULTRALIAL'; 
                corLetra = '#ff00ff'; 
            }
            else if (CP >= 151) { 
                letra = 'OP+'; 
                nome = 'SOBERANO'; 
                corLetra = '#ff0080'; 
            }
            else if (CP >= 91) { 
                letra = 'OP'; 
                nome = 'LEND√ÅRIO'; 
                corLetra = '#ff0000'; 
            }
            else if (CP >= 71) { 
                letra = 'M+'; 
                nome = 'CRONAL'; 
                corLetra = '#ff6600'; 
            }
            else if (CP >= 51) { 
                letra = 'M'; 
                nome = 'DIVINO'; 
                corLetra = '#ff9900'; 
            }
            else if (CP >= 36) { 
                letra = 'SS'; 
                nome = '√âPICO'; 
                corLetra = '#ffcc00'; 
            }
            else if (CP >= 29) { 
                letra = 'S+'; 
                nome = 'MITO'; 
                corLetra = '#ffff00'; 
            }
            else if (CP >= 23) { 
                letra = 'S'; 
                nome = 'LEGADO'; 
                corLetra = '#00ff00'; 
            }
            else if (CP >= 19) { 
                letra = 'A'; 
                nome = 'CAMPE√ÉO'; 
                corLetra = '#00ffff'; 
            }
            else if (CP >= 15) { 
                letra = 'B'; 
                nome = 'ELITE'; 
                corLetra = '#0099ff'; 
            }
            else if (CP >= 12) { 
                letra = 'C'; 
                nome = 'VETERANO'; 
                corLetra = '#0066ff'; 
            }
            else if (CP >= 9) { 
                letra = 'D'; 
                nome = 'SOLDADO COMUM'; 
                corLetra = '#6666ff'; 
            }
            
            return { CP, letra, nome, corLetra, OF, DF, RS, MB, AI };
        }

        function getResourceMax(resource) {
            const char = getChar();
            if (typeof resource.max === 'number') {
                return resource.max;
            } else if (resource.max === 'calc-fantoches') {
                const lideranca = char.skills['lideran√ßa'] || 0;
                const servos = char.classAbilities['servos'] || 0;
                return char.int + lideranca + servos;
            } else {
                return char.classAbilities[resource.max] || 0;
            }
        }

        function updateClassTests() {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const container = document.getElementById('class-tests-container');
            if (!container) return;
            
            const classData = CLASS_ABILITIES[classe];
            let html = '';
            
            classData.quickTests.forEach(test => {
                const result = test.calculate(char);
                
                html += `
                    <div class="test-card">
                        <div class="test-name">${test.name}</div>
                        <div class="test-formula">${test.formula}</div>
                        <div class="test-result">${result} dados</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateClassResourcesDisplay() {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            if (!classData.resources) return;
            
            classData.resources.forEach(resource => {
                const maxValue = getResourceMax(resource);
                const displayEl = document.getElementById(`resource-${resource.id}`);
                const inputEl = document.getElementById(`resource-input-${resource.id}`);
                
                if (displayEl) {
                    displayEl.textContent = `${char.classResources[resource.id]} / ${maxValue}`;
                }
                if (inputEl) {
                    inputEl.max = maxValue;
                    if (char.classResources[resource.id] > maxValue) {
                        char.classResources[resource.id] = maxValue;
                        inputEl.value = maxValue;
                    }
                }
            });
        }

        window.adjustResource = function(resourceId, amount) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = Math.max(0, Math.min(
                (char.classResources[resourceId] || 0) + amount,
                max
            ));
            updateResourceDisplay(resourceId);
            autoSave();
        };

        window.setResource = function(resourceId, value) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = Math.max(0, Math.min(parseInt(value) || 0, max));
            updateResourceDisplay(resourceId);
            autoSave();
        };

        window.resetResource = function(resourceId) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = max;
            updateResourceDisplay(resourceId);
            autoSave();
        };

        function updateResourceDisplay(resourceId) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            const displayEl = document.getElementById(`resource-${resource.id}`);
            const inputEl = document.getElementById(`resource-input-${resource.id}`);
            
            if (displayEl) {
                displayEl.textContent = `${char.classResources[resourceId]} / ${max}`;
            }
            if (inputEl) {
                inputEl.value = char.classResources[resourceId];
                inputEl.max = max;
            }
        }

        function updateAllCalculations() {
            try {
                const char = getChar();
                const agilidade = char.skills['agilidade'] || 0;
                const abismo = char.skills['abismo'] || 0;
                
                // Fun√ß√£o auxiliar para atualizar elemento com seguran√ßa
                const safeUpdate = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    } else {
                        console.warn(`‚ö†Ô∏è Elemento ${id} n√£o encontrado`);
                    }
                };
                
                // Atualizar c√°lculos com prote√ß√£o
                safeUpdate('calc-iniciativa', char.rac + char.des + char.aut + agilidade - char.tamanho);
                safeUpdate('calc-reacao', Math.min(char.des, char.rac) + agilidade);
                safeUpdate('calc-deslocamento', (char.for + char.des + char.tamanho + agilidade) + 'm');
                
                const vitalidadeMax = char.vig + char.tamanho;
                safeUpdate('calc-vitalidade-max', vitalidadeMax);
                
                const determinacaoMax = char.prs + char.aut;
                safeUpdate('calc-determinacao-max', determinacaoMax);
                
                const cargaMax = char.for + char.vig;
                safeUpdate('calc-carga', cargaMax);
                
                safeUpdate('calc-sanidade', char.sanCurrent || 80);
                
                safeUpdate('calc-blindagem', char.blindagem);

                const cpData = calculateCP();
                safeUpdate('calc-cp', cpData.CP);
                
                const cpLetraEl = document.getElementById('calc-cp-letra');
                if (cpLetraEl) {
                    cpLetraEl.textContent = cpData.letra;
                    cpLetraEl.style.color = cpData.corLetra;
                }
                
                const cpNomeEl = document.getElementById('calc-cp-nome');
                if (cpNomeEl) {
                    cpNomeEl.textContent = cpData.nome;
                    cpNomeEl.style.color = cpData.corLetra;
                }
                
                // Ajustar valores atuais se necess√°rio
                if (!char.hpCurrent || char.hpCurrent > vitalidadeMax) {
                    char.hpCurrent = vitalidadeMax;
                }
                if (!char.detCurrent || char.detCurrent > determinacaoMax) {
                    char.detCurrent = determinacaoMax;
                }
                if (!char.sanCurrent) {
                    char.sanCurrent = 80;
                }
                if (char.sanCurrent > 100) {
                    char.sanCurrent = 100;
                }
                
                // Atualizar barras
                updateHPBar();
                updateDETBar();
                updateSANBar();
                
                // Atualizar displays
                const expDisplay = document.getElementById('exp-display');
                if (expDisplay) {
                    expDisplay.textContent = char.exp || 0;
                }
                
                // Atualizar testes da classe e recursos
                updateClassTests();
                updateClassResourcesDisplay();
                
                console.log('‚úÖ C√°lculos atualizados com sucesso');
            
                // Atualizar capacidade e tamanho do container Equipados
                const equipados = char.containers?.find(c => c.name === 'Equipados');
                if (equipados) {
                    const atletismo = char.skills['atletismo'] || 1;
                    const vig = char.vig || 1;
                    const forca = char.for || 1;
                    
                    equipados.maxCapacity = forca + vig
                    equipados.maxSize = forca * vig * atletismo;
                    
                    console.log(`üì¶ Equipados atualizado: maxSize = ${forca} √ó ${vig}${atletismo > 0 ? ` √ó ${atletismo}` : ''} = ${equipados.maxSize}`);
                    
                    // Salvar container atualizado
                    const characterId = window.currentCharacterId || (window.currentUser || currentUser)?.uid;
                    if (characterId && (window.currentUser || currentUser)) {
                        equipados.characterId = characterId;  // Garantir que tem characterId
                        equipados.ownerId = (window.currentUser || currentUser)?.uid;  // Garantir que tem ownerId
                        window.saveContainerToFirebase(equipados).catch(err => 
                            console.error('Erro ao atualizar Equipados:', err)
                        );
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Erro em updateAllCalculations:', error);
                // N√ÉO impedir o salvamento mesmo se houver erro aqui
            }
        }

        window.updateHPBar = function() {
            const char = getChar();
            const max = char.vig + char.tamanho;
            const current = parseInt(document.getElementById('hp-current').value) || 0;
            char.hpCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('hp-current').value = char.hpCurrent;
            const percent = (char.hpCurrent / max) * 100;
            document.getElementById('hp-fill').style.width = percent + '%';
            document.getElementById('hp-text').textContent = `${char.hpCurrent} / ${max}`;
            autoSave();
        };

        window.adjustHP = function(amount) {
            const char = getChar();
            const max = char.vig + char.tamanho;
            char.hpCurrent = Math.max(0, Math.min(char.hpCurrent + amount, max));
            document.getElementById('hp-current').value = char.hpCurrent;
            updateHPBar();
        };

        window.resetHP = function() {
            const char = getChar();
            const max = char.vig + char.tamanho;
            char.hpCurrent = max;
            document.getElementById('hp-current').value = char.hpCurrent;
            updateHPBar();
        };

        window.updateDETBar = function() {
            const char = getChar();
            const max = char.prs + char.aut;
            const current = parseInt(document.getElementById('det-current').value) || 0;
            char.detCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('det-current').value = char.detCurrent;
            const percent = (char.detCurrent / max) * 100;
            document.getElementById('det-fill').style.width = percent + '%';
            document.getElementById('det-text').textContent = `${char.detCurrent} / ${max}`;
            autoSave();
        };

        window.adjustDET = function(amount) {
            const char = getChar();
            const max = char.prs + char.aut;
            char.detCurrent = Math.max(0, Math.min(char.detCurrent + amount, max));
            document.getElementById('det-current').value = char.detCurrent;
            updateDETBar();
        };

        window.resetDET = function() {
            const char = getChar();
            const max = char.prs + char.aut;
            char.detCurrent = max;
            document.getElementById('det-current').value = char.detCurrent;
            updateDETBar();
        };

        window.updateSANBar = function() {
            const char = getChar();
            const max = 100; // ‚Üê FIXO EM 100
            const current = parseInt(document.getElementById('san-current').value) || 0;
            char.sanCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('san-current').value = char.sanCurrent;
            const percent = (char.sanCurrent / max) * 100;
            document.getElementById('san-fill').style.width = percent + '%';
            document.getElementById('san-text').textContent = `${char.sanCurrent} / ${max}`;
            
            // ADICIONAR: Atualizar exibi√ß√£o na aba Caracter√≠sticas
            const sanExibicao = document.getElementById('calc-sanidade');
            if (sanExibicao) {
                sanExibicao.textContent = char.sanCurrent;
            }
            
            autoSave();
        };

        window.adjustSAN = function(amount) {
            const char = getChar();
            const max = 100; // ‚Üê FIXO EM 100
            char.sanCurrent = Math.max(0, Math.min(char.sanCurrent + amount, max));
            document.getElementById('san-current').value = char.sanCurrent;
            updateSANBar();
        };

        window.resetSAN = function() {
            const char = getChar();
            const max = 100; // ‚Üê FIXO EM 100
            char.sanCurrent = max;
            document.getElementById('san-current').value = char.sanCurrent;
            updateSANBar();
        };

        // Fun√ß√µes para Fantoches (Adepto)
        window.updateFantochesBar = function() {
            const char = getChar();
            const lideranca = char.skills?.['lideran√ßa'] || 0;
            const servos = char.classAbilities?.['servos'] || 0;
            const max = char.int + lideranca + servos;
            const current = parseInt(document.getElementById('fantoches-current')?.value) || 0;
            
            char.fantochesAtivos = Math.max(0, Math.min(current, max));
            
            const fantochesInput = document.getElementById('fantoches-current');
            if (fantochesInput) {
                fantochesInput.value = char.fantochesAtivos;
            }
            
            const percent = max > 0 ? (char.fantochesAtivos / max) * 100 : 0;
            
            const fantochesFill = document.getElementById('fantoches-fill');
            if (fantochesFill) {
                fantochesFill.style.width = percent + '%';
            }
            
            const fantochesText = document.getElementById('fantoches-text');
            if (fantochesText) {
                fantochesText.textContent = `${char.fantochesAtivos} / ${max}`;
            }
            
            // Atualizar exibi√ß√£o na aba Classe
            updateServosFantochesDisplay();
            
            autoSave();
        };

        window.adjustFantoches = function(amount) {
            const char = getChar();
            const lideranca = char.skills?.['lideran√ßa'] || 0;
            const servos = char.classAbilities?.['servos'] || 0;
            const max = char.int + lideranca + servos;
            
            char.fantochesAtivos = Math.max(0, Math.min((char.fantochesAtivos || 0) + amount, max));
            
            const fantochesInput = document.getElementById('fantoches-current');
            if (fantochesInput) {
                fantochesInput.value = char.fantochesAtivos;
            }
            
            updateFantochesBar();
        };

        window.resetFantoches = function() {
            adjustFantoches(9999); // Define para o m√°ximo
        };

        // Fun√ß√£o para atualizar exibi√ß√£o de Servos e Fantoches na aba Classe
        window.updateServosFantochesDisplay = function() {
            const char = getChar();
            
            // Calcular m√°ximos
            const maxServos = char.classAbilities?.['servos'] || 0;
            const lideranca = char.skills?.['lideran√ßa'] || 0;
            const servos = char.classAbilities?.['servos'] || 0;
            const maxFantoches = char.int + lideranca + servos;
            
            // Contar servos atuais (aliados com fun√ß√£o 'Servo Zumbi')
            const servosAtuais = (char.allies || []).filter(ally => 
                (ally.funcao || '').toLowerCase().includes('servo zumbi')
            ).length;
            
            // Fantoches atuais
            const fantochesAtuais = char.fantochesAtivos || 0;
            
            // Atualizar display de Servos
            const servosAtual = document.getElementById('servos-atual');
            const servosMax = document.getElementById('servos-max');
            if (servosAtual) servosAtual.textContent = servosAtuais;
            if (servosMax) servosMax.textContent = maxServos;
            
            // Atualizar display de Fantoches
            const fantochesAtual = document.getElementById('fantoches-atual');
            const fantochesMax = document.getElementById('fantoches-max');
            if (fantochesAtual) fantochesAtual.textContent = fantochesAtuais;
            if (fantochesMax) fantochesMax.textContent = maxFantoches;
            
            // Atualizar barra de progresso de Servos
            const servosPercent = maxServos > 0 ? (servosAtuais / maxServos) * 100 : 0;
            const servosFill = document.getElementById('servos-fill');
            if (servosFill) {
                servosFill.style.width = servosPercent + '%';
            }
            
            // Atualizar barra de progresso de Fantoches
            const fantochesPercent = maxFantoches > 0 ? (fantochesAtuais / maxFantoches) * 100 : 0;
            const fantochesClasseFill = document.getElementById('fantoches-classe-fill');
            if (fantochesClasseFill) {
                fantochesClasseFill.style.width = fantochesPercent + '%';
            }
        };

        window.rollDice = function() {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            let results = [];
            let successes = 0;
            let failures = 0;
            
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * 10) + 1;
                results.push(roll);
                
                if (roll === 1) {
                    failures++;
                } else if (roll >= 8) {
                    successes++;
                    
                    if (roll === 10) {
                        let explode = roll;
                        while (explode === 10) {
                            explode = Math.floor(Math.random() * 10) + 1;
                            results.push(explode);
                            if (explode >= 8) successes++;
                        }
                    }
                }
            }
            
            const netSuccesses = successes - failures;
            
            document.getElementById('roll-result').textContent = netSuccesses;
            document.getElementById('roll-details').innerHTML = `
                <strong>Dados:</strong> ${results.join(', ')}<br>
                <strong>Sucessos:</strong> ${successes} | <strong>Falhas:</strong> ${failures}<br>
                <strong>Total:</strong> ${netSuccesses}
            `;
        };


        function updateEXPDisplay() {
            const char = getChar();
            const expDisplay = document.getElementById('exp-display');
            if (expDisplay) {
                expDisplay.textContent = char.exp || 0;
            }
        }

        function updateLunsDisplay() {
            const char = getChar();
            const lunsDisplay = document.getElementById('luns-display');
            const lunsHidden = document.getElementById('luns');
            
            // Calcular riqueza total baseada nos itens tipo Lunis
            let totalLuns = 0;
            
            if (char.containers) {
                char.containers.forEach(container => {
                    if (container.items) {
                        container.items.forEach(item => {
                            if (item.tipo === 'Lunis' && item.tipoLun) {
                                const quantity = item.quantity || 0;
                                
                                if (item.tipoLun === 'Lunis') {
                                    totalLuns += quantity;
                                } else if (item.tipoLun === "Ka'Lunis") {
                                    totalLuns += quantity * 1000;
                                } else if (item.tipoLun === "Mi'Lunis") {
                                    totalLuns += quantity * 1000000;
                                }
                            }
                        });
                    }
                });
            }
            
            // Atualizar display
            if (lunsDisplay) {
                lunsDisplay.textContent = totalLuns.toLocaleString('pt-BR');
            }
            
            // Atualizar campo oculto para compatibilidade
            if (lunsHidden) {
                lunsHidden.value = totalLuns;
            }
            
            // Salvar no personagem
            char.luns = totalLuns;
        }

        // ============= FUN√á√ïES DE CONDI√á√ïES =============
        window.addCondition = function() {
            const char = getChar();
            const name = prompt('Nome da Condi√ß√£o (ex: Fadiga, Fratura, Envenenado):');
            if (!name) return;
            
            const description = prompt('Descri√ß√£o da Condi√ß√£o (efeitos mec√¢nicos):') || '';
            
            if (!char.conditions) char.conditions = [];
            
            const newCondition = {
                id: Date.now(),
                name,
                description
            };
            
            char.conditions.push(newCondition);
            updateConditions();
            autoSave();
        };

        window.removeCondition = function(conditionId) {
            if (!confirm('‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover esta condi√ß√£o? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è')) return;
            
            const char = getChar();
            if (!char.conditions) char.conditions = [];
            char.conditions = char.conditions.filter(c => c.id !== conditionId);
            updateConditions();
            autoSave();
        };

        function updateConditions() {
            const char = getChar();
            if (!char.conditions) char.conditions = [];
            
            const conditionsList = document.getElementById('conditions-list');
            if (!conditionsList) return;
            
            if (char.conditions.length === 0) {
                conditionsList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhuma condi√ß√£o ativa. Seu personagem est√° saud√°vel!</p>';
                return;
            }
            
            conditionsList.innerHTML = char.conditions.map(condition => `
                <div class="container-card" style="border-left: 4px solid var(--warning);">
                    <div class="container-header">
                        <div class="container-name">‚ö†Ô∏è ${condition.name}</div>
                    </div>
                    <div style="padding: 10px; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px;">
                        ${condition.description || 'Sem descri√ß√£o'}
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeCondition(${condition.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        window.addContainer = async function() {
            const char = getChar();
            const name = prompt('Nome do container (ex: Mochila, Bolsa, Carro√ßa):');
            if (!name) return;
            
            if (name === 'Equipados') {
                alert('‚ùå Esse nome √© reservado!');
                return;
            }
            
            const maxCapacity = parseInt(prompt('Capacidade m√°xima de carga:')) || 10;
            const containerWeight = parseFloat(prompt('Peso do container vazio:')) || 1;
            const tamanhoContainer = parseInt(prompt('Tamanho do container (1-10):')) || 3;
            const description = prompt('Descri√ß√£o (opcional):') || '';
            const dureza = parseInt(prompt('Dureza (0-10):')) || 0;
            const integridade = parseInt(prompt('Integridade:')) || 10;
            
            try {
                const characterId = currentCharacterId || currentUser.uid;
                const containerId = 'container-' + Date.now();
                
                // Criar novo container
                const newContainer = {
                    id: containerId,
                    name,
                    ownerId: currentUser.uid, // ‚úÖ Usar uid do usu√°rio autenticado
                    characterId: characterId, // Vincular ao personagem
                    maxCapacity,
                    maxSize: tamanhoContainer,
                    itemIds: [],
                    description,
                    dureza,
                    tamanho: tamanhoContainer,
                    integridade,
                    peso: containerWeight
                };
                
                await window.saveContainerToFirebase(newContainer);
                
                // Criar Item de Container no Equipados
                const containerItemId = 'item-' + Date.now();
                const containerItem = {
                    id: containerItemId,
                    name: name,
                    ownerId: currentUser.uid, // ‚úÖ Usar uid do usu√°rio autenticado
                    characterId: characterId, // Vincular ao personagem
                    containerId: 'est√° com algu√©m', // No Equipados
                    quantity: 1,
                    description: 'Container: ' + (description || 'Sem descri√ß√£o'),
                    dureza,
                    tamanho: tamanhoContainer,
                    integridade,
                    peso: containerWeight,
                    packSize: 1,
                    totalWeight: containerWeight,
                    isContainerItem: true,
                    linkedContainerId: containerId
                };
                
                await window.saveItemToFirebase(containerItem);
                
                // Recarregar invent√°rio
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                showAlert('‚úÖ Container criado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao criar container:', error);
                alert('‚ùå Erro ao criar container!');
            }
        };

        window.removeContainer = async function(containerId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            
            if (!container) return;
            
            if (container.name === 'Equipados') {
                alert('‚ùå O container Equipados n√£o pode ser removido!');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover "${container.name}"? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è\n\nTodos os itens dentro ser√£o movidos para Equipados.`)) return;
            
            try {
                const characterId = window.currentCharacterId || (window.currentUser || currentUser)?.uid;
                
                // Verificar se existe container Equipados
                const equipados = char.containers.find(c => c.name === 'Equipados');
                
                if (!equipados) {
                    alert('‚ùå Container Equipados n√£o encontrado! N√£o √© poss√≠vel remover este container.');
                    return;
                }
                
                // ‚úÖ MOVER ITENS INLINE (sem usar fun√ß√£o externa)
                const itemsToMove = container.items || [];
                console.log(`üì¶ Movendo ${itemsToMove.length} itens de "${container.name}" para Equipados`);
                
                for (const item of itemsToMove) {
                    console.log(`  üîÑ Movendo item: ${item.name}`);
                    item.containerId = 'est√° com algu√©m';
                    await window.saveItemToFirebase(item);
                }
                
                console.log('‚úÖ Todos os itens movidos para Equipados');
                
                // Remover o Item de Container do Equipados (se existir)
                const containerItem = equipados.items.find(item => 
                    item.isContainerItem && item.linkedContainerId === containerId
                );
                
                if (containerItem) {
                    console.log(`üóëÔ∏è Removendo item de container: ${containerItem.name}`);
                    await window.deleteItemFromFirebase(containerItem.id);
                }
                
                // Remover container do Firebase
                console.log(`üóëÔ∏è Removendo container: ${container.name}`);
                await window.deleteContainerFromFirebase(containerId);
                
                // Recarregar invent√°rio
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                showAlert('üóëÔ∏è Container removido! Itens movidos para Equipados.', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao remover container:', error);
                alert('‚ùå Erro ao remover container: ' + error.message);
            }
        };

        window.addItemToContainer = function(containerId) {
            // A fun√ß√£o agora apenas abre o modal
            // Toda a l√≥gica de valida√ß√£o e salvamento est√° na fun√ß√£o saveItem()
            window.currentEditingContainerId = containerId;
            window.currentEditingItemId = null;
            document.getElementById('modalTitle').textContent = 'Criar Novo Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemImagePreview').innerHTML = '';
            document.getElementById('conditionalFields').innerHTML = '';
            document.getElementById('itemPesoTotal').value = '1.00';
            window.currentItemImageBase64 = null;
            document.getElementById('itemModal').style.display = 'block';
        };

        window.removeItemFromContainer = async function(containerId, itemId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (!container) return;
            
            const item = container.items.find(i => i.id === itemId);
            if (!item) return;
            
            // Verificar se √© Item de Container
            if (item.isContainerItem && item.linkedContainerId) {
                if (!confirm(`‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Este item representa o container "${item.name}"! ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è\n\nRemover este item tamb√©m remover√° o container e mover√° todos os itens dentro dele para Equipados.\n\nContinuar?`)) {
                    return;
                }
                
                // Remover o container associado
                await window.removeContainer(item.linkedContainerId);
                return;
            }
            
            if (!confirm(`‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover "${item.name}"? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è`)) return;
            
            try {
                await window.deleteItemFromFirebase(itemId);
                
                // Recarregar invent√°rio
                const characterId = currentCharacterId || currentUser.uid;
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                showAlert('üóëÔ∏è Item removido!', 'success');
            } catch (error) {
                console.error('Erro ao remover item:', error);
                alert('‚ùå Erro ao remover item!');
            }
        };

        window.editContainer = async function(containerId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            
            if (!container) return;
            
            if (container.name === 'Equipados') {
                alert('‚ùå O container Equipados n√£o pode ser editado!');
                return;
            }
            
            const newName = prompt('Nome do container:', container.name);
            if (newName === null) return;
            
            const newCapacity = parseInt(prompt('Capacidade m√°xima:', container.maxCapacity));
            const newMaxSize = parseInt(prompt('Tamanho m√°ximo de itens:', container.maxSize));
            const newDescription = prompt('Descri√ß√£o:', container.description || '');
            const newDureza = parseInt(prompt('Dureza:', container.dureza || 0));
            const newIntegridade = parseInt(prompt('Integridade:', container.integridade || 0));
            const newPeso = parseFloat(prompt('Peso:', container.peso || 0));
            
            try {
                if (newName && newName !== 'Equipados') container.name = newName;
                if (!isNaN(newCapacity)) container.maxCapacity = newCapacity;
                if (!isNaN(newMaxSize)) container.maxSize = newMaxSize;
                if (newDescription !== null) container.description = newDescription;
                if (!isNaN(newDureza)) container.dureza = newDureza;
                if (!isNaN(newIntegridade)) container.integridade = newIntegridade;
                if (!isNaN(newPeso)) container.peso = newPeso;
                
                await window.saveContainerToFirebase(container);
                
                // Atualizar Item de Container correspondente
                const equipados = char.containers.find(c => c.name === 'Equipados');
                if (equipados) {
                    const containerItem = equipados.items.find(item => 
                        item.isContainerItem && item.linkedContainerId === containerId
                    );
                    
                    if (containerItem) {
                        containerItem.name = container.name;
                        containerItem.description = 'Container: ' + (container.description || 'Sem descri√ß√£o');
                        containerItem.dureza = container.dureza;
                        containerItem.tamanho = container.tamanho;
                        containerItem.integridade = container.integridade;
                        containerItem.peso = container.peso;
                        containerItem.totalWeight = container.peso;
                        
                        await window.saveItemToFirebase(containerItem);
                    }
                }
                
                // Recarregar invent√°rio
                const characterId = currentCharacterId || currentUser.uid;
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                showAlert('‚úÖ Container atualizado!', 'success');
            } catch (error) {
                console.error('Erro ao editar container:', error);
                alert('‚ùå Erro ao editar container!');
            }
        };

        window.editContainerItem = function(containerId) {
            console.log('üîß editContainerItem chamado para:', containerId);
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            
            if (!container) {
                console.error('‚ùå Container n√£o encontrado:', containerId);
                return;
            }
            
            if (container.name === 'Equipados') {
                alert('‚ùå O container Equipados n√£o pode ser editado!');
                return;
            }
            
            // Encontrar o Item de Container correspondente em "Equipados"
            const equipados = char.containers.find(c => c.name === 'Equipados');
            if (!equipados) {
                console.error('‚ùå Container Equipados n√£o encontrado');
                return;
            }
            
            console.log('üîç Procurando containerItem vinculado a:', containerId);
            
            const containerItem = equipados.items.find(item => 
                item.isContainerItem === true && item.linkedContainerId === containerId
            );
            
            if (!containerItem) {
                console.error('‚ùå Item n√£o encontrado. Items em Equipados:', equipados.items);
                alert('‚ùå Item de Container n√£o encontrado!');
                return;
            }
            
            console.log('‚úÖ Item de Container encontrado:', containerItem);
            
            // Abrir o modal de editar item com os dados do container
            console.log('üéØ Chamando window.editItem com:', 'Equipados', containerItem.id);
            console.log('Tipo de window.editItem:', typeof window.editItem);

            try {
                window.editItem('Equipados', containerItem.id);
                console.log('‚úÖ Modal deveria estar aberto agora');
            } catch (error) {
                console.error('‚ùå Erro ao chamar editItem:', error);
                alert('Erro: ' + error.message);
            }
        };

        function updateContainers() {
            const char = getChar();
            const containersList = document.getElementById('containers-list');
            
            if (!char.containers || char.containers.length === 0) {
                containersList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Carregando containers...</p>';
                return;
            }
            
            containersList.innerHTML = char.containers.map(container => {
                const currentLoad = container.items.reduce((sum, item) => 
                    sum + (item.totalWeight || ((item.quantity / (item.packSize || 1)) * item.peso)), 0
                );
                
                const isOverload = currentLoad > container.maxCapacity;
                
                // Calcular tamanho m√°ximo para Equipados
                let sizeInfo = '';
                if (container.name === 'Equipados') {
                    const atletismo = char.skills['atletismo'] || 1;
                    const vig = char.vig || 1;
                    const forca = char.for || 1;
                    
                    const maxSize = forca * vig * atletismo;
                    
                    sizeInfo = `<span style="color: #94a3b8; font-size: 0.85rem; margin-right: 10px;">
                        üìè Tamanho Max: ${maxSize} <span style="color: #64748b; font-size: 0.75rem;">(FOR √ó VIG √ó Atletismo)</span>
                    </span>`;
                } else {
                    // Exibir tamanho do container para containers normais
                    sizeInfo = `<span style="color: #ef4444; font-size: 0.85rem; margin-right: 15px; font-weight: 600;">
                        Tamanho: ${container.maxSize || container.tamanho || 0}
                    </span><span style="color: #475569; margin-right: 15px;">|</span>`;
                }
                
                const itemsHTML = container.items.length === 0 
                    ? '<p style="color: #64748b; text-align: center; padding: 10px; font-size: 0.85rem;">Vazio</p>'
                    : container.items.map((item, index) => {

                        // Exibir imagem se existir
                        // URLs das imagens dos Lunis
                        const IMAGEM_LUN = 'https://i.imgur.com/RetxZ16.png'; // Cole a URL do Lun.png aqui
                        const IMAGEM_KA_LUN = 'https://i.imgur.com/yRUSkDM.png'; // Cole a URL do Ka_Lun.png aqui
                        const IMAGEM_MI_LUNIS = 'https://i.imgur.com/BTCzl1x.png'; // Cole a URL do Mi_Lunis.png aqui

                        // Definir imagem baseada no tipo de Lun
                        let imagemSrc = item.imagem;
                        if (item.tipo === 'Lunis' && !item.imagem) {
                            if (item.tipoLun === 'Lunis') {
                                imagemSrc = IMAGEM_LUN;
                            } else if (item.tipoLun === "Ka'Lunis") {
                                imagemSrc = IMAGEM_KA_LUN;
                            } else if (item.tipoLun === "Mi'Lunis") {
                                imagemSrc = IMAGEM_MI_LUNIS;
                            }
                        }
                        const imagemHTML = imagemSrc ? `<img src="${imagemSrc}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 6px; margin-right: 10px; background: transparent;">` : '';

                        // Detalhes do item
                        let detalhes = `Peso: ${item.peso} | Tam: ${item.tamanho} | Int: ${item.integridade}/${item.dureza + item.tamanho + (item.reforco || 0)} | Total: ${item.totalWeight || (item.peso * item.quantity)}`;
                        
                        if (item.tipo === 'Arma') {
                            detalhes += ` | Dano: +${item.dano || 0} | Rea√ß√£o: +${item.reacao || 0}`;
                        } else if (item.tipo === 'Vestimenta') {
                            detalhes += ` | Blindagem: +${item.blindagem || 0}`;
                        } else if (item.tipo === 'Proj√©til') {
                            detalhes += ` | Dano: +${item.dano || 0}`;
                        } else if (item.tipo === 'Container') {
                            detalhes += ` | Cap: ${item.maxCapacity} | TamMax: ${item.maxSize}`;
                        }
                        
                        return `
                            <div class="inventory-item" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; ${
                                item.isContainerItem ? 'background: rgba(139, 92, 246, 0.1); border-left: 3px solid var(--primary);' : 
                                item.tipo === 'Lunis' && item.tipoLun === 'Lunis' ? 'background: rgba(255, 255, 255, 0.1);' :
                                item.tipo === 'Lunis' && item.tipoLun === "Ka'Lunis" ? 'background: rgba(255, 255, 255, 0.1); border: 2px solid #FFD700; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);' :
                                item.tipo === 'Lunis' && item.tipoLun === "Mi'Lunis" ? 'background: rgba(255, 224, 66, 0.2); border: 6px solid #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);' :
                                ''
                            }">
                                <div class="item-info" onclick="editItem('${container.id}', '${item.id}')" style="cursor: pointer; flex: 1; display: flex; align-items: center;">
                                    ${imagemHTML}
                                    <div style="flex: 1;">
                                        <div class="item-name">${item.isContainerItem ? 'üì¶ ' : ''}${item.name} ${item.packSize > 1 ? `[Pack ${item.packSize}]` : ''} (x${item.quantity})${item.isContainerItem ? ' [CONTAINER]' : ''}</div>
                                        <div class="item-details">
                                            ${detalhes}
                                            ${item.description ? `<br>${item.description}` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 4px; align-items: center;">
                                    ${index > 0 ? `<button class="btn btn-secondary btn-small" onclick="moveItemUp('${container.id}', '${item.id}')" style="padding: 4px 8px;">‚ñ≤</button>` : ''}
                                    ${index < container.items.length - 1 ? `<button class="btn btn-secondary btn-small" onclick="moveItemDown('${container.id}', '${item.id}')" style="padding: 4px 8px;">‚ñº</button>` : ''}
                                    ${(item.tipo === 'Proj√©til' || item.tipo === 'Objeto' || item.tipo === 'Lunis') ? `
                                        <input type="number" min="1" value="${item.quantity}" 
                                            onchange="updateItemQuantity('${container.id}', '${item.id}', this.value)"
                                            style="width: 60px; padding: 4px 8px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--primary); border-radius: 8px; color: white; text-align: center; font-weight: 600;"
                                            onclick="event.stopPropagation()">
                                    ` : ''}
                                    ${!item.isContainerItem ? `<button class="btn btn-secondary btn-small" onclick="moveItemToContainer('${container.id}', '${item.id}')" style="padding: 4px 8px;">üì¶</button>` : ''}
                                    <button class="btn btn-danger btn-small" onclick="removeItemFromContainer('${container.id}', '${item.id}')" style="padding: 4px 8px;">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                return `
                    <div class="container-card">
                        <div class="container-header">
                            <div class="container-name">
                                ${container.name === 'Equipados' ? '‚öîÔ∏è' : 'üì¶'} ${container.name}
                                ${container.name !== 'Equipados' ? ` <button class="btn btn-secondary btn-small" onclick="editContainerItem('${container.id}')" style="padding: 2px 8px; font-size: 0.7rem;">‚úèÔ∏è</button>` : ''}
                            </div>
                            <div style="display: flex; align-items: center;">
                                ${sizeInfo}
                                <div class="container-capacity ${isOverload ? 'overload' : ''}">
                                    ${currentLoad} / ${container.maxCapacity} ${isOverload ? '‚ö†Ô∏è SOBRECARGA!' : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-small" onclick="addItemToContainer('${container.id}')" style="flex: 1; min-width: 120px;">‚ûï Item</button>
                        </div>
                        ${itemsHTML}
                    </div>
                `;
            }).join('');

            // Atualizar display de Luns
            updateLunsDisplay();
        }

        window.editItem = function(containerId, itemId) {
            console.log('üîç editItem chamado com containerId:', containerId, 'itemId:', itemId);
            const char = getChar();
            
            // Buscar container pelo ID ou pelo nome (caso seja "Equipados")
            let container = char.containers.find(c => c.id === containerId);
            if (!container) {
                console.log('‚ö†Ô∏è Container n√£o encontrado pelo ID, tentando pelo nome...');
                container = char.containers.find(c => c.name === containerId);
            }
            
            if (!container) {
                console.error('‚ùå Container n√£o encontrado:', containerId);
                console.log('Containers dispon√≠veis:', char.containers.map(c => ({id: c.id, name: c.name})));
                return;
            }
            
            console.log('‚úÖ Container encontrado:', container.name, container.id);
            
            const item = container.items.find(i => i.id === itemId);
            if (!item) {
                console.error('‚ùå Item n√£o encontrado:', itemId);
                console.log('Items no container:', container.items.map(i => i.id));
                return;
            }
            
            console.log('‚úÖ Item encontrado:', item);
            
            // Preencher modal com dados do item
            window.currentEditingContainerId = containerId;
            window.currentEditingItemId = itemId;

            console.log('üìù Editando item:', item.id, 'isContainerItem:', item.isContainerItem, 'linkedContainerId:', item.linkedContainerId);

            // Atualizar t√≠tulo para indicar se √© um Container
            if (item.isContainerItem) {
                document.getElementById('modalTitle').textContent = 'üì¶ Editar Container';
            } else {
                document.getElementById('modalTitle').textContent = 'Editar Item';
            }
            
            document.getElementById('itemName').value = item.name || '';
            // Se for container, remover o prefixo "Container: " da descri√ß√£o
            let description = item.description || '';
            if (item.isContainerItem && description.startsWith('Container: ')) {
                description = description.replace('Container: ', '');
            }
            document.getElementById('itemDescription').value = description;
            document.getElementById('itemDureza').value = item.dureza || 0;
            document.getElementById('itemTamanho').value = item.tamanho || 1;
            document.getElementById('itemReforco').value = item.reforco || 0;
            document.getElementById('itemIntegridade').value = item.integridade || 10;
            document.getElementById('itemPeso').value = item.peso || 1;
            document.getElementById('itemTipo').value = item.tipo || '';
            
            // Carregar imagem se existir
            if (item.imagem) {
                window.currentItemImageBase64 = item.imagem;
                document.getElementById('itemImagePreview').innerHTML = `<img src="${item.imagem}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
            } else {
                window.currentItemImageBase64 = null;
                document.getElementById('itemImagePreview').innerHTML = '';
            }
            
            // Atualizar campos condicionais
            updateItemTypeFields();
            
            // Se for Lunis, carregar tipoLun
            if (item.tipo === 'Lunis' && item.tipoLun) {
                document.getElementById('itemTipoLun').value = item.tipoLun;
                
                // Garantir que o nome seja atualizado ao editar
                const itemNameField = document.getElementById('itemName');
                if (itemNameField && !itemNameField.value) {
                    if (item.tipoLun === 'Lunis') {
                        itemNameField.value = 'Lunis';
                    } else if (item.tipoLun === "Ka'Lunis") {
                        itemNameField.value = "Ka'Lunis";
                    } else if (item.tipoLun === "Mi'Lunis") {
                        itemNameField.value = "Mi'Lunis";
                    }
                }
                
                setTimeout(() => {
                    updateLunisFields();
                    const tipoLunSelect = document.getElementById('itemTipoLun');
                    if (tipoLunSelect) {
                        tipoLunSelect.value = item.tipoLun;
                        const quantidadeEl = document.getElementById('itemQuantidade');
                        if (quantidadeEl) {
                            quantidadeEl.value = item.quantity || 1;
                        }
                    }
                }, 100);
            }

            // Preencher campos condicionais
            if (item.tipo === 'Arma') {
                document.getElementById('itemDano').value = item.dano || 0;
                document.getElementById('itemReacao').value = item.reacao || 0;
            } else if (item.tipo === 'Vestimenta') {
                document.getElementById('itemBlindagem').value = item.blindagem || 0;
            } else if (item.tipo === 'Proj√©til') {
                document.getElementById('itemQuantidade').value = item.quantity || 1;
                document.getElementById('itemPackSize').value = item.packSize || 1;
                document.getElementById('itemDanoProj√©til').value = item.dano || 0;
            } else if (item.tipo === 'Objeto') {
                document.getElementById('itemQuantidade').value = item.quantity || 1;
                document.getElementById('itemPackSize').value = item.packSize || 1;
            } else if (item.tipo === 'Lunis') {
            } else if (item.tipo === 'Container') {
                document.getElementById('itemCapacidadeMax').value = item.maxCapacity || 10;
                document.getElementById('itemTamanhoMax').value = item.maxSize || 5;
            }
            
            calculateTotalWeight();
            document.getElementById('itemModal').style.display = 'block';
        };

        window.updateItemQuantity = async function(containerId, itemId, newQuantity) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (!container) return;
            
            const item = container.items.find(i => i.id === itemId);
            if (!item) return;
            
            const quantity = parseInt(newQuantity);
            if (isNaN(quantity) || quantity < 1) {
                showAlert('‚ùå Quantidade inv√°lida!', 'error');
                updateContainers(); // Recarregar para restaurar valor anterior
                return;
            }
            
            try {
                item.quantity = quantity;
                item.totalWeight = (item.quantity / (item.packSize || 1)) * item.peso;
                
                await window.saveItemToFirebase(item);
                
                // Recarregar invent√°rio
                const characterId = currentCharacterId || currentUser.uid;
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                showAlert('‚úÖ Quantidade atualizada!', 'success');
            } catch (error) {
                console.error('Erro ao alterar quantidade:', error);
                showAlert('‚ùå Erro ao alterar quantidade!', 'error');
                updateContainers(); // Recarregar para restaurar valor anterior
            }
        };

        window.moveItemToContainer = async function(fromContainerId, itemId) {
            const char = getChar();
            const fromContainer = char.containers.find(c => c.id === fromContainerId);
            if (!fromContainer) return;
            
            const item = fromContainer.items.find(i => i.id === itemId);
            if (!item) return;
            
            // Verificar se √© Item de Container
            if (item.isContainerItem) {
                alert('‚ùå N√£o √© poss√≠vel mover o Item de Container!\n\nEste item representa um container f√≠sico que voc√™ carrega.');
                return;
            }
            
            // Criar lista de containers dispon√≠veis
            const containerOptions = char.containers
                .filter(c => {
                    // N√£o pode mover para o mesmo container
                    if (c.id === fromContainerId) return false;
                    
                    // Verificar se √© o pr√≥prio container do item
                    if (item.linkedContainerId && c.id === item.linkedContainerId) return false;
                    
                    // Verificar tamanho
                    if (c.name === 'Equipados') {
                        const atletismo = char.skills['atletismo'] || 1;
                        const vig = char.vig || 1;
                        const forca = char.for || 1;
                        const maxSize = char.for * char.vig * atletismo;
                        return item.tamanho <= maxSize;
                    } else {
                        return item.tamanho <= c.maxSize;
                    }
                })
                .map((c, index) => `${index + 1}. ${c.name} (Tam m√°x: ${c.maxSize || 'N/A'})`)
                .join('\n');
            
            if (!containerOptions) {
                alert('‚ùå Nenhum container dispon√≠vel!\n\nO item pode ser muito grande ou n√£o h√° outros containers.');
                return;
            }
            
            const choice = prompt(`Para qual container mover "${item.name}"?\n\n${containerOptions}\n\nDigite o n√∫mero:`);
            if (!choice) return;
            
            const targetIndex = parseInt(choice) - 1;
            const targetContainer = char.containers.filter(c => {
                if (c.id === fromContainerId) return false;
                if (item.linkedContainerId && c.id === item.linkedContainerId) return false;
                if (c.name === 'Equipados') {
                    const atletismo = char.skills['atletismo'] || 1;
                    const maxSize = char.for * char.vig * atletismo;
                    return item.tamanho <= maxSize;
                } else {
                    return item.tamanho <= c.maxSize;
                }
            })[targetIndex];
            
            if (targetContainer) {
                try {
                    // Atualizar containerId do item
                    item.containerId = targetContainer.name === 'Equipados' ? 'est√° com algu√©m' : targetContainer.id;
                    
                    await window.saveItemToFirebase(item);
                    
                    // Recarregar invent√°rio
                    const characterId = currentCharacterId || currentUser.uid;
                    await window.loadInventoryFromFirebase(characterId);
                    updateContainers();
                    showAlert(`‚úÖ Item movido para ${targetContainer.name}!`, 'success');
                } catch (error) {
                    console.error('Erro ao mover item:', error);
                    alert('‚ùå Erro ao mover item!');
                }
            }
        };

        window.moveItemUp = async function(containerId, itemId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (!container) return;
            
            const itemIndex = container.items.findIndex(i => i.id === itemId);
            if (itemIndex > 0) {
                // Trocar posi√ß√µes
                [container.items[itemIndex], container.items[itemIndex - 1]] = 
                [container.items[itemIndex - 1], container.items[itemIndex]];
                
                updateContainers();
                // N√£o salva no Firebase, apenas reorganiza localmente
            }
        };

        window.moveItemDown = async function(containerId, itemId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (!container) return;
            
            const itemIndex = container.items.findIndex(i => i.id === itemId);
            if (itemIndex < container.items.length - 1) {
                // Trocar posi√ß√µes
                [container.items[itemIndex], container.items[itemIndex + 1]] = 
                [container.items[itemIndex + 1], container.items[itemIndex]];
                
                updateContainers();
                // N√£o salva no Firebase, apenas reorganiza localmente
            }
        };

        // ========== FUN√á√ïES DO MODAL DE ITEM ==========
        window.closeItemModal = function() {
            document.getElementById('itemModal').style.display = 'none';
            window.currentEditingContainerId = null;
            window.currentEditingItemId = null;
            window.currentItemImageBase64 = null;
        };

        window.updateItemTypeFields = function() {
            const tipo = document.getElementById('itemTipo').value;
            const conditionalFields = document.getElementById('conditionalFields');
            
            let html = '';
            
            switch(tipo) {
                case 'Arma':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">‚öîÔ∏è Atributos de Arma</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">+ Dano</label>
                                    <input type="number" id="itemDano" min="0" value="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">+ Rea√ß√£o (Defesa)</label>
                                    <input type="number" id="itemReacao" min="0" value="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Vestimenta':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üõ°Ô∏è Atributos de Vestimenta</h3>
                            <div>
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">+ Blindagem</label>
                                <input type="number" id="itemBlindagem" min="0" value="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Proj√©til':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üéØ Atributos de Proj√©til</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Quantidade*</label>
                                    <input type="number" id="itemQuantidade" min="1" value="1" required oninput="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tamanho do Pack*</label>
                                    <select id="itemPackSize" required onchange="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                        <option value="1">1</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">+ Dano</label>
                                    <input type="number" id="itemDanoProj√©til" min="0" value="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Objeto':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üì¶ Atributos de Objeto</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Quantidade*</label>
                                    <input type="number" id="itemQuantidade" min="1" value="1" required oninput="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tamanho do Pack*</label>
                                    <select id="itemPackSize" required onchange="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                        <option value="1">1</option>
                                        <option value="5">5</option>
                                        <option value="10">10</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'Container':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üì¶ Atributos de Container</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Capacidade M√°xima*</label>
                                    <input type="number" id="itemCapacidadeMax" min="1" value="10" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                                <div>
                                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tamanho M√°ximo de Itens*</label>
                                    <input type="number" id="itemTamanhoMax" min="1" value="5" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'Lunis':
                    html = `
                        <div style="border-top: 2px solid var(--primary); padding-top: 15px; margin-top: 15px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px;">üí∞ Atributos de Lunis</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Tipo de Lun*</label>
                                <select id="itemTipoLun" onchange="updateLunisFields()" required style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                                    <option value="">Selecione...</option>
                                    <option value="Lunis">Lunis</option>
                                    <option value="Ka'Lunis">Ka'Lunis</option>
                                    <option value="Mi'Lunis">Mi'Lunis</option>
                                </select>
                            </div>
                            <div id="lunisQuantityField"></div>
                        </div>
                    `;
                    break;
            }
            
            conditionalFields.innerHTML = html;
            calculateTotalWeight();
        };

        window.calculateTotalWeight = function() {
            const tipo = document.getElementById('itemTipo').value;
            const peso = parseFloat(document.getElementById('itemPeso').value) || 0;
            
            let totalWeight = peso;
            
            if (tipo === 'Proj√©til' || tipo === 'Objeto') {
                const quantidade = parseInt(document.getElementById('itemQuantidade')?.value) || 1;
                const packSize = parseInt(document.getElementById('itemPackSize')?.value) || 1;
                totalWeight = Math.ceil((quantidade / packSize) * peso);
            }
            
            document.getElementById('itemPesoTotal').value = totalWeight.toFixed(2);
        };

        window.updateLunisFields = function() {
            const tipoLun = document.getElementById('itemTipoLun')?.value;
            const lunisQuantityField = document.getElementById('lunisQuantityField');
            
            if (!tipoLun || !lunisQuantityField) return;
            
            let descricao = '';
            let packSize = 1;
            
            // URLs das imagens dos Lunis
            const IMAGEM_LUN = 'https://i.imgur.com/RetxZ16.png'; // Cole a URL do Lun.png aqui
            const IMAGEM_KA_LUN = 'https://i.imgur.com/yRUSkDM.png'; // Cole a URL do Ka_Lun.png aqui
            const IMAGEM_MI_LUNIS = 'https://i.imgur.com/BTCzl1x.png'; // Cole a URL do Mi_Lunis.png aqui

            // Atualizar imagem automaticamente baseada no tipo de Lun
            if (tipoLun === 'Lunis') {
                window.currentItemImageBase64 = IMAGEM_LUN;
                document.getElementById('itemImagePreview').innerHTML = `<img src="${IMAGEM_LUN}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: contain; background: transparent;">`;
            } else if (tipoLun === "Ka'Lunis") {
                window.currentItemImageBase64 = IMAGEM_KA_LUN;
                document.getElementById('itemImagePreview').innerHTML = `<img src="${IMAGEM_KA_LUN}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: contain; background: transparent;">`;
            } else if (tipoLun === "Mi'Lunis") {
                window.currentItemImageBase64 = IMAGEM_MI_LUNIS;
                document.getElementById('itemImagePreview').innerHTML = `<img src="${IMAGEM_MI_LUNIS}" style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: contain; background: transparent;">`;
            }

            // Atualizar o nome do item automaticamente
            const itemNameField = document.getElementById('itemName');
            if (itemNameField) {
                if (tipoLun === 'Lunis') {
                    itemNameField.value = 'Lunis';
                } else if (tipoLun === "Ka'Lunis") {
                    itemNameField.value = "Ka'Lunis";
                } else if (tipoLun === "Mi'Lunis") {
                    itemNameField.value = "Mi'Lunis";
                }
            }
            if (tipoLun === 'Lunis') {
                descricao = 'Cada Lun tem um valor unit√°rio, comumente usado no com√©rcio e em classe m√©dia para baixo.';
                packSize = 50;
            } else if (tipoLun === "Ka'Lunis") {
                descricao = "Cada Ka'Lun, equivale a 1000 unidades de Luns, pouco usada pela classe baixa, comum entre a nobreza e no com√©rcio.";
                packSize = 10;
            } else if (tipoLun === "Mi'Lunis") {
                descricao = 'Cada Mi\'Lun equivale a 1.000.000 (1 Milh√£o) de unidades de Lunis, moeda rara at√© entre a nobreza.';
                packSize = 1;
            }
            
            lunisQuantityField.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 5px;">Quantidade*</label>
                    <input type="number" id="itemQuantidade" min="1" value="1" required oninput="calculateTotalWeight()" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light);">
                </div>
                <div style="background: rgba(139, 92, 246, 0.1); border-left: 3px solid var(--primary); padding: 12px; border-radius: 8px; margin-top: 10px;">
                    <p style="color: #cbd5e1; font-size: 0.85rem; margin: 0;">${descricao}</p>
                    <p style="color: #94a3b8; font-size: 0.75rem; margin-top: 8px;">
                        üì¶ Tamanho do Pack: <strong style="color: var(--primary);">${packSize}</strong> (fixo)
                    </p>
                </div>
            `;
            
            // Atualizar campos automaticamente
            document.getElementById('itemDescription').value = descricao;
            document.getElementById('itemDureza').value = 1;
            document.getElementById('itemIntegridade').value = 2;
            document.getElementById('itemPeso').value = 1;
            
            calculateTotalWeight();
        };

        window.repairItem = function() {
            const dureza = parseInt(document.getElementById('itemDureza').value) || 0;
            const tamanho = parseInt(document.getElementById('itemTamanho').value) || 0;
            const reforco = parseInt(document.getElementById('itemReforco').value) || 0;
            
            const integridadeMax = dureza + tamanho + reforco;
            document.getElementById('itemIntegridade').value = integridadeMax;
            
            showAlert('üîß Item reparado!', 'success');
        };

        window.previewItemImage = function() {
            const file = document.getElementById('itemImagem').files[0];
            if (!file) return;
            
            // Verificar tamanho (m√°x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('‚ùå Imagem muito grande! M√°ximo 2MB.', 'danger');
                document.getElementById('itemImagem').value = '';
                return;
            }
            
            // Verificar tipo
            if (!file.type.startsWith('image/')) {
                showAlert('‚ùå Por favor, selecione uma imagem v√°lida.', 'danger');
                document.getElementById('itemImagem').value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                window.currentItemImageBase64 = e.target.result;
                document.getElementById('itemImagePreview').innerHTML = `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file);
        };

        window.saveItem = async function() {
            console.log('üíæ saveItem chamado');
            const char = getChar();
            const containerId = window.currentEditingContainerId;
            const itemId = window.currentEditingItemId;
            
            console.log('üì¶ ContainerId:', containerId, 'ItemId:', itemId);
            
            // Validar campos obrigat√≥rios
            const name = document.getElementById('itemName').value.trim();
            const tipo = document.getElementById('itemTipo').value;

            // Capturar tipo de Lun se for Lunis
            let tipoLun = null;
            if (tipo === 'Lunis') {
                tipoLun = document.getElementById('itemTipoLun')?.value || null;
            }
            
            if (!name || !tipo) {
                alert('‚ùå Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            // Buscar container pelo ID ou pelo nome (caso seja "Equipados")
            let container = char.containers.find(c => c.id === containerId);
            if (!container) {
                console.log('‚ö†Ô∏è Container n√£o encontrado pelo ID, tentando pelo nome...');
                container = char.containers.find(c => c.name === containerId);
            }
            
            if (!container) {
                console.error('‚ùå Container n√£o encontrado:', containerId);
                console.log('Containers dispon√≠veis:', char.containers.map(c => ({id: c.id, name: c.name})));
                alert('‚ùå Erro: Container n√£o encontrado!');
                return;
            }
            
            console.log('‚úÖ Container encontrado para salvar:', container.name);
            
            // Coletar dados b√°sicos
            const itemData = {
                name,
                tipo,
                tipoLun,
                description: document.getElementById('itemDescription').value,
                dureza: parseInt(document.getElementById('itemDureza').value) || 0,
                tamanho: parseInt(document.getElementById('itemTamanho').value) || 1,
                reforco: parseInt(document.getElementById('itemReforco').value) || 0,
                integridade: parseInt(document.getElementById('itemIntegridade').value) || 10,
                peso: parseFloat(document.getElementById('itemPeso').value) || 1,
                imagem: window.currentItemImageBase64 || null,
                quantity: 1,
                packSize: 1,
                totalWeight: parseFloat(document.getElementById('itemPesoTotal').value) || 1
            };
            
            // Coletar dados espec√≠ficos por tipo
            switch(tipo) {
                case 'Arma':
                    itemData.dano = parseInt(document.getElementById('itemDano').value) || 0;
                    itemData.reacao = parseInt(document.getElementById('itemReacao').value) || 0;
                    break;
                case 'Vestimenta':
                    itemData.blindagem = parseInt(document.getElementById('itemBlindagem').value) || 0;
                    break;
                case 'Proj√©til':
                    itemData.quantity = parseInt(document.getElementById('itemQuantidade').value) || 1;
                    itemData.packSize = parseInt(document.getElementById('itemPackSize').value) || 1;
                    itemData.dano = parseInt(document.getElementById('itemDanoProj√©til').value) || 0;
                    itemData.totalWeight = Math.ceil((itemData.quantity / itemData.packSize) * itemData.peso);
                    break;
                case 'Objeto':
                    itemData.quantity = parseInt(document.getElementById('itemQuantidade').value) || 1;
                    itemData.packSize = parseInt(document.getElementById('itemPackSize').value) || 1;
                    itemData.totalWeight = Math.ceil((itemData.quantity / itemData.packSize) * itemData.peso);
                    break;
                case 'Lunis': 
                    itemData.quantity = parseInt(document.getElementById('itemQuantidade').value) || 1;
                    const tipoLunValue = document.getElementById('itemTipoLun')?.value;
                    if (tipoLunValue === 'Lunis') {
                        itemData.packSize = 50;
                    } else if (tipoLunValue === "Ka'Lunis") {
                        itemData.packSize = 10;
                    } else if (tipoLunValue === "Mi'Lunis") {
                        itemData.packSize = 1;
                    }
                    itemData.totalWeight = Math.ceil((itemData.quantity / itemData.packSize) * itemData.peso);
                    break;
                case 'Container':
                    itemData.maxCapacity = parseInt(document.getElementById('itemCapacidadeMax').value) || 10;
                    itemData.maxSize = parseInt(document.getElementById('itemTamanhoMax').value) || 5;
                    break;
            }
            
            // Verificar tamanho no container
            if (container.name === 'Equipados') {
                const atletismo = char.skills['atletismo'] || 1;
                const maxSize = char.for * char.vig * atletismo;
                if (itemData.tamanho > maxSize) {
                    alert(`‚ùå Item muito grande!\n\nTamanho m√°ximo permitido: ${maxSize}\nTamanho do item: ${itemData.tamanho}`);
                    return;
                }
            } else if (itemData.tamanho > container.maxSize) {
                alert(`‚ùå Item muito grande para este container!\n\nTamanho m√°ximo: ${container.maxSize}\nTamanho do item: ${itemData.tamanho}`);
                return;
            }
            
            try {
                const characterId = window.currentCharacterId || currentUser?.uid;
                
                if (itemId) {
                    // Editar item existente
                    const item = container.items.find(i => i.id === itemId);
                    Object.assign(item, itemData);
                    // Garantir que a descri√ß√£o do item de container tenha o prefixo
                    if (item.isContainerItem && item.description && !item.description.startsWith('Container: ')) {
                        item.description = 'Container: ' + item.description;
                    }
                    await window.saveItemToFirebase(item);
                    // Se for um Item de Container, atualizar o container vinculado
                    if (item.isContainerItem && item.linkedContainerId) {
                        console.log('üîÑ Atualizando container vinculado:', item.linkedContainerId);
                        const linkedContainer = char.containers.find(c => c.id === item.linkedContainerId);
                        
                        if (linkedContainer) {
                            console.log('‚úÖ Container encontrado, atualizando...');
                            
                            linkedContainer.name = item.name;
                            
                            // Limpar descri√ß√£o do prefixo
                            let cleanDescription = item.description || '';
                            if (cleanDescription.startsWith('Container: ')) {
                                cleanDescription = cleanDescription.replace('Container: ', '');
                            }
                            linkedContainer.description = cleanDescription;
                            
                            linkedContainer.dureza = item.dureza;
                            linkedContainer.tamanho = item.tamanho;
                            linkedContainer.integridade = item.integridade;
                            linkedContainer.peso = item.peso;
                            
                            // Se for tipo Container, atualizar tamb√©m capacidade
                            if (item.tipo === 'Container' && item.maxCapacity) {
                                linkedContainer.maxCapacity = item.maxCapacity;
                                linkedContainer.maxSize = item.maxSize;
                            }
                            
                            console.log('üíæ Salvando container:', linkedContainer);
                            await window.saveContainerToFirebase(linkedContainer);
                            console.log('‚úÖ Container salvo!');
                        } else {
                            console.error('‚ùå Container n√£o encontrado:', item.linkedContainerId);
                        }
                    }
                    showAlert('‚úÖ Item atualizado!', 'success');
                } else {
                    // Criar novo item
                    const newItem = {
                        ...itemData,
                        id: 'item-' + Date.now(),
                        ownerId: (window.currentUser || currentUser)?.uid,
                        characterId: window.currentCharacterId || characterId,
                        containerId: container.name === 'Equipados' ? 'est√° com algu√©m' : containerId,
                        isContainerItem: false,
                        linkedContainerId: null
                    };
                    
                    await window.saveItemToFirebase(newItem);
                    
                    // Se for um Container, criar o container correspondente
                    if (tipo === 'Container') {
                        const containerId = 'container-' + Date.now();
                        const newContainer = {
                            id: containerId,
                            name: name,
                            ownerId: currentUser.uid,
                            characterId: characterId,
                            maxCapacity: itemData.maxCapacity,
                            maxSize: itemData.maxSize,
                            itemIds: [],
                            description: itemData.description,
                            dureza: itemData.dureza,
                            tamanho: itemData.tamanho,
                            integridade: itemData.integridade,
                            peso: itemData.peso
                        };
                        
                        await window.saveContainerToFirebase(newContainer);
                        
                        // Atualizar item para vincular ao container
                        newItem.isContainerItem = true;
                        newItem.linkedContainerId = containerId;
                        await window.saveItemToFirebase(newItem);
                    }
                    
                    showAlert('‚úÖ Item criado!', 'success');
                }
                
                // Recarregar invent√°rio
                await window.loadInventoryFromFirebase(characterId);
                updateContainers();
                closeItemModal();
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                alert('‚ùå Erro ao salvar item!');
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const targetTab = document.querySelector(`.tab-content[id="${tabName}"]`);
            
            if (!targetTab) {
                console.error('‚ùå Aba n√£o encontrada:', tabName);
                return;
            }
            
            event.target.classList.add('active');
            targetTab.classList.add('active');
            
            event.target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        };

        function loadCharacterData() {
            const char = getChar();
            ['nome', 'jogador', 'idade', 'raca', 'classe', 'virtude', 'vicio', 'tamanho', 'auraImortalidade'].forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = char[key] || (key === 'tamanho' ? 5 : key === 'auraImortalidade' ? 1 : '');
            });
            
            // Carregar Luns separadamente
            const lunsEl = document.getElementById('luns');
            if (lunsEl) lunsEl.value = char.luns || 0;
            
            // Carregar valores de combate
            const hpInput = document.getElementById('hp-current');
            if (hpInput) hpInput.value = char.hpCurrent || 5;

            const detInput = document.getElementById('det-current');
            if (detInput) detInput.value = char.detCurrent || 3;

            const sanInput = document.getElementById('san-current');
            if (sanInput) sanInput.value = char.sanCurrent || 80;

            const attributes = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
            attributes.forEach(attr => updateAttributeDots(attr));
            
            Object.keys(char.skills).forEach(skillId => updateSkillDots(skillId));
            
            Object.keys(char.skillInputs || {}).forEach(skillId => {
                const inputEl = document.getElementById(`input-${skillId}`);
                if (inputEl) inputEl.value = char.skillInputs[skillId];
            });

            const notasTextarea = document.getElementById('notas-textarea');
            if (notasTextarea) {
                notasTextarea.value = char.notas || '';
            }
            
            // Inicializar Fantoches se for Adepto
            if (char.classe === 'Adepto') {
                const fantochesSection = document.getElementById('fantoches-section');
                if (fantochesSection) {
                    fantochesSection.style.display = 'block';
                }
                
                if (!char.fantochesAtivos) {
                    char.fantochesAtivos = 0;
                }
                
                const fantochesInput = document.getElementById('fantoches-current');
                if (fantochesInput) {
                    fantochesInput.value = char.fantochesAtivos;
                    updateFantochesBar();
                }
            } else {
                const fantochesSection = document.getElementById('fantoches-section');
                if (fantochesSection) {
                    fantochesSection.style.display = 'none';
                }
            }

            updateGracaCombate();
            updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();

            // Update allies and properties
            updateAlliesList();
            updatePropertiesList();
            updateAlliesCombat();
            
            if (char.classe && CLASS_ABILITIES[char.classe]) {
                renderClassContent(char.classe);
                
                // Se a classe est√° bloqueada, desabilita o select
                if (char.classeLocked) {
                    const classeSelect = document.getElementById('classe');
                    if (classeSelect) {
                        classeSelect.disabled = true;
                        classeSelect.style.opacity = '0.6';
                        classeSelect.style.cursor = 'not-allowed';
                    }
                }
            }

            updateCharacterImageDisplay();
        }

        function showAlert(message, type) {
            const alert = type === 'success' 
                ? document.getElementById('alertSuccess')
                : document.getElementById('alertError');
            
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // ========== SISTEMA DE PROGRESS√ÉO COM EXP ==========
        
        function upgradeAttribute(attr, targetLevel) {
            const char = getChar();
            const currentLevel = char[attr] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 5;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const msg = levelDiff === 1 
                ? `Aumentar ${attr.toUpperCase()} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Aumentar ${attr.toUpperCase()} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP`;
            
            if (confirm(msg)) {
                char[attr] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateAttributeDots(attr);
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${attr.toUpperCase()} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function upgradeSkill(skillId, targetLevel, skillDiv) {
            const char = getChar();
            const currentLevel = char.skills[skillId] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 4;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const skillName = skillId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const msg = levelDiff === 1 
                ? `Aumentar ${skillName} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Aumentar ${skillName} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP`;
            
            if (confirm(msg)) {
                char.skills[skillId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateSkillDots(skillId);
                skillDiv.classList.toggle('inapto', targetLevel === 0);
                updateAllCalculations();
                updateClassTests();
                updateEXPDisplay();
                showAlert(`‚úÖ ${skillName} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function upgradeClassAbility(abilityId, targetLevel) {
            const char = getChar();
            const currentLevel = char.classAbilities[abilityId] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            const classe = char.classe;
            let multiplier = 2;
            if (classe === 'Pallacerdote' || classe === 'Ritualista (Abismancia)') {
                multiplier = 4;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * multiplier;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const abilityName = abilityId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const msg = levelDiff === 1 
                ? `Aumentar ${abilityName} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`
                : `Aumentar ${abilityName} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`;
            
            if (confirm(msg)) {
                char.classAbilities[abilityId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateClassAbilityDots(abilityId);
                updateClassTests();
                updateClassResourcesDisplay();
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${abilityName} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function updateEXPDisplay() {
            const char = getChar();
            const expDisplay = document.getElementById('exp-display');
            if (expDisplay) {
                expDisplay.textContent = char.exp || 0;
            }
        }
        
        // ========== SISTEMA DE RECEITAS (CA√áADOR) ==========

        window.openRecipeModal = function() {
            const char = getChar();
            const classe = char.classe;
            
            document.getElementById('recipe-modal').style.display = 'flex';
            
            // Limpar campos
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-macerar').value = '';
            document.getElementById('recipe-props').value = '';
            document.getElementById('recipe-variedade').value = '';
            document.getElementById('recipe-repetir').checked = false;
            
            // Configurar tipo baseado na classe
            const tipoSelect = document.getElementById('recipe-tipo');
            const tipoContainer = document.getElementById('recipe-tipo-container');
            
            if (classe === 'Ca√ßador') {
                tipoSelect.value = 'Ofensivo';
                tipoSelect.disabled = true;
                tipoContainer.style.display = 'block';
            } else if (classe === 'Druida') {
                tipoSelect.value = 'Defensivo';
                tipoSelect.disabled = false;
                tipoContainer.style.display = 'block';
            } else {
                tipoContainer.style.display = 'none';
            }
        };

        window.closeRecipeModal = function() {
            document.getElementById('recipe-modal').style.display = 'none';
        };

        window.learnRecipe = function() {
            const char = getChar();
            
            // Verificar se tem EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < 1) {
                alert('‚ùå EXP Insuficiente!\n\nPrecisa: 1 EXP\nTem: ' + currentEXP + ' EXP');
                return;
            }
            
            // Pegar valores
            const name = document.getElementById('recipe-name').value.trim();
            const macerar = parseInt(document.getElementById('recipe-macerar').value) || 0;
            const props = document.getElementById('recipe-props').value.trim();
            const variedade = parseInt(document.getElementById('recipe-variedade').value) || 0;
            const repetir = document.getElementById('recipe-repetir').checked;
            
            // Validar
            if (!name) {
                alert('‚ùå Por favor, preencha o nome da receita!');
                return;
            }
            
            // Confirmar
            if (!confirm(`Aprender a receita "${name}"?\n\nCusto: 1 EXP\nEXP atual: ${currentEXP}`)) {
                return;
            }
            
            // Inicializar array se n√£o existir
            if (!char.recipes) {
                char.recipes = [];
            }
            
            // Adicionar receita
            const tipo = document.getElementById('recipe-tipo').value;
            const newRecipe = {
                id: Date.now(),
                name: name,
                tipo: tipo, // Defensivo ou Ofensivo
                macerar: macerar,
                propriedades: props,
                variedadeMinima: variedade,
                repetir: repetir
            };
            
            char.recipes.push(newRecipe);
            char.exp = currentEXP - 1;
            
            // Atualizar display
            updateRecipesList();
            updateEXPDisplay();
            closeRecipeModal();
            autoSave();
            
            showAlert(`‚úÖ Receita "${name}" aprendida! (-1 EXP)`, 'success');
        };

        window.removeRecipe = function(recipeId) {
            if (!confirm('‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover esta receita? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è')) return;
            
            const char = getChar();
            if (!char.recipes) char.recipes = [];
            
            char.recipes = char.recipes.filter(r => r.id !== recipeId);
            updateRecipesList();
            autoSave();
            showAlert('‚úÖ Receita removida!', 'success');
        };

        function updateRecipesList() {
            const recipesList = document.getElementById('recipes-list');
            if (!recipesList) return;
            
            const char = getChar();
            if (!char.recipes) char.recipes = [];
            
            if (char.recipes.length === 0) {
                recipesList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhuma receita aprendida ainda. Clique em "Adicionar Receita" para aprender uma nova receita.</p>';
                return;
            }
            
            recipesList.innerHTML = char.recipes.map(recipe => {
                const tipoIcon = recipe.tipo === 'Ofensivo' ? '‚öîÔ∏è' : 'üõ°Ô∏è';
                const tipoColor = recipe.tipo === 'Ofensivo' ? '#ef4444' : '#10b981';
                
                return `
                    <div class="container-card" style="border-left: 4px solid ${tipoColor}; margin-bottom: 15px;">
                        <div class="container-header">
                            <div class="container-name">üß™ ${recipe.name}</div>
                            <button class="btn btn-danger btn-small" onclick="removeRecipe(${recipe.id})">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 10px; color: #cbd5e1; font-size: 0.85rem;">
                            <div style="margin-bottom: 8px;">
                                <strong>Tipo:</strong> <span style="color: ${tipoColor};">${tipoIcon} ${recipe.tipo || 'Ofensivo'}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Dif. de Macerar:</strong> ${recipe.macerar}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Propriedades:</strong> ${recipe.propriedades || 'Nenhuma'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Variedade M√≠nima:</strong> ${recipe.variedadeMinima}
                            </div>
                            <div>
                                <strong>Repetir Ingrediente:</strong> ${recipe.repetir ? '‚úÖ Sim' : '‚ùå N√£o'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== SISTEMA DE RITOS (PALLACERDOTE) ==========

        window.openRitoModal = function() {
            document.getElementById('rito-modal').style.display = 'flex';
            
            // Limpar campos
            document.getElementById('rito-name').value = '';
            document.getElementById('rito-circulo').value = 'Di√°cono da Luz';
            document.getElementById('rito-teste').value = '';
            document.getElementById('rito-custo').value = '';
            document.getElementById('rito-efeito').value = '';
            document.getElementById('rito-falha').value = '';
        };

        window.closeRitoModal = function() {
            document.getElementById('rito-modal').style.display = 'none';
        };

        window.learnRito = function() {
            const char = getChar();
            
            // Verificar se tem EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < 1) {
                alert('‚ùå EXP Insuficiente!\n\nPrecisa: 1 EXP\nTem: ' + currentEXP + ' EXP');
                return;
            }
            
            // Pegar valores
            const name = document.getElementById('rito-name').value.trim();
            const circulo = document.getElementById('rito-circulo').value;
            const teste = document.getElementById('rito-teste').value.trim();
            const custo = document.getElementById('rito-custo').value.trim();
            const efeito = document.getElementById('rito-efeito').value.trim();
            const falha = document.getElementById('rito-falha').value.trim();
            
            // Validar
            if (!name) {
                alert('‚ùå Por favor, preencha o nome do rito!');
                return;
            }
            
            // Confirmar
            if (!confirm(`Aprender o rito "${name}"?\n\nCusto: 1 EXP\nEXP atual: ${currentEXP}`)) {
                return;
            }
            
            // Inicializar array se n√£o existir
            if (!char.ritos) {
                char.ritos = [];
            }
            
            // Adicionar rito
            const newRito = {
                id: Date.now(),
                name: name,
                circulo: circulo,
                teste: teste,
                custo: custo,
                efeito: efeito,
                falha: falha
            };
            
            char.ritos.push(newRito);
            char.exp = currentEXP - 1;
            
            // Atualizar display
            updateRitosList();
            updateEXPDisplay();
            closeRitoModal();
            autoSave();
            
            showAlert(`‚ú® Rito "${name}" aprendido! (-1 EXP)`, 'success');
        };

        window.removeRito = function(ritoId) {
            if (!confirm('‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è Remover este rito? ‚ö†Ô∏èüóëÔ∏è‚ö†Ô∏è')) return;
            
            const char = getChar();
            if (!char.ritos) char.ritos = [];
            
            char.ritos = char.ritos.filter(r => r.id !== ritoId);
            updateRitosList();
            autoSave();
            showAlert('‚úÖ Rito removido!', 'success');
        };

        function updateRitosList() {
            const ritosList = document.getElementById('ritos-list');
            if (!ritosList) return;
            
            const char = getChar();
            if (!char.ritos) char.ritos = [];
            
            if (char.ritos.length === 0) {
                ritosList.innerHTML = '<p style="color: #cbd5e1; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhum rito aprendido ainda. Clique em "Adicionar Rito" para aprender um novo rito.</p>';
                return;
            }
            
            ritosList.innerHTML = char.ritos.map(rito => {
                // Cores mais claras para Pallacerdote (tons dourados e amarelos brilhantes)
                const circuloColors = {
                    'Di√°cono da Luz': { border: '#fbbf24', bg: 'rgba(251, 191, 36, 0.15)' },
                    'S√°bio da Luz': { border: '#fde047', bg: 'rgba(253, 224, 71, 0.15)' },
                    'Bispo da Luz': { border: '#facc15', bg: 'rgba(250, 204, 21, 0.15)' }
                };
                const colors = circuloColors[rito.circulo] || circuloColors['Di√°cono da Luz'];
                
                return `
                    <div class="container-card" style="border-left: 4px solid ${colors.border}; margin-bottom: 15px; background: ${colors.bg};">
                        <div class="container-header">
                            <div class="container-name" style="color: ${colors.border};">‚ú® ${rito.name}</div>
                            <button class="btn btn-danger btn-small" onclick="removeRito(${rito.id})">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 15px; color: #f1f5f9; font-size: 0.9rem;">
                            <div style="margin-bottom: 10px; padding: 8px; background: rgba(251, 191, 36, 0.2); border-radius: 8px; border: 1px solid ${colors.border};">
                                <strong style="color: #fde047;">üåü C√≠rculo:</strong> 
                                <span style="color: ${colors.border}; font-weight: 700;">${rito.circulo}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fbbf24;">üé≤ Teste:</strong> 
                                <span style="color: #e2e8f0;">${rito.teste || 'N√£o especificado'}</span>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #fbbf24;">üíé Custo:</strong> 
                                <span style="color: #e2e8f0;">${rito.custo || 'Nenhum'}</span>
                            </div>
                            <div style="margin-bottom: 10px; padding: 10px; background: rgba(253, 224, 71, 0.1); border-radius: 8px; border-left: 3px solid #fde047;">
                                <strong style="color: #fde047;">‚ú® Efeito:</strong><br>
                                <span style="color: #f1f5f9;">${rito.efeito || 'Nenhum efeito descrito'}</span>
                            </div>
                            ${rito.falha ? `
                                <div style="padding: 10px; background: rgba(248, 113, 113, 0.1); border-radius: 8px; border-left: 3px solid #fca5a5;">
                                    <strong style="color: #fca5a5;">‚ùå Se Falha:</strong><br>
                                    <span style="color: #fecaca;">${rito.falha}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== SISTEMA DE GRA√áA (PALLACERDOTE) ==========

        function updateGracaCombate() {
            const char = getChar();
            const gracaSection = document.getElementById('graca-section');
            
            if (char.classe === 'Pallacerdote') {
                if (gracaSection) gracaSection.style.display = 'block';
                
                const essencia = char.skills['ess√™ncia'] || 0;
                const maxGraca = char.pre + essencia;
                const gracaAtual = char.gracaAtual || 0;
                
                const gracaInput = document.getElementById('graca-current');
                const gracaFill = document.getElementById('graca-combate-fill');
                const gracaText = document.getElementById('graca-combate-text');
                
                if (gracaInput) {
                    gracaInput.value = gracaAtual;
                    gracaInput.max = maxGraca;
                }
                
                if (gracaFill && gracaText) {
                    const percentage = maxGraca > 0 ? (gracaAtual / maxGraca) * 100 : 0;
                    gracaFill.style.width = percentage + '%';
                    gracaText.textContent = `${gracaAtual} / ${maxGraca}`;
                }
            } else {
                if (gracaSection) gracaSection.style.display = 'none';
            }
        }

        function updateGracaClasse() {
            const char = getChar();
            const essencia = char.skills['ess√™ncia'] || 0;
            const maxGraca = char.pre + essencia;
            const gracaAtual = char.gracaAtual || 0;
            
            const gracaClasseAtual = document.getElementById('graca-classe-atual');
            const gracaClasseMax = document.getElementById('graca-classe-max');
            const gracaClasseFill = document.getElementById('graca-classe-fill');
            
            if (gracaClasseAtual) gracaClasseAtual.textContent = gracaAtual;
            if (gracaClasseMax) gracaClasseMax.textContent = maxGraca;
            
            if (gracaClasseFill) {
                const percentage = maxGraca > 0 ? (gracaAtual / maxGraca) * 100 : 0;
                gracaClasseFill.style.width = percentage + '%';
                gracaClasseFill.querySelector('span').textContent = `${gracaAtual} / ${maxGraca}`;
            }
        }

        window.updateGracaBar = function() {
            const char = getChar();
            const essencia = char.skills['ess√™ncia'] || 0;
            const maxGraca = char.pre + essencia;
            const input = document.getElementById('graca-current');
            
            if (input) {
                let value = parseInt(input.value) || 0;
                value = Math.max(0, Math.min(value, maxGraca));
                char.gracaAtual = value;
                input.value = value;
            }
            
            updateGracaCombate();
            updateGracaClasse();
            autoSave();
        };

    </script>

    <!-- Modal de Adicionar Receita -->
    <div id="recipe-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: var(--dark); padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; border: 2px solid var(--primary);">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üß™ Nova Receita de Lo√ß√£o</h2>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #cbd5e1;">Nome da Receita:</label>
                <input type="text" id="recipe-name" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--darker); color: white;">
            </div>

            <div id="recipe-tipo-container" style="margin-bottom: 15px; display: none;">
                <label style="display: block; margin-bottom: 5px; color: #cbd5e1;">Tipo de Lo√ß√£o:</label>
                <select id="recipe-tipo" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--darker); color: white; cursor: pointer;">
                    <option value="Defensivo">üíö Defensivo</option>
                    <option value="Ofensivo">üíÄ Ofensivo</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #cbd5e1;">Dificuldade de Macerar:</label>
                <input type="number" id="recipe-macerar" min="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--darker); color: white;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #cbd5e1;">Propriedades:</label>
                <textarea id="recipe-props" rows="3" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--darker); color: white; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #cbd5e1;">Variedade M√≠nima:</label>
                <input type="number" id="recipe-variedade" min="0" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--darker); color: white;">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; color: #cbd5e1; cursor: pointer;">
                    <input type="checkbox" id="recipe-repetir" style="width: 20px; height: 20px;">
                    <span>Permitir repetir ingrediente</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="learnRecipe()" style="flex: 1;">‚úÖ Aprender Receita (1 EXP)</button>
                <button class="btn btn-secondary" onclick="closeRecipeModal()" style="flex: 1;">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar Rito -->
    <div id="rito-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); padding: 30px; border-radius: 20px; max-width: 600px; width: 100%; border: 3px solid #fbbf24; box-shadow: 0 0 40px rgba(251, 191, 36, 0.3);">
            <h2 style="margin-bottom: 25px; background: linear-gradient(135deg, #fbbf24, #fde047); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 1.8rem; text-align: center;">
                ‚ú® Novo Rito de Prece
            </h2>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">Nome do Rito:</label>
                <input type="text" id="rito-name" placeholder="Ex: Luz Curativa" 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.8); color: #fde047; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">C√≠rculo:</label>
                <select id="rito-circulo" 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.9); color: #fde047; font-size: 1rem; cursor: pointer;">
                    <option value="Di√°cono da Luz">‚≠ê Di√°cono da Luz</option>
                    <option value="S√°bio da Luz">‚ú® S√°bio da Luz</option>
                    <option value="Bispo da Luz">üåü Bispo da Luz</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">Teste:</label>
                <input type="text" id="rito-teste" placeholder="Ex: PRE + Ess√™ncia + S√≠mbolo Sagrado" 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.8); color: white; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">Custo:</label>
                <input type="text" id="rito-custo" placeholder="Ex: 1 Gra√ßa" 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.8); color: white; font-size: 1rem;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">Efeito:</label>
                <textarea id="rito-efeito" rows="4" placeholder="Descreva o efeito do rito..." 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.8); color: white; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #fde047; font-weight: 700;">Se Falha:</label>
                <textarea id="rito-falha" rows="2" placeholder="O que acontece se falhar no teste..." 
                    style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #fbbf24; background: rgba(15, 23, 42, 0.8); color: white; font-size: 1rem; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn" onclick="learnRito()" 
                    style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fbbf24, #fde047); color: #1e1b4b; border: none; font-weight: 900; font-size: 1.1rem; padding: 14px; border-radius: 12px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);">
                    ‚ú® Aprender Rito (1 EXP)
                </button>
                <button class="btn btn-secondary" onclick="closeRitoModal()" 
                    style="flex: 1; min-width: 200px; background: rgba(100, 116, 139, 0.5); padding: 14px; font-size: 1.1rem; border-radius: 12px;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

</body>
</html>
