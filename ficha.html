<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e1b4b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Lendas e Rel√≠quias - Ficha Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #8b5cf6;
            --secondary: #ec4899;
            --dark: #1e1b4b;
            --darker: #0f172a;
            --light: #f8fafc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 30px;
            border: 2px solid var(--primary);
            z-index: 9998;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: calc(100vw - 40px);
            flex-wrap: wrap;
        }

        .user-email {
            color: #cbd5e1;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .btn-logout {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-logout:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-logout:active {
            transform: scale(0.95);
        }

        @media (max-width: 639px) {
            .user-info {
                top: 5px;
                right: 5px;
                padding: 8px 12px;
                font-size: 0.75rem;
                gap: 8px;
            }

            .user-email {
                font-size: 0.7rem;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 70px;
            background: rgba(30, 27, 75, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        h1 {
            text-align: center;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 20px;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            padding: 0 10px;
        }

        .autosave-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-menu {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-menu:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-menu:active {
            transform: scale(0.95);
        }

        @media (max-width: 639px) {
            .btn-menu {
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }
        .autosave-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .autosave-indicator.saving {
            background: rgba(245, 158, 11, 0.9);
        }

        .autosave-indicator.error {
            background: rgba(239, 68, 68, 0.9);
        }

        @media (max-width: 639px) {
            .autosave-indicator {
                top: 60px;
                left: 10px;
                font-size: 0.7rem;
                padding: 6px 12px;
            }

            .container {
                margin-top: 80px;
            }
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scroll-behavior: smooth;
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .tab {
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            font-weight: 600;
            transition: all 0.3s;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: fit-content;
            touch-action: manipulation;
        }

        .tab:active {
            transform: scale(0.95);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: clamp(1.1rem, 4vw, 1.3rem);
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 2px;
            flex-shrink: 0;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        .grid-4 { grid-template-columns: 1fr; }

        @media (min-width: 640px) {
            .grid-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 1024px) {
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: repeat(4, 1fr); }
            .container { padding: 30px; }
            .section { padding: 20px; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            color: #cbd5e1;
        }

        input, select, textarea {
            padding: 14px 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--light);
            font-size: clamp(0.95rem, 3vw, 1rem);
            transition: all 0.3s;
            touch-action: manipulation;
            width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        textarea {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.6;
        }

        .attribute-group {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border);
        }

        .attribute-header {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attribute-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            gap: 10px;
        }

        .attribute-item:last-child {
            border-bottom: none;
        }

        .attribute-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
        }

        .attribute-code {
            color: #94a3b8;
            font-size: clamp(0.75rem, 2.2vw, 0.85rem);
            margin-left: 4px;
        }

        .dots {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            flex-wrap: nowrap;
        }

        .dot {
            width: 28px;
            height: 28px;
            min-width: 28px;
            min-height: 28px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            touch-action: manipulation;
        }

        .dot:active {
            transform: scale(1.15);
        }

        .dot.filled {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.6);
        }

        .skill-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 0.3s;
            gap: 8px;
        }

        .skill-item:active {
            background: rgba(139, 92, 246, 0.1);
        }

        .skill-item.inapto {
            opacity: 0.5;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }

        .skill-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
            min-width: 0;
        }

        .skill-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.85rem, 2.5vw, 0.95rem);
            line-height: 1.3;
        }

        .skill-attrs {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: #64748b;
            line-height: 1.2;
        }

        .skill-input {
            width: 100%;
            padding: 10px 12px;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            margin-top: 0;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid var(--border);
            border-radius: 6px;
            color: var(--light);
        }

        .skill-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .penalty {
            color: var(--danger);
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            font-weight: 600;
        }

        .characteristic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            border: 2px solid var(--primary);
            margin-bottom: 10px;
            gap: 10px;
        }

        .char-label {
            font-weight: 700;
            color: #e2e8f0;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
        }

        .char-formula {
            font-size: clamp(0.7rem, 2vw, 0.75rem);
            color: #64748b;
            margin-top: 4px;
        }

        .char-value {
            font-size: clamp(1.5rem, 5vw, 1.8rem);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            flex-shrink: 0;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.6);
            color: white;
            border: 2px solid var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 10px 14px;
            font-size: clamp(0.8rem, 2.5vw, 0.85rem);
            width: auto;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .button-group {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .button-group .btn {
                width: auto;
                flex: 1;
                min-width: 150px;
            }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            display: none;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--danger);
            color: var(--danger);
        }

        .exp-tracker {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .exp-value {
            font-size: clamp(2.5rem, 8vw, 3rem);
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.7);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-label {
            font-size: clamp(0.75rem, 2.2vw, 0.8rem);
            color: #94a3b8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: clamp(1.5rem, 5vw, 2rem);
            font-weight: 900;
            color: var(--primary);
        }

        .hp-bar-container {
            margin: 15px 0;
        }

        .hp-bar {
            width: 100%;
            height: 40px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 20px;
            overflow: hidden;
            border: 2px solid var(--border);
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .hp-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hp-controls input {
            width: 80px;
            text-align: center;
            padding: 10px 8px;
        }

        .combat-helper {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
        }

        .dice-roller {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dice-input {
            width: 80px;
        }

        .roll-result {
            font-size: clamp(1.8rem, 6vw, 2rem);
            font-weight: 900;
            color: var(--danger);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.7);
            min-width: 80px;
            text-align: center;
        }

        .container-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
            gap: 10px;
            flex-wrap: wrap;
        }

        .container-name {
            font-weight: 700;
            font-size: clamp(1rem, 3vw, 1.1rem);
            color: var(--primary);
        }

        .container-capacity {
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
            color: #94a3b8;
        }

        .container-capacity.overload {
            color: var(--danger);
            font-weight: 700;
        }

        .inventory-item {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 5px;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
        }

        .item-details {
            font-size: clamp(0.75rem, 2.2vw, 0.85rem);
            color: #94a3b8;
            word-wrap: break-word;
        }

        .class-ability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            gap: 10px;
        }

        .class-ability-name {
            font-weight: 600;
            color: #e2e8f0;
            font-size: clamp(0.9rem, 2.8vw, 1rem);
            flex: 1;
        }

        .test-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .test-name {
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 8px;
            font-size: clamp(0.95rem, 3vw, 1.05rem);
        }

        .test-formula {
            font-size: clamp(0.8rem, 2.3vw, 0.85rem);
            color: #94a3b8;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }

        .test-result {
            font-size: clamp(1.2rem, 4vw, 1.4rem);
            font-weight: 900;
            color: var(--warning);
            text-align: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
        }

        .resource-tracker {
            background: rgba(139, 92, 246, 0.15);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .resource-header {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: clamp(1rem, 3vw, 1.1rem);
        }

        .resource-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .resource-value {
            font-size: clamp(1.8rem, 6vw, 2.2rem);
            font-weight: 900;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
        }

        .info-box {
            background: rgba(245, 158, 11, 0.1);
            border: 2px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: clamp(0.8rem, 2.3vw, 0.85rem);
            color: #cbd5e1;
            line-height: 1.6;
        }

        .info-box strong {
            color: var(--warning);
        }

        @media (max-width: 639px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
                border-radius: 12px;
            }

            h1 {
                margin-bottom: 5px;
            }

            .subtitle {
                margin-bottom: 15px;
            }

            .tabs {
                gap: 4px;
                padding-bottom: 6px;
                margin-bottom: 15px;
            }

            .tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .section {
                padding: 10px;
                margin-bottom: 10px;
            }

            .section-title {
                margin-bottom: 10px;
                font-size: 1rem;
            }

            .attribute-group {
                padding: 8px;
            }

            .attribute-header {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .attribute-item {
                padding: 8px 0;
            }

            .dots {
                gap: 3px;
            }

            .dot {
                width: 26px;
                height: 26px;
                min-width: 26px;
                min-height: 26px;
                border-width: 2px;
            }

            .skill-item {
                padding: 8px;
                gap: 6px;
            }

            .skill-header {
                gap: 6px;
            }

            .skill-name {
                font-size: 0.85rem;
            }

            .skill-attrs {
                font-size: 0.7rem;
            }

            .hp-controls {
                gap: 6px;
            }

            .hp-controls input {
                width: 70px;
                padding: 8px 6px;
            }

            .hp-controls .btn-small {
                padding: 8px 10px;
                font-size: 0.75rem;
            }

            .button-group {
                padding-bottom: 20px;
            }

            textarea {
                min-height: 250px;
                font-size: 0.9rem;
            }
        }

        @media (min-width: 640px) and (max-width: 1023px) {
            .skill-header {
                flex-direction: row;
            }

            .dots {
                gap: 5px;
            }

            .dot {
                width: 30px;
                height: 30px;
                min-width: 30px;
                min-height: 30px;
            }
        }

        @media (min-width: 1024px) {
            .skill-item {
                flex-direction: row;
                align-items: center;
                padding: 12px;
            }

            .skill-header {
                flex: 1;
            }

            .skill-input {
                margin-top: 0;
            }

            .dot {
                width: 32px;
                height: 32px;
                min-width: 32px;
                min-height: 32px;
                border-width: 3px;
            }

            .dots {
                gap: 6px;
            }
        }

        html {
            scroll-behavior: smooth;
        }

        @media (min-width: 640px) {
            .container {
                background: rgba(30, 27, 75, 0.98);
            }

            .section {
                background: rgba(15, 23, 42, 0.8);
            }
        }
        
        .load-class-button {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            border: 3px solid #f59e0b;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        /* ESTILOS PARA UPLOAD DE IMAGEM */
        .character-image-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .character-image-preview {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid var(--primary);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .character-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-image-placeholder {
            font-size: 5rem;
            color: var(--primary);
            opacity: 0.3;
        }

        .image-upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .image-upload-label:active {
            transform: translateY(0);
        }

        #characterImageInput {
            display: none;
        }

        .btn-remove-image {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 2px solid var(--danger);
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-remove-image:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.05);
        }

    </style>
</head>
<body>
    <!-- TELA DE CARREGAMENTO -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">‚öîÔ∏è Carregando Ficha...</div>
    </div>

    <!-- INFORMA√á√ïES DO USU√ÅRIO -->
    <div class="user-info" id="userInfo" style="display: none;">
        <span class="user-email" id="userEmail">Carregando...</span>
        <button class="btn-menu" onclick="voltarMenu()">üìã MENU</button>
        <button class="btn-logout" onclick="logout()">üö™ SAIR</button>
    </div>

    <div class="autosave-indicator" id="autosaveIndicator">üíæ Salvando na nuvem...</div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>‚öîÔ∏è LENDAS E REL√çQUIAS ‚öîÔ∏è</h1>
        <p class="subtitle">Sistema de Ficha Digital com Firebase - Auto-Save na Nuvem ‚òÅÔ∏è</p>

        <div class="alert alert-success" id="alertSuccess"></div>
        <div class="alert alert-danger" id="alertError"></div>

        <div class="tabs" id="tabContainer">
            <button class="tab active" onclick="switchTab('basico')">üìã B√°sico</button>
            <button class="tab" onclick="switchTab('atributos')">üí™ Atributos</button>
            <button class="tab" onclick="switchTab('habilidades')">üéØ Habilidades</button>
            <button class="tab" onclick="switchTab('caracteristicas')">üìä Caracter√≠sticas</button>
            <button class="tab" onclick="switchTab('classe')">‚≠ê Classe</button>
            <button class="tab" onclick="switchTab('combate')">‚öîÔ∏è Combate</button>
            <button class="tab" onclick="switchTab('inventario')">üéí Invent√°rio</button>
            <button class="tab" onclick="switchTab('aliados')">üë• Aliados</button>
            <button class="tab" onclick="switchTab('propriedades')">üè† Propriedades</button>
            <button class="tab" onclick="switchTab('notas')">üìù Notas</button>
        </div>

        <!-- ABA B√ÅSICO -->
        <div id="basico" class="tab-content active">
            <div class="section">
                <h2 class="section-title">Imagem do Personagem</h2>
                <div class="character-image-section">
                    <div class="character-image-preview" id="characterImagePreview">
                        <div class="character-image-placeholder">üé≠</div>
                    </div>
                    <label for="characterImageInput" class="image-upload-label">
                        üì∑ Escolher Imagem
                    </label>
                    <input type="file" id="characterImageInput" accept="image/*">
                    <button class="btn-remove-image" id="removeImageBtn" style="display: none;" onclick="removeCharacterImage()">
                        üóëÔ∏è Remover Imagem
                    </button>
                    <p style="color: #94a3b8; font-size: 0.85rem; text-align: center;">
                        Formatos aceitos: JPG, PNG, GIF, WebP (m√°x. 2MB)
                    </p>
                </div>
                <h2 class="section-title">Informa√ß√µes B√°sicas</h2>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Nome do Personagem</label>
                        <input type="text" id="nome" placeholder="Digite o nome...">
                    </div>
                    <div class="form-group">
                        <label>Jogador</label>
                        <input type="text" id="jogador" placeholder="Seu nome...">
                    </div>
                    <div class="form-group">
                        <label>Idade</label>
                        <input type="number" id="idade" placeholder="0" inputmode="numeric">
                    </div>
                    <div class="form-group">
                        <label>Ra√ßa</label>
                        <select id="raca">
                            <option value="">Selecione...</option>
                            <option value="Humano">Humano</option>
                            <option value="Elorin">Elorin</option>
                            <option value="Karu-Selvagem">Karu-Selvagem</option>
                            <option value="Picxi">Picxi</option>
                            <option value="Yotun">Yotun</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Classe</label>
                        <select id="classe">
                            <option value="">Selecione...</option>
                            <option value="Ca√ßador">Ca√ßador</option>
                            <option value="Druida">Druida</option>
                            <option value="Guerreiro">Guerreiro</option>
                            <option value="Adepto">Adepto (Necromante)</option>
                            <option value="Ladino">Ladino</option>
                            <option value="Pallacerdote">Pallacerdote</option>
                            <option value="Ritualista">Ritualista (Abismancia)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Virtude</label>
                        <select id="virtude">
                            <option value="">Selecione...</option>
                            <option value="Caridade">Caridade</option>
                            <option value="Esperan√ßa">Esperan√ßa</option>
                            <option value="F√©">F√©</option>
                            <option value="Fortaleza">Fortaleza</option>
                            <option value="Justi√ßa">Justi√ßa</option>
                            <option value="Prud√™ncia">Prud√™ncia</option>
                            <option value="Temperan√ßa">Temperan√ßa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>V√≠cio</label>
                        <select id="vicio">
                            <option value="">Selecione...</option>
                            <option value="Avareza">Avareza</option>
                            <option value="Gula">Gula</option>
                            <option value="Inveja">Inveja</option>
                            <option value="Ira">Ira</option>
                            <option value="Lux√∫ria">Lux√∫ria</option>
                            <option value="Orgulho">Orgulho</option>
                            <option value="Pregui√ßa">Pregui√ßa</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Caracter√≠sticas Raciais</h2>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Tamanho</label>
                        <input type="number" id="tamanho" value="5" min="1" max="15" inputmode="numeric">
                    </div>

                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h2 class="section-title">‚≠ê Experi√™ncia (EXP)</h2>
                <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; text-align: center;">
                    <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">PONTOS DE EXP DISPON√çVEIS</div>
                    <div style="font-size: 3rem; font-weight: 900; color: #f59e0b; text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);" id="exp-display">0</div>
                    <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 8px;">XP</div>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(245, 158, 11, 0.3);">
                        <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 1rem;">üí° Custos de Evolu√ß√£o</h3>
                        <ul style="color: #cbd5e1; line-height: 1.8; font-size: 0.85rem; text-align: left; list-style: none; padding: 0;">
                            <li>‚ö° <strong>Atributos:</strong> (n√≠vel + 1) √ó 5 EXP</li>
                            <li>üéØ <strong>Habilidades:</strong> (n√≠vel + 1) √ó 4 EXP</li>
                            <li>‚≠ê <strong>Hab. Classe:</strong> (n√≠vel + 1) √ó 2 EXP</li>
                            <li>‚ú® <strong>Hab. Pallacerdote/Ritualista:</strong> (n√≠vel + 1) √ó 4 EXP</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA ATRIBUTOS -->
        <div id="atributos" class="tab-content">
            <div class="section">
                <h2 class="section-title">Atributos do Personagem</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Toque nas bolinhas para preencher/esvaziar.</p>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                        <thead>
                            <tr>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;"></th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">‚ö° Poder</th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">üéØ Refinamento</th>
                                <th style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-size: 1.1rem;">üõ°Ô∏è Resist√™ncia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üß† Mental</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Intelig√™ncia</span><br>
                                            <span class="attribute-code">[INT]</span>
                                        </div>
                                        <div class="dots" id="dots-int" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Racioc√≠nio</span><br>
                                            <span class="attribute-code">[RAC]</span>
                                        </div>
                                        <div class="dots" id="dots-rac" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Perseveran√ßa</span><br>
                                            <span class="attribute-code">[PRS]</span>
                                        </div>
                                        <div class="dots" id="dots-prs" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üí™ F√≠sico</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">For√ßa</span><br>
                                            <span class="attribute-code">[FOR]</span>
                                        </div>
                                        <div class="dots" id="dots-for" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Destreza</span><br>
                                            <span class="attribute-code">[DES]</span>
                                        </div>
                                        <div class="dots" id="dots-des" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Vigor</span><br>
                                            <span class="attribute-code">[VIG]</span>
                                        </div>
                                        <div class="dots" id="dots-vig" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; background: rgba(139, 92, 246, 0.2); border: 1px solid var(--border); font-weight: 700; font-size: 1rem;">üí¨ Social</td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Presen√ßa</span><br>
                                            <span class="attribute-code">[PRE]</span>
                                        </div>
                                        <div class="dots" id="dots-pre" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Manipula√ß√£o</span><br>
                                            <span class="attribute-code">[MAN]</span>
                                        </div>
                                        <div class="dots" id="dots-man" style="justify-content: center;"></div>
                                    </div>
                                </td>
                                <td style="padding: 12px; border: 1px solid var(--border);">
                                    <div class="attribute-item" style="flex-direction: column; gap: 8px;">
                                        <div style="text-align: center;">
                                            <span class="attribute-name">Autocontrole</span><br>
                                            <span class="attribute-code">[AUT]</span>
                                        </div>
                                        <div class="dots" id="dots-aut" style="justify-content: center;"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA HABILIDADES -->
        <div id="habilidades" class="tab-content">
            <div class="section">
                <h2 class="section-title">Habilidades</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Cada habilidade tem 5 n√≠veis. Toque nas bolinhas.</p>

                <div class="grid grid-3">
                    <div class="attribute-group">
                        <div class="attribute-header">üß† Mental <span class="penalty">(-3 se inapto)</span></div>
                        <div id="skills-mental"></div>
                    </div>

                    <div class="attribute-group">
                        <div class="attribute-header">üí™ F√≠sico <span class="penalty">(-1 se inapto)</span></div>
                        <div id="skills-fisico"></div>
                    </div>

                    <div class="attribute-group">
                        <div class="attribute-header">üí¨ Social <span class="penalty">(-1 se inapto)</span></div>
                        <div id="skills-social"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA CARACTER√çSTICAS -->
        <div id="caracteristicas" class="tab-content">
            <div class="section">
                <h2 class="section-title">Caracter√≠sticas</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">Calculadas automaticamente.</p>

                <div class="grid grid-2">
                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Iniciativa</div>
                            <div class="char-formula">RAC+DES+AUT+Agil-Tam</div>
                        </div>
                        <div class="char-value" id="calc-iniciativa">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Rea√ß√£o</div>
                            <div class="char-formula">Min(DES,RAC)+Agil</div>
                        </div>
                        <div class="char-value" id="calc-reacao">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Desloc. Terrestre</div>
                            <div class="char-formula">FOR+DES+Tam+Agil</div>
                        </div>
                        <div class="char-value" id="calc-deslocamento">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">VIT Max</div>
                            <div class="char-formula">VIG+Tamanho</div>
                        </div>
                        <div class="char-value" id="calc-vitalidade-max">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">DET Max</div>
                            <div class="char-formula">PRS+AUT</div>
                        </div>
                        <div class="char-value" id="calc-determinacao-max">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Carga Max</div>
                            <div class="char-formula">FOR+VIG</div>
                        </div>
                        <div class="char-value" id="calc-carga">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Sanidade</div>
                            <div class="char-formula">(INT+AUT-Abis√ó2)√ó10</div>
                        </div>
                        <div class="char-value" id="calc-sanidade">0</div>
                    </div>

                    <div class="characteristic-item">
                        <div>
                            <div class="char-label">Blindagem</div>
                            <div class="char-formula">Armadura</div>
                        </div>
                        <div class="char-value" id="calc-blindagem">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA CLASSE -->
        <div id="classe" class="tab-content">
            <div class="load-class-button">
                <h2 style="font-size: clamp(1.3rem, 4vw, 1.6rem); margin-bottom: 10px; font-weight: 900;">üî• CARREGAR CLASSE üî•</h2>
                <p style="margin-bottom: 15px; font-size: clamp(0.85rem, 2.5vw, 0.95rem);">Selecione sua classe na aba B√°sico e clique abaixo</p>
                <button class="btn" onclick="forceLoadClass()" style="background: white; color: #d97706; font-size: clamp(1rem, 3vw, 1.2rem); padding: 18px 36px; max-width: 400px; margin: 0 auto;">
                    ‚öîÔ∏è CARREGAR AGORA
                </button>
            </div>
            
            <div id="class-content"></div>
        </div>

        <!-- ABA COMBATE -->
        <div id="combate" class="tab-content">
            <div class="section">
                <h2 class="section-title">Status de Combate</h2>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">‚ù§Ô∏è Vitalidade</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="hp-fill" style="width: 100%;">
                            <span id="hp-text">5 / 5</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustHP(-1)">-1</button>
                        <button class="btn btn-secondary btn-small" onclick="adjustHP(-5)">-5</button>
                        <input type="number" id="hp-current" value="5" onchange="updateHPBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustHP(1)">+1</button>
                        <button class="btn btn-primary btn-small" onclick="adjustHP(5)">+5</button>
                        <button class="btn btn-secondary btn-small" onclick="resetHP()">Max</button>
                    </div>
                </div>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">‚ö° Determina√ß√£o</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="det-fill" style="width: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary));">
                            <span id="det-text">3 / 3</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustDET(-1)">-1</button>
                        <input type="number" id="det-current" value="3" onchange="updateDETBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustDET(1)">+1</button>
                        <button class="btn btn-secondary btn-small" onclick="resetDET()">Max</button>
                    </div>
                </div>

                <div class="hp-bar-container">
                    <label style="margin-bottom: 10px; display: block; font-weight: 700;">üß† Sanidade</label>
                    <div class="hp-bar">
                        <div class="hp-fill" id="san-fill" style="width: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6);">
                            <span id="san-text">100 / 100</span>
                        </div>
                    </div>
                    <div class="hp-controls">
                        <button class="btn btn-secondary btn-small" onclick="adjustSAN(-1)">-1</button>
                        <button class="btn btn-secondary btn-small" onclick="adjustSAN(-5)">-5</button>
                        <input type="number" id="san-current" value="100" onchange="updateSANBar()" inputmode="numeric">
                        <button class="btn btn-primary btn-small" onclick="adjustSAN(1)">+1</button>
                        <button class="btn btn-primary btn-small" onclick="adjustSAN(5)">+5</button>
                        <button class="btn btn-secondary btn-small" onclick="resetSAN()">Max</button>
                    </div>
                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h2 class="section-title">‚ö†Ô∏è Condi√ß√µes</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Adicione condi√ß√µes que afetam seu personagem (Ex: Fadiga, Fratura, Envenenado, etc.)
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addCondition()">‚ûï Adicionar Condi√ß√£o</button>
                </div>

                <div id="conditions-list"></div>
            </div>

            <div class="section" id="alliesCombatSection" style="display: none; margin-top: 20px;">
                <h2 class="section-title">üë• Status dos Aliados</h2>
                <div id="allies-combat-list"></div>
            </div>

            <div class="combat-helper">
                <h3 style="color: var(--danger); margin-bottom: 12px; font-size: 1.1rem;">üé≤ Rolador de Dados</h3>
                <p style="color: #94a3b8; margin-bottom: 12px; font-size: 0.85rem;">Sucessos: 8, 9, 10. Falha: 1.</p>
                <div class="dice-roller">
                    <div class="form-group" style="width: auto;">
                        <label>Dados</label>
                        <input type="number" id="dice-count" class="dice-input" value="1" min="1" max="20" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary btn-small" onclick="rollDice()" style="flex: 1;">üé≤ ROLAR</button>
                    <div class="roll-result" id="roll-result">‚Äî</div>
                </div>
                <div id="roll-details" style="margin-top: 12px; color: #94a3b8; font-size: 0.85rem;"></div>
            </div>
        </div>

        <!-- ABA INVENT√ÅRIO -->
        <div id="inventario" class="tab-content">
            <div class="section">
                <h2 class="section-title">üí∞ LUNS (DINHEIRO)</h2>
                
                <div style="background: rgba(245, 158, 11, 0.1); border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="color: #94a3b8; font-size: 0.9rem; margin-bottom: 8px;">SALDO ATUAL</div>
                        <div style="font-size: 2.5rem; font-weight: 900; color: #f59e0b; text-shadow: 0 2px 10px rgba(245, 158, 11, 0.3);" id="luns-display">0</div>
                        <div style="color: #94a3b8; font-size: 0.85rem; margin-top: 5px;">Luns</div>
                    </div>
                    
                    <div style="border-top: 1px solid rgba(245, 158, 11, 0.3); padding-top: 15px; margin-top: 15px;">
                        <label style="display: block; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px; font-weight: 600;">
                            ‚öñÔ∏è Valor da Transa√ß√£o
                        </label>
                        <input type="number" id="luns-transaction" value="0" min="0" inputmode="numeric" 
                               placeholder="Digite o valor..." 
                               style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border); background: rgba(15, 23, 42, 0.8); color: var(--light); font-size: 1.1rem; font-weight: 700; text-align: center;">
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="addLuns()" style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #10b981, #059669); font-size: 1rem; padding: 14px;">
                                ‚ûï SOMAR
                            </button>
                            <button class="btn btn-danger" onclick="subtractLuns()" style="flex: 1; min-width: 120px; font-size: 1rem; padding: 14px;">
                                ‚ûñ RETIRAR
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                            <button class="btn btn-secondary btn-small" onclick="quickLunsTransaction(10)" style="min-width: 60px;">+10</button>
                            <button class="btn btn-secondary btn-small" onclick="quickLunsTransaction(50)" style="min-width: 60px;">+50</button>
                            <button class="btn btn-secondary btn-small" onclick="quickLunsTransaction(100)" style="min-width: 60px;">+100</button>
                            <button class="btn btn-secondary btn-small" onclick="quickLunsTransaction(500)" style="min-width: 60px;">+500</button>
                        </div>
                        
                        <p style="color: #94a3b8; font-size: 0.8rem; margin-top: 12px; text-align: center; font-style: italic;">
                            üí° Digite o valor e clique em Somar ou Retirar. Use os bot√µes r√°pidos para valores comuns.
                        </p>
                    </div>
                </div>
                
                <!-- Campo oculto para manter compatibilidade -->
                <input type="number" id="luns" value="0" min="0" style="display: none;">
            </div>

            <div class="section">
                <h2 class="section-title">Sistema de Invent√°rio</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addContainer()">‚ûï Adicionar Container</button>
                </div>

                <div id="containers-list"></div>
            </div>
        </div>

        <!-- ABA ALIADOS -->
        <div id="aliados" class="tab-content">
            <div class="section">
                <h2 class="section-title">üë• Aliados</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Gerencie seus aliados, companheiros e montarias. Clique em um aliado para editar sua ficha completa.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addAlly()">‚ûï Adicionar Aliado</button>
                </div>

                <div id="allies-list"></div>
            </div>
        </div>

        <!-- ABA PROPRIEDADES -->
        <div id="propriedades" class="tab-content">
            <div class="section">
                <h2 class="section-title">üè† Propriedades</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Gerencie suas propriedades, im√≥veis, estabelecimentos e ve√≠culos. Clique em uma propriedade para editar seus detalhes completos.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="addProperty()">‚ûï Adicionar Propriedade</button>
                </div>

                <div id="properties-list"></div>
            </div>
        </div>

        <!-- ABA NOTAS -->
        <div id="notas" class="tab-content">
            <div class="section">
                <h2 class="section-title">Notas do Personagem</h2>
                <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                    Escreva suas anota√ß√µes, hist√≥rias, objetivos ou qualquer informa√ß√£o importante sobre seu personagem.
                    Suas notas s√£o salvas automaticamente na nuvem e exportadas junto com a ficha.
                </p>
                
                <div class="form-group">
                    <textarea id="notas-textarea" placeholder="Digite suas notas aqui...

Exemplos:
- Background do personagem
- Objetivos e miss√µes
- NPCs importantes
- Itens especiais
- Estrat√©gias de combate
- Anota√ß√µes da sess√£o"></textarea>
                </div>
            </div>
        </div>

        </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        // ============= CONFIGURA√á√ÉO FIREBASE =============
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyA6r79XcsMr3KZUT1YZ8vQntIGspgULXcE",
          authDomain: "rpg-lendasereliquias.firebaseapp.com",
          projectId: "rpg-lendasereliquias",
          storageBucket: "rpg-lendasereliquias.firebasestorage.app",
          messagingSenderId: "546994339773",
          appId: "1:546994339773:web:0116cf7c8667f113075cd4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentCharacterId = null;

        /**
         * Garante que o documento do personagem tenha o ownerUid definido para o usu√°rio atual.
         * Sempre utiliza merge para evitar sobrescrever campos existentes.
         * @param {import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js').DocumentReference} characterRef
         */
        async function ensureOwnerUid(characterRef) {
            const user = auth.currentUser;
            if (!user) {
                throw new Error('N√£o autenticado.');
            }

            const snap = await getDoc(characterRef);
            if (!snap.exists()) {
                await setDoc(characterRef, { ownerUid: user.uid }, { merge: true });
                return;
            }

            const data = snap.data() || {};
            if (!data.ownerUid) {
                await setDoc(characterRef, { ownerUid: user.uid }, { merge: true });
            }
        }

        // ============= VERIFICAR AUTENTICA√á√ÉO =============
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ Usu√°rio logado:', user.email);
                
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                await loadFromFirebase();
                init();
            } else {
                console.log('‚ùå Usu√°rio n√£o autenticado. Redirecionando...');
                window.location.href = 'index.html';
            }
        });

        // ============= LOGOUT =============
        window.logout = async function() {
            if (confirm('üö™ Tem certeza que deseja sair?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    showAlert('‚ùå Erro ao sair. Tente novamente.', 'danger');
                }
            }
        };

        // ============= VOLTAR PARA MENU =============
        window.voltarMenu = function() {
            if (confirm('üìã Voltar para o menu de personagens?')) {
                window.location.href = 'personagens.html';
            }
        };

        // ============= SALVAR NO FIREBASE =============
        window.saveToFirebase = async function() {
            if (!currentUser) return;
            
            const indicator = document.getElementById('autosaveIndicator');
            indicator.textContent = 'üíæ Salvando...';
            indicator.classList.add('show', 'saving');
            
            try {
                const char = getChar();
                const characterId = currentCharacterId || currentUser.uid;  // USE currentCharacterId
                const userDoc = doc(db, 'characters', characterId);

                await ensureOwnerUid(userDoc);

                await setDoc(userDoc, {
                    ...char,
                    ownerUid: currentUser.uid,
                    lastUpdate: new Date().toISOString(),
                    userEmail: currentUser.email
                }, { merge: true });
                
                indicator.textContent = '‚úÖ Salvo na nuvem!';
                indicator.classList.remove('saving', 'error');
                indicator.classList.add('show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                indicator.textContent = '‚ùå Erro ao salvar!';
                indicator.classList.remove('saving');
                indicator.classList.add('error', 'show');
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        };

        // ============= CARREGAR DO FIREBASE =============
        async function loadFromFirebase() {
            if (!currentUser) return;
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const characterId = urlParams.get('id') || currentUser.uid;
                currentCharacterId = characterId;
                const userDoc = doc(db, 'characters', characterId);
                const docSnap = await getDoc(userDoc);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log('‚úÖ Ficha carregada do Firebase:', data);
                    
                    delete data.lastUpdate;
                    delete data.userEmail;
                    
                    window.character = {
                        ...window.character,
                        ...data,
                        allies: data.allies || [],
                        properties: data.properties || []
                    };
                    
                    showAlert('‚úÖ Ficha carregada da nuvem!', 'success');
                } else {
                    console.log('üìù Primeira vez! Criando ficha nova...');
                    showAlert('üìù Bem-vindo! Crie seu personagem.', 'success');
                }
            } catch (error) {
                console.error('Erro ao carregar ficha:', error);
                showAlert('‚ö†Ô∏è Erro ao carregar ficha. Usando dados locais.', 'danger');
            }
        }

        // ============= ALIADOS =============
        window.addAlly = function() {
            const char = getChar();
            const nome = prompt('Nome do aliado:');
            if (!nome) return;
            
            const allyId = 'ally-' + Date.now();
            
            if (!char.allies) char.allies = [];
            
            char.allies.push({
                id: allyId,
                nome: nome,
                tipoRaca: '',
                funcao: '',
                idade: 0,
                virtude: '',
                vicio: '',
                lealdade: 3,
                auraImortalidade: 0,
                tamanho: 5,
                int: 1, for: 1, pre: 1, rac: 1, des: 1, man: 1, prs: 1, vig: 1, aut: 1,
                blindagem: 0,
                hpCurrent: 5,
                sanCurrent: 100,
                ataquesTalentos: '',
                inventario: [],
                notas: ''
            });
            
            updateAlliesList();
            updateAlliesCombat();
            autoSave();
            showAlert('‚úÖ Aliado criado! Clique nele para editar detalhes.', 'success');
        };

        window.removeAlly = function(allyId) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja remover este aliado permanentemente?')) return;
            
            const char = getChar();
            char.allies = char.allies.filter(a => a.id !== allyId);
            updateAlliesList();
            updateAlliesCombat();
            autoSave();
            showAlert('üóëÔ∏è Aliado removido!', 'success');
        };

        window.openAlly = function(allyId) {
            const urlParams = new URLSearchParams(window.location.search);
            const characterId = urlParams.get('id') || currentUser.uid;
            window.location.href = `aliado.html?characterId=${characterId}&allyId=${allyId}`;
        };

        function updateAlliesList() {
            const char = getChar();
            const list = document.getElementById('allies-list');
            
            if (!char.allies || char.allies.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhum aliado ainda. Adicione um companheiro, montaria ou servo!</p>';
                return;
            }
            
            list.innerHTML = char.allies.map(ally => {
                const vitalidadeMax = (ally.vig || 1) + (ally.tamanho || 5);
                const sanidadeMax = ((ally.int || 1) + (ally.aut || 1)) * 10;
                const hpPercent = Math.round(((ally.hpCurrent || 5) / vitalidadeMax) * 100);
                const sanPercent = Math.round(((ally.sanCurrent || 100) / sanidadeMax) * 100);
                
                return `
                    <div class="container-card" style="cursor: pointer;" onclick="openAlly('${ally.id}')">
                        <div class="container-header">
                            <div class="container-name">üë§ ${ally.nome || 'Sem nome'}</div>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeAlly('${ally.id}')">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">
                                <strong>Tipo:</strong> ${ally.tipoRaca || '‚Äî'} | 
                                <strong>Fun√ß√£o:</strong> ${ally.funcao || '‚Äî'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    ‚ù§Ô∏è Vitalidade: ${ally.hpCurrent || 5} / ${vitalidadeMax} (${hpPercent}%)
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${hpPercent}%; height: 100%; background: linear-gradient(90deg, var(--danger), var(--success)); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    üß† Sanidade: ${ally.sanCurrent || 100} / ${sanidadeMax} (${sanPercent}%)
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${sanPercent}%; height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 12px; border-top: 1px solid var(--border); text-align: center; color: var(--primary); font-weight: 600; font-size: 0.85rem;">
                            ‚úèÔ∏è CLIQUE PARA EDITAR FICHA COMPLETA
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Expor fun√ß√£o para uso global
        window.updateAlliesList = updateAlliesList;

        function updateAlliesCombat() {
            const char = getChar();
            const section = document.getElementById('alliesCombatSection');
            const list = document.getElementById('allies-combat-list');
            
            if (!char.allies || char.allies.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            list.innerHTML = char.allies.map(ally => {
                const vitalidadeMax = (ally.vig || 1) + (ally.tamanho || 5);
                const sanidadeMax = ((ally.int || 1) + (ally.aut || 1)) * 10;
                
                return `
                    <div style="background: rgba(15, 23, 42, 0.6); border: 2px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px;">
                        <div style="font-weight: 700; color: var(--light); font-size: 1.1rem; margin-bottom: 12px;">
                            üë§ ${ally.nome || 'Sem nome'}
                        </div>
                        
                        <!-- Vitalidade -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">‚ù§Ô∏è Vitalidade</label>
                            <div class="hp-bar">
                                <div class="hp-fill" id="ally-hp-fill-${ally.id}" style="width: ${(ally.hpCurrent / vitalidadeMax) * 100}%;">
                                    <span id="ally-hp-text-${ally.id}">${ally.hpCurrent} / ${vitalidadeMax}</span>
                                </div>
                            </div>
                            <div class="hp-controls">
                                <button class="btn btn-secondary btn-small" onclick="adjustAllyHP('${ally.id}', -1)">-1</button>
                                <button class="btn btn-secondary btn-small" onclick="adjustAllyHP('${ally.id}', -5)">-5</button>
                                <input type="number" id="ally-hp-${ally.id}" value="${ally.hpCurrent}" onchange="updateAllyHPBar('${ally.id}')" inputmode="numeric" style="width: 80px; text-align: center; padding: 8px;">
                                <button class="btn btn-primary btn-small" onclick="adjustAllyHP('${ally.id}', 1)">+1</button>
                                <button class="btn btn-primary btn-small" onclick="adjustAllyHP('${ally.id}', 5)">+5</button>
                                <button class="btn btn-secondary btn-small" onclick="resetAllyHP('${ally.id}')">Max</button>
                            </div>
                        </div>
                        
                        <!-- Sanidade -->
                        <div>
                            <label style="display: block; font-weight: 700; margin-bottom: 8px;">üß† Sanidade</label>
                            <div class="hp-bar">
                                <div class="hp-fill" id="ally-san-fill-${ally.id}" style="width: ${(ally.sanCurrent / sanidadeMax) * 100}%; background: linear-gradient(90deg, #6366f1, #8b5cf6);">
                                    <span id="ally-san-text-${ally.id}">${ally.sanCurrent} / ${sanidadeMax}</span>
                                </div>
                            </div>
                            <div class="hp-controls">
                                <button class="btn btn-secondary btn-small" onclick="adjustAllySAN('${ally.id}', -1)">-1</button>
                                <button class="btn btn-secondary btn-small" onclick="adjustAllySAN('${ally.id}', -5)">-5</button>
                                <input type="number" id="ally-san-${ally.id}" value="${ally.sanCurrent}" onchange="updateAllySANBar('${ally.id}')" inputmode="numeric" style="width: 80px; text-align: center; padding: 8px;">
                                <button class="btn btn-primary btn-small" onclick="adjustAllySAN('${ally.id}', 1)">+1</button>
                                <button class="btn btn-primary btn-small" onclick="adjustAllySAN('${ally.id}', 5)">+5</button>
                                <button class="btn btn-secondary btn-small" onclick="resetAllySAN('${ally.id}')">Max</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Expor fun√ß√£o para uso global
        window.updateAlliesCombat = updateAlliesCombat;

        window.adjustAllyHP = function(allyId, amount) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            ally.hpCurrent = Math.max(0, Math.min((ally.hpCurrent || 5) + amount, max));
            
            updateAllyHPBar(allyId);
            updateAlliesList();
            autoSave();
        };

        window.updateAllyHPBar = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            const input = document.getElementById(`ally-hp-${allyId}`);
            if (input) {
                ally.hpCurrent = Math.max(0, Math.min(parseInt(input.value) || 0, max));
                input.value = ally.hpCurrent;
            }
            
            const fill = document.getElementById(`ally-hp-fill-${allyId}`);
            const text = document.getElementById(`ally-hp-text-${allyId}`);
            if (fill && text) {
                const percent = (ally.hpCurrent / max) * 100;
                fill.style.width = percent + '%';
                text.textContent = `${ally.hpCurrent} / ${max}`;
            }
            
            updateAlliesList();
            autoSave();
        };

        window.resetAllyHP = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = (ally.vig || 1) + (ally.tamanho || 5);
            ally.hpCurrent = max;
            updateAllyHPBar(allyId);
        };

        window.adjustAllySAN = function(allyId, amount) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = ((ally.int || 1) + (ally.aut || 1)) * 10;
            ally.sanCurrent = Math.max(0, Math.min((ally.sanCurrent || 100) + amount, max));
            
            updateAllySANBar(allyId);
            updateAlliesList();
            autoSave();
        };

        window.updateAllySANBar = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = ((ally.int || 1) + (ally.aut || 1)) * 10;
            const input = document.getElementById(`ally-san-${allyId}`);
            if (input) {
                ally.sanCurrent = Math.max(0, Math.min(parseInt(input.value) || 0, max));
                input.value = ally.sanCurrent;
            }
            
            const fill = document.getElementById(`ally-san-fill-${allyId}`);
            const text = document.getElementById(`ally-san-text-${allyId}`);
            if (fill && text) {
                const percent = (ally.sanCurrent / max) * 100;
                fill.style.width = percent + '%';
                text.textContent = `${ally.sanCurrent} / ${max}`;
            }
            
            updateAlliesList();
            autoSave();
        };

        window.resetAllySAN = function(allyId) {
            const char = getChar();
            const ally = char.allies.find(a => a.id === allyId);
            if (!ally) return;
            
            const max = ((ally.int || 1) + (ally.aut || 1)) * 10;
            ally.sanCurrent = max;
            updateAllySANBar(allyId);
        };

        // ============= PROPRIEDADES =============
        window.addProperty = function() {
            const char = getChar();
            const nome = prompt('Nome da propriedade:');
            if (!nome) return;
            
            const propertyId = 'property-' + Date.now();
            
            if (!char.properties) char.properties = [];
            
            char.properties.push({
                id: propertyId,
                nome: nome,
                tipo: '',
                categoria: '',
                localizacao: '',
                tamanho: '',
                estado: '',
                material: '',
                qualidade: '',
                integridade: 100,
                blindagem: 0,
                conforto: 0,
                saneamento: 0,
                seguranca: 0,
                capPessoas: 0,
                capCarga: 0,
                notoriedade: 0,
                receita: 0,
                despesas: 0,
                impostos: 0,
                modulos: {},
                modulosSobre: '',
                protocolos: '',
                horarioOperacao: '',
                funcionarios: [],
                inventario: [],
                portas: 1,
                janelas: 0,
                passagensSecretas: 0,
                trancas: '',
                alarmes: '',
                riscosLocais: '',
                pendenciasAtuais: '',
                reputacao: '',
                dataAquisicao: '',
                proprietariosAnteriores: '',
                ocorrenciasMarcantes: '',
                upgrades: [],
                notas: ''
            });
            
            updatePropertiesList();
            autoSave();
            showAlert('‚úÖ Propriedade criada! Clique nela para editar detalhes.', 'success');
        };

        window.removeProperty = function(propertyId) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja remover esta propriedade permanentemente?')) return;
            
            const char = getChar();
            char.properties = char.properties.filter(p => p.id !== propertyId);
            updatePropertiesList();
            autoSave();
            showAlert('üóëÔ∏è Propriedade removida!', 'success');
        };

        window.openProperty = function(propertyId) {
            const urlParams = new URLSearchParams(window.location.search);
            const characterId = urlParams.get('id') || currentUser.uid;
            window.location.href = `propriedade.html?characterId=${characterId}&propertyId=${propertyId}`;
        };

        function updatePropertiesList() {
            const char = getChar();
            const list = document.getElementById('properties-list');
            
            if (!char.properties || char.properties.length === 0) {
                list.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhuma propriedade ainda. Adicione uma taverna, casa, oficina ou estabelecimento!</p>';
                return;
            }
            
            list.innerHTML = char.properties.map(property => {
                const integPercent = Math.round((property.integridade / 100) * 100);
                let integColor = 'var(--success)';
                if (integPercent < 30) integColor = 'var(--danger)';
                else if (integPercent < 70) integColor = 'var(--warning)';
                
                return `
                    <div class="container-card" style="cursor: pointer;" onclick="openProperty('${property.id}')">
                        <div class="container-header">
                            <div class="container-name">üè† ${property.nome || 'Sem nome'}</div>
                            <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); removeProperty('${property.id}')">üóëÔ∏è</button>
                        </div>
                        <div style="padding: 12px;">
                            <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">
                                <strong>Tipo:</strong> ${property.tipo || '‚Äî'} | 
                                <strong>Localiza√ß√£o:</strong> ${property.localizacao || '‚Äî'}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="color: #cbd5e1; font-size: 0.85rem; margin-bottom: 4px;">
                                    üèóÔ∏è Integridade: ${property.integridade}% | 
                                    üõ°Ô∏è Blindagem: ${property.blindagem}
                                </div>
                                <div style="width: 100%; height: 8px; background: rgba(15, 23, 42, 0.8); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${integPercent}%; height: 100%; background: ${integColor}; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 0.8rem; color: #94a3b8;">
                                <div>‚≠ê Qualidade: ${property.qualidade || '‚Äî'}</div>
                                <div>üë• Cap: ${property.capPessoas || 0}</div>
                                <div>üì¶ Carga: ${property.capCarga || 0}</div>
                            </div>
                        </div>
                        <div style="padding: 12px; border-top: 1px solid var(--border); text-align: center; color: var(--primary); font-weight: 600; font-size: 0.85rem;">
                            ‚úèÔ∏è CLIQUE PARA EDITAR DETALHES COMPLETOS
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.updatePropertiesList = updatePropertiesList;

        // Expor fun√ß√µes para uso global
        window.updateAlliesList = updateAlliesList;
        window.updatePropertiesList = updatePropertiesList;
        window.updateAlliesCombat = updateAlliesCombat;
    </script>

    <!-- L√ìGICA DO SISTEMA -->
    <script>
        // ============= DADOS DO SISTEMA =============
        const SKILLS = {
            mental: [
                { name: 'Abismo', attr: '[PRS]', penalty: -3, hasInput: false },
                { name: 'Alquimia', attr: '[RAC]', penalty: -3, hasInput: false },
                { name: 'Ess√™ncia', attr: '[INT/RAC/PRS]', penalty: -3, hasInput: false },
                { name: 'Herbalismo', attr: '[INT/PRS]', penalty: -3, hasInput: false },
                { name: 'Hist√≥ria', attr: '[INT]', penalty: -3, hasInput: false },
                { name: 'Investiga√ß√£o', attr: '[INT/RAC]', penalty: -3, hasInput: false },
                { name: 'Of√≠cio Intelectual', attr: '', penalty: -3, hasInput: true, placeholder: 'Ex: Escriba, Cart√≥grafo...' },
                { name: 'Rel√≠quia', attr: '[INT]', penalty: -3, hasInput: false },
                { name: 'Runomancia', attr: '[INT/RAC]', penalty: -3, hasInput: false }
            ],
            fisico: [
                { name: 'Arma', attr: '[FOR/DES]', penalty: -1, hasInput: false },
                { name: 'Disparo', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Atletismo', attr: '[VIG]', penalty: -1, hasInput: false },
                { name: 'Briga', attr: '[FOR]', penalty: -1, hasInput: false },
                { name: 'Agilidade', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Furtividade', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Montaria', attr: '[DES]', penalty: -1, hasInput: false },
                { name: 'Of√≠cio Bra√ßal', attr: '', penalty: -1, hasInput: true, placeholder: 'Ex: Ferreiro, Lenhador...' },
                { name: 'Sobreviv√™ncia', attr: '[VIG]', penalty: -1, hasInput: false }
            ],
            social: [
                { name: 'Barganha', attr: '[MAN]', penalty: -1, hasInput: false },
                { name: 'Diplomacia', attr: '[MAN]', penalty: -1, hasInput: false },
                { name: 'Domar', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Empatia', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Intimida√ß√£o', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Lideran√ßa', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Malandragem', attr: '[AUT]', penalty: -1, hasInput: false },
                { name: 'Performance', attr: '[PRE]', penalty: -1, hasInput: false },
                { name: 'Sedu√ß√£o', attr: '[MAN]', penalty: -1, hasInput: false }
            ]
        };

        const CLASS_ABILITIES = {
            'Ca√ßador': {
                abilities: [
                    { id: 'erudi√ß√£o-ofensiva', name: 'Erudi√ß√£o Ofensiva', maxLevel: 5 },
                    { id: 'macera√ß√£o', name: 'Macera√ß√£o', maxLevel: 5 },
                    { id: 'dosagem', name: 'Dosagem', maxLevel: 5 },
                    { id: 'precis√£o', name: 'Precis√£o', maxLevel: 5 },
                    { id: 'marcar-presa', name: 'Marcar Presa', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Disparo', formula: 'DES + Disparo + Precis√£o + Equipamento', calculate: (char) => {
                        const disparo = char.skills['disparo'] || 0;
                        const precisao = char.classAbilities?.['precis√£o'] || 0;
                        return char.des + disparo + precisao;
                    }},
                    { name: 'Disparo Furtivo', formula: 'DES + Disparo + Furtividade + Precis√£o', calculate: (char) => {
                        const disparo = char.skills['disparo'] || 0;
                        const furtividade = char.skills['furtividade'] || 0;
                        const precisao = char.classAbilities?.['precis√£o'] || 0;
                        return char.des + disparo + furtividade + precisao;
                    }},
                    { name: 'Rastreamento', formula: 'RAC + PRE + Sobreviv√™ncia', calculate: (char) => {
                        const sobrevivencia = char.skills['sobreviv√™ncia'] || 0;
                        return char.rac + char.pre + sobrevivencia;
                    }},
                    { name: 'Preparar Lo√ß√£o', formula: 'RAC + Herbalismo + Macera√ß√£o', calculate: (char) => {
                        const herbalismo = char.skills['herbalismo'] || 0;
                        const maceracao = char.classAbilities?.['macera√ß√£o'] || 0;
                        return char.rac + herbalismo + maceracao;
                    }},
                    { name: 'Dosagem', formula: 'INT + Herbalismo + Dosagem', calculate: (char) => {
                        const herbalismo = char.skills['herbalismo'] || 0;
                        const dosagem = char.classAbilities?.['dosagem'] || 0;
                        return char.int + herbalismo + dosagem;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'kits-ingredientes', name: 'Kits/Ingredientes', max: 10, info: 'Usados na prepara√ß√£o de lo√ß√µes' }
                ],
                info: `<strong>Papel:</strong> Rastreio, combate √† dist√¢ncia e alquimancia ofensiva.<br>
                    <strong>Recursos:</strong> Determina√ß√£o + Kits/Ingredientes.<br>
                    <strong>Marca de Ca√ßa:</strong> Ganhe (1 + Marcar Presa) em rastreamento e ataques contra o alvo marcado.<br>
                    <strong>Dica:</strong> Prepare lo√ß√µes antes do combate e marque os inimigos mais perigosos.`
            },
            'Druida': {
                abilities: [
                    { id: 'erudi√ß√£o-ofensiva', name: 'Erudi√ß√£o Ofensiva', maxLevel: 5 },
                    { id: 'erudi√ß√£o-defensiva', name: 'Erudi√ß√£o Defensiva', maxLevel: 5 },
                    { id: 'macera√ß√£o', name: 'Macera√ß√£o', maxLevel: 5 },
                    { id: 'dosagem', name: 'Dosagem', maxLevel: 5 },
                    { id: 'aliado-animal', name: 'Aliado Animal', maxLevel: 5 },
                    { id: 'linguagem-animal', name: 'Linguagem Animal', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Domar Aliado', formula: 'PRE + Domar + Aliado Animal', calculate: (char) => {
                        const domar = char.skills['domar'] || 0;
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        return char.pre + domar + aliadoAnimal;
                    }},
                    { name: 'Comandar Aliado', formula: 'PRE + Lideran√ßa + Aliado Animal', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        return char.pre + lideranca + aliadoAnimal;
                    }},
                    { name: 'Convocar Manada (-1 DET)', formula: 'PRE + Lideran√ßa + Linguagem Animal', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const linguagemAnimal = char.classAbilities?.['linguagem-animal'] || 0;
                        return char.pre + lideranca + linguagemAnimal;
                    }},
                    { name: 'Fus√£o Selvagem (-1 DET)', formula: 'PRE + Aliado Animal + Linguagem Animal', calculate: (char) => {
                        const aliadoAnimal = char.classAbilities?.['aliado-animal'] || 0;
                        const linguagemAnimal = char.classAbilities?.['linguagem-animal'] || 0;
                        return char.pre + aliadoAnimal + linguagemAnimal;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'kits-ingredientes', name: 'Kits/Ingredientes', max: 10, info: 'Usados na prepara√ß√£o de lo√ß√µes' },
                    { id: 'aliados-ativos', name: 'Aliados Ativos', max: 'aliado-animal', info: 'M√°ximo = n√≠vel de Aliado Animal' }
                ],
                info: `<strong>Papel:</strong> Suporte, comunh√£o animal e alquimancia.<br>
                    <strong>Fus√£o Selvagem:</strong> Emissor (controla animal) ou Receptor (ganha poderes).<br>
                    <strong>Dica:</strong> Proteja quem estiver em transe durante Fus√£o Selvagem.`
            },
            'Guerreiro': {
                abilities: [
                    { id: 'armas-haste', name: 'Armas de Haste', maxLevel: 5 },
                    { id: 'armas-pesadas', name: 'Armas Pesadas', maxLevel: 5 },
                    { id: 'armas-uma-mao', name: 'Armas de Uma M√£o', maxLevel: 5 },
                    { id: 'armas-duas-maos', name: 'Armas de Duas M√£os', maxLevel: 5 },
                    { id: 'armas-duplas', name: 'Armas Duplas', maxLevel: 5 },
                    { id: 'armas-arremessaveis', name: 'Armas Arremess√°veis', maxLevel: 5 },
                    { id: 'escudo', name: 'Escudo', maxLevel: 5 },
                    { id: 'postura-combate', name: 'Postura de Combate', maxLevel: 5 },
                    { id: 'contra-ataque', name: 'Contra-Ataque', maxLevel: 5 },
                    { id: 'impeto', name: '√çmpeto', maxLevel: 5 },
                    { id: 'guerrilha', name: 'Guerrilha', maxLevel: 5 },
                    { id: 'controle', name: 'Controle', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'M√£os Vazias', formula: 'FOR + Briga', calculate: (char) => {
                        const briga = char.skills['briga'] || 0;
                        return char.for + briga;
                    }},
                    { name: 'Arma', formula: 'FOR/DES + Arma + Especializa√ß√£o', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const specs = ['armas-haste', 'armas-pesadas', 'armas-uma-mao', 'armas-duas-maos', 'armas-duplas', 'armas-arremessaveis'];
                        let maxSpec = 0;
                        specs.forEach(s => {
                            const val = char.classAbilities?.[s] || 0;
                            if (val > maxSpec) maxSpec = val;
                        });
                        return Math.max(char.for, char.des) + arma + maxSpec;
                    }},
                    { name: 'Escudo (Absorve Dano)', formula: 'N√≠vel de Escudo', calculate: (char) => char.classAbilities?.['escudo'] || 0 },
                    { name: 'Inspirar', formula: 'MAN + Lideran√ßa + Guerrilha', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const guerrilha = char.classAbilities?.['guerrilha'] || 0;
                        return char.man + lideranca + guerrilha;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [],
                info: `<strong>Papel:</strong> Combate direto, controle de campo.<br>
                    <strong>Manobras:</strong> 1 DET cada. M√°x 1/turno.<br>
                    <strong>Posturas:</strong> Ofensiva (+ataque, sem rea√ß√£o) ou Defensiva (+rea√ß√£o, sem ataque).<br>
                    <strong>Dica:</strong> Alterne posturas conforme a situa√ß√£o.`
            },
            'Adepto': {
                abilities: [
                    { id: 'contato-setimo', name: 'Contato com o S√©timo', maxLevel: 5 },
                    { id: 'selo-profano', name: 'Selo do Profano', maxLevel: 5 },
                    { id: 'talisma-profano', name: 'Talism√£ Profano', maxLevel: 5 },
                    { id: 'fragmento-identidade', name: 'Fragmento de Identidade', maxLevel: 5 },
                    { id: 'servos', name: 'Servos', maxLevel: 5 },
                    { id: 'vozes-tumulo', name: 'Vozes do T√∫mulo', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Controle da Ru√≠na', formula: 'INT + Selo do Profano', calculate: (char) => {
                        const seloProfano = char.classAbilities?.['selo-profano'] || 0;
                        return char.int + seloProfano;
                    }},
                    { name: 'Contato (Reanima√ß√£o)', formula: 'PRS + Performance + Contato S√©timo + Talism√£', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const contato = char.classAbilities?.['contato-setimo'] || 0;
                        const talisma = char.classAbilities?.['talisma-profano'] || 0;
                        return char.prs + performance + contato + talisma;
                    }},
                    { name: 'Limite de Fantoches', formula: 'INT + Lideran√ßa + Servos', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const servos = char.classAbilities?.['servos'] || 0;
                        return char.int + lideranca + servos;
                    }},
                    { name: 'Fragmentos', formula: 'N√≠vel de Fragmento de Identidade', calculate: (char) => char.classAbilities?.['fragmento-identidade'] || 0 },
                    { name: 'Convocar Fantoches', formula: 'PRS + Lideran√ßa + Talism√£ Profano', calculate: (char) => {
                        const lideranca = char.skills['lideran√ßa'] || 0;
                        const talisma = char.classAbilities?.['talisma-profano'] || 0;
                        return char.prs + lideranca + talisma;
                    }},
                    { name: 'Vozes do T√∫mulo', formula: 'PRE + Ess√™ncia + Vozes do T√∫mulo', calculate: (char) => {
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const vozes = char.classAbilities?.['vozes-tumulo'] || 0;
                        return char.pre + essencia + vozes;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'servos-permanentes', name: 'Servos Permanentes', max: 'servos', info: 'M√°ximo = n√≠vel de Servos' },
                    { id: 'fantoches-ativos', name: 'Fantoches Ativos', max: 'calc-fantoches', info: 'M√°ximo = INT + Lideran√ßa + Servos' }
                ],
                info: `<strong>Papel:</strong> Necromancia, controle de mortos-vivos.<br>
                    <strong>Fragmentos:</strong> 0-5. Mais fragmentos = mais poder, menos controle.<br>
                    <strong>Talism√£ Profano:</strong> OBRIGAT√ìRIO para rituais.<br>
                    <strong>Dica:</strong> Fragmentos 2-3 equilibram poder e controle.`
            },
            'Ladino': {
                abilities: [
                    { id: 'armas-punho', name: 'Armas de Punho', maxLevel: 5 },
                    { id: 'ferramentas-crime', name: 'Ferramentas do Crime', maxLevel: 5 },
                    { id: 'precis√£o', name: 'Precis√£o', maxLevel: 5 },
                    { id: 'arrombamento', name: 'Arrombamento', maxLevel: 5 },
                    { id: 'prestidigita√ß√£o', name: 'Prestidigita√ß√£o', maxLevel: 5 },
                    { id: 'furtividade-ii', name: 'Furtividade II', maxLevel: 5 },
                    { id: 'malandragem-ii', name: 'Malandragem II', maxLevel: 5 },
                    { id: 'olho-brechas', name: 'Olho Para Brechas', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Punhal', formula: 'DES + Arma + Armas Punho', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const punho = char.classAbilities?.['armas-punho'] || 0;
                        return char.des + arma + punho;
                    }},
                    { name: 'Punhal Furtivo', formula: 'DES + Arma + Punho + Furtividade + Furtividade II', calculate: (char) => {
                        const arma = char.skills['arma'] || 0;
                        const punho = char.classAbilities?.['armas-punho'] || 0;
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + arma + punho + furt + furtII;
                    }},
                    { name: 'Abrir Fechaduras', formula: 'DES + Arrombamento + Ferramentas', calculate: (char) => {
                        const arromb = char.classAbilities?.['arrombamento'] || 0;
                        const ferram = char.classAbilities?.['ferramentas-crime'] || 0;
                        return char.des + arromb + ferram;
                    }},
                    { name: 'Furto', formula: 'DES + Prestidigita√ß√£o + Furtividade I e II', calculate: (char) => {
                        const presti = char.classAbilities?.['prestidigita√ß√£o'] || 0;
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + presti + furt + furtII;
                    }},
                    { name: 'Discri√ß√£o (Furtividade)', formula: 'DES + Furtividade + Furtividade II', calculate: (char) => {
                        const furt = char.skills['furtividade'] || 0;
                        const furtII = char.classAbilities?.['furtividade-ii'] || 0;
                        return char.des + furt + furtII;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE + Olho Para Brechas', calculate: (char) => {
                        const olho = char.classAbilities?.['olho-brechas'] || 0;
                        return char.rac + char.pre + olho;
                    }}
                ],
                resources: [
                    { id: 'kit-larapio', name: 'Kit de Lar√°pio', max: 1, info: 'Ferramentas para arrombamento' }
                ],
                info: `<strong>Papel:</strong> Furtividade, manipula√ß√£o, dano oportunista.<br>
                    <strong>VULNERABILIDADE:</strong> Recebe 2√ó dano f√≠sico!<br>
                    <strong>Dica:</strong> Mantenha-se furtivo e evite combate direto.`
            },
            'Pallacerdote': {
                abilities: [
                    { id: 'simbolo-sagrado', name: 'S√≠mbolo Sagrado', maxLevel: 5 },
                    { id: 'devocao-palla', name: 'Devo√ß√£o em Palla', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Prece Breve (-1 DET ‚Üí +1 Gra√ßa)', formula: 'PRE + Ess√™ncia + S√≠mbolo Sagrado', calculate: (char) => {
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.pre + essencia + simbolo;
                    }},
                    { name: 'Ben√ß√£o', formula: 'PRE + Performance + Ess√™ncia + S√≠mbolo', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.pre + performance + essencia + simbolo;
                    }},
                    { name: 'S√∫plica', formula: 'MAN + Performance + Ess√™ncia + S√≠mbolo', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const essencia = char.skills['ess√™ncia'] || 0;
                        const simbolo = char.classAbilities?.['simbolo-sagrado'] || 0;
                        return char.man + performance + essencia + simbolo;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'graca', name: 'Gra√ßa', max: 'devocao-palla', info: 'M√°ximo = n√≠vel de Devo√ß√£o (substitui DET nas preces)' }
                ],
                info: `<strong>Papel:</strong> Suporte, cura e controle por luz.<br>
                    <strong>Gra√ßa:</strong> Substitui Determina√ß√£o nas preces.<br>
                    <strong>Dica:</strong> Use Gra√ßa para preces e guarde DET para emerg√™ncias.`
            },
            'Ritualista': {
                abilities: [
                    { id: 'contato-oitavo', name: 'Contato com o Oitavo', maxLevel: 10 },
                    { id: 'selo-abissal', name: 'Selo Abissal', maxLevel: 5 },
                    { id: 'sacrificio', name: 'Sacrif√≠cio', maxLevel: 5 },
                    { id: 'resistencia-loucura', name: 'Resist√™ncia a Loucura', maxLevel: 5 }
                ],
                quickTests: [
                    { name: 'Contato (Abertura)', formula: 'PRS + Performance + CA + Contato + Sacrif√≠cio', calculate: (char) => {
                        const performance = char.skills['performance'] || 0;
                        const contato = char.classAbilities?.['contato-oitavo'] || 0;
                        const sacrificio = char.classAbilities?.['sacrificio'] || 0;
                        return char.prs + performance + contato + sacrificio;
                    }},
                    { name: 'Selo (Controle)', formula: 'RAC + Abismo + Selo + Sacrif√≠cio', calculate: (char) => {const abismo = char.skills['abismo'] || 0;
                        const selo = char.classAbilities?.['selo-abissal'] || 0;
                        const sacrificio = char.classAbilities?.['sacrificio'] || 0;
                        return char.rac + abismo + selo + sacrificio;
                    }},
                    { name: 'CA (Contato Abissal)', formula: 'N√≠vel de Contato com o Oitavo', calculate: (char) => char.classAbilities?.['contato-oitavo'] || 0 },
                    { name: 'Despertar', formula: 'AUT + Ess√™ncia vs (CA - Abismo)', calculate: (char) => {
                        const essencia = char.skills['ess√™ncia'] || 0;
                        return char.aut + essencia;
                    }},
                    { name: 'Percep√ß√£o', formula: 'RAC + PRE', calculate: (char) => char.rac + char.pre }
                ],
                resources: [
                    { id: 'ruptura-venire', name: 'Ruptura Venire (RV)', max: 10, info: 'Acumulado de falhas em Despertar' }
                ],
                info: `<strong>Papel:</strong> Controle do campo por rituais abissais.<br>
                    <strong>CA:</strong> Define poder dos rituais.<br>
                    <strong>Despertar:</strong> AUT + Ess√™ncia vs (CA - Abismo). Falha = -1 Sanidade.<br>
                    <strong>Dica:</strong> CA alto = mais poder, mais risco.`
            }
        };

        // STATE
        window.character = {
            nome: '', jogador: '', idade: 0, raca: '', classe: '', virtude: '', vicio: '',
            tamanho: 5, luns: 0,
            int: 1, for: 1, pre: 1, rac: 1, des: 1, man: 1, prs: 1, vig: 1, aut: 1,
            skills: {},
            skillInputs: {},
            classAbilities: {},
            classResources: {},
            hpCurrent: 5, detCurrent: 3, sanCurrent: 100, blindagem: 0,
            containers: [{
                id: Date.now(),
                name: 'Mochila',
                maxCapacity: 6,
                items: []
            }],
            notas: '',
            exp: 0,
            characterImage: ''
        };

        function getChar() {
            return window.character;
        }

        window.forceLoadClass = function() {
            const char = getChar();
            const classe = char.classe;
            
            console.log('BOT√ÉO CLICADO! Classe atual:', classe);
            
            if (!classe) {
                showAlert('‚ùå Selecione uma classe na aba "B√°sico" primeiro!', 'danger');
                return;
            }
            
            if (!CLASS_ABILITIES[classe]) {
                showAlert('‚ùå Classe n√£o encontrada no sistema!', 'danger');
                return;
            }
            
            console.log('Carregando classe:', classe);
            renderClassContent(classe);
            showAlert('‚úÖ Habilidades da classe carregadas com sucesso!', 'success');
            autoSave();
        };

        function renderClassContent(classe) {
            const char = getChar();
            const classData = CLASS_ABILITIES[classe];
            const classContent = document.getElementById('class-content');
            
            let html = `
                <div class="section">
                    <h2 class="section-title">üéØ Habilidades de ${classe}</h2>
                    <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                        Clique nas bolinhas para aumentar o n√≠vel. 
                        ${classe === 'Pallacerdote' || classe === 'Ritualista' ? 'Custo: N√≠vel √ó 4 EXP' : 'Custo: N√≠vel √ó 2 EXP'}
                    </p>
                    <div class="grid grid-2">
            `;
            
            classData.abilities.forEach(ability => {
                if (!char.classAbilities[ability.id]) {
                    char.classAbilities[ability.id] = 0;
                }
                
                html += `
                    <div class="class-ability-item">
                        <div class="class-ability-name">${ability.name}</div>
                        <div class="dots" id="dots-class-${ability.id}"></div>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            
            html += `
                <div class="section">
                    <h2 class="section-title">‚ö° Testes R√°pidos</h2>
                    <p style="color: #94a3b8; margin-bottom: 15px; font-size: 0.85rem;">
                        Valores calculados automaticamente com seus atributos e habilidades.
                    </p>
                    <div id="class-tests-container"></div>
                </div>
            `;
            
            if (classData.resources && classData.resources.length > 0) {
                html += `
                    <div class="section">
                        <h2 class="section-title">üì¶ Recursos da Classe</h2>
                `;
                
                classData.resources.forEach(resource => {
                    if (!char.classResources[resource.id]) {
                        char.classResources[resource.id] = 0;
                    }
                    
                    let maxValue = getResourceMax(resource);
                    
                    html += `
                        <div class="resource-tracker">
                            <div class="resource-header">${resource.name}</div>
                            <div class="info-box">
                                <strong>Info:</strong> ${resource.info}
                                ${maxValue > 0 ? `<br><strong>M√°ximo atual:</strong> ${maxValue}` : ''}
                            </div>
                            <div class="resource-value" id="resource-${resource.id}">${char.classResources[resource.id]} / ${maxValue}</div>
                            <div class="resource-controls">
                                <button class="btn btn-secondary btn-small" onclick="adjustResource('${resource.id}', -1)">-1</button>
                                <button class="btn btn-secondary btn-small" onclick="adjustResource('${resource.id}', -5)">-5</button>
                                <input type="number" id="resource-input-${resource.id}" 
                                       value="${char.classResources[resource.id]}" 
                                       min="0" max="${maxValue}"
                                       onchange="setResource('${resource.id}', this.value)"
                                       style="width: 80px; text-align: center;"
                                       inputmode="numeric">
                                <button class="btn btn-primary btn-small" onclick="adjustResource('${resource.id}', 1)">+1</button>
                                <button class="btn btn-primary btn-small" onclick="adjustResource('${resource.id}', 5)">+5</button>
                                <button class="btn btn-secondary btn-small" onclick="resetResource('${resource.id}')">Max</button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `
                <div class="section">
                    <h2 class="section-title">üìñ Informa√ß√µes da Classe</h2>
                    <div class="info-box">
                        ${classData.info}
                    </div>
                </div>
            `;
            
            classContent.innerHTML = html;
            
            classData.abilities.forEach(ability => {
                createClassAbilityDots(ability.id, ability.maxLevel);
            });
            
            updateClassTests();
            
            console.log('Classe renderizada com sucesso!');
        }

        function init() {
            try {
                console.log('üöÄ Iniciando sistema...');
                
                const attributes = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
                attributes.forEach(attr => createAttributeDots(attr, 5)); // 5 N√çVEIS
                
                createSkills();
            
                const char = getChar();
                if (!char.containers || char.containers.length === 0) {
                    char.containers = [{
                        id: Date.now(),
                        name: 'Mochila',
                        maxCapacity: char.for + char.vig,
                        items: []
                    }];
                }
                
                loadCharacterData();
            
                // Tentar atualizar c√°lculos, mas n√£o travar se falhar
                try {
                    updateAllCalculations();
                } catch (error) {
                    console.error('‚ö†Ô∏è Erro ao atualizar c√°lculos iniciais (n√£o cr√≠tico):', error);
                }
                
                setupEventListeners();
                setupInputListeners();
                
                updateContainers();
                updateEXPDisplay();
                updateConditions();
                updateLunsDisplay();

                // Update allies and properties (defensivo - aguarda fun√ß√µes estarem dispon√≠veis)
                if (typeof window.updateAlliesList === 'function') {
                    updateAlliesList();
                } else {
                    console.warn('‚ö†Ô∏è updateAlliesList ainda n√£o dispon√≠vel');
                }

                if (typeof window.updatePropertiesList === 'function') {
                    updatePropertiesList();
                } else {
                    console.warn('‚ö†Ô∏è updatePropertiesList ainda n√£o dispon√≠vel');
                }

                if (typeof window.updateAlliesCombat === 'function') {
                    updateAlliesCombat();
                } else {
                    console.warn('‚ö†Ô∏è updateAlliesCombat ainda n√£o dispon√≠vel');
                }
                
                console.log('‚úÖ Sistema inicializado com sucesso');
                
            } catch (error) {
                console.error('‚ùå ERRO CR√çTICO na inicializa√ß√£o:', error);
                alert('Erro ao inicializar ficha. Verifique o console (F12).');
            }
        }

        function setupEventListeners() {
            const inputs = {
                'nome': 'nome', 
                'jogador': 'jogador', 
                'idade': 'idade',
                'raca': 'raca', 
                'classe': 'classe', 
                'virtude': 'virtude',
                'vicio': 'vicio', 
                'tamanho': 'tamanho', 
                'luns': 'luns'
            };
            
            Object.entries(inputs).forEach(([id, key]) => {
                const el = document.getElementById(id);
                if (!el) {
                    console.warn(`‚ö†Ô∏è Campo ${id} n√£o encontrado no DOM`);
                    return;
                }
                
                // Listener para 'change' (blur, selects)
                el.addEventListener('change', (e) => {
                    try {
                        const char = getChar();
                        const oldValue = char[key];
                        
                        char[key] = ['idade', 'tamanho', 'luns'].includes(key) 
                            ? parseInt(e.target.value) || 0 
                            : e.target.value;
                        
                        console.log(`[CHANGE] ${key}: "${oldValue}" ‚Üí "${char[key]}"`);
                        
                        if (key === 'tamanho') {
                            try {
                                updateAllCalculations();
                            } catch (err) {
                                console.error('Erro ao atualizar c√°lculos:', err);
                                // Continua mesmo com erro
                            }
                        }
                        
                        if (key === 'classe') {
                            const classContent = document.getElementById('class-content');
                            if (classContent) classContent.innerHTML = '';
                        }
                        
                        // GARANTIR que salva mesmo se houver erro
                        autoSave();
                        
                    } catch (error) {
                        console.error(`‚ùå Erro ao processar mudan√ßa em ${key}:`, error);
                    }
                });
                
                // Listener para 'input' (digita√ß√£o em tempo real)
                if (el.type === 'text' || el.type === 'number') {
                    el.addEventListener('input', (e) => {
                        try {
                            const char = getChar();
                            
                            char[key] = ['idade', 'tamanho', 'luns'].includes(key) 
                                ? parseInt(e.target.value) || 0 
                                : e.target.value;
                            
                            console.log(`[INPUT] ${key} = "${char[key]}"`);
                            
                            if (key === 'tamanho') {
                                try {
                                    updateAllCalculations();
                                } catch (err) {
                                    console.error('Erro ao atualizar c√°lculos:', err);
                                    // Continua mesmo com erro
                                }
                            }
                            
                            // GARANTIR que salva mesmo se houver erro
                            autoSave();
                            
                        } catch (error) {
                            console.error(`‚ùå Erro ao processar input em ${key}:`, error);
                        }
                    });
                }
            });

            // Listener para notas
            const notasTextarea = document.getElementById('notas-textarea');
            if (notasTextarea) {
                notasTextarea.addEventListener('input', (e) => {
                    try {
                        const char = getChar();
                        char.notas = e.target.value;
                        console.log('[INPUT] Notas atualizadas');
                        autoSave();
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar notas:', error);
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è Textarea de notas n√£o encontrado');
            }
            
            console.log('‚úÖ Event listeners configurados com sucesso');
        }

        // ============= FIX: ADICIONAR INPUT LISTENERS PARA CAMPOS DE TEXTO =============
        // Adiciona event listener 'input' para campos de texto salvarem enquanto digita
        function setupInputListeners() {
            const textFields = ['nome', 'jogador'];
            
            textFields.forEach(fieldId => {
                const el = document.getElementById(fieldId);
                if (el) {
                    el.addEventListener('input', (e) => {
                        const char = getChar();
                        char[fieldId] = e.target.value;
                        console.log(`[INPUT] ${fieldId} atualizado:`, e.target.value);
                        autoSave();
                    });
                }
            });
        }

        // ============= SISTEMA DE UPLOAD DE IMAGEM =============

        // Event listener para upload de imagem
        document.getElementById('characterImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Verificar tamanho (m√°x 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('‚ùå Imagem muito grande! M√°ximo 2MB.', 'danger');
                e.target.value = '';
                return;
            }

            // Verificar tipo
            if (!file.type.startsWith('image/')) {
                showAlert('‚ùå Por favor, selecione uma imagem v√°lida.', 'danger');
                e.target.value = '';
                return;
            }

            // Ler e converter para base64
            const reader = new FileReader();
            reader.onload = function(event) {
                const char = getChar();
                char.characterImage = event.target.result;
                updateCharacterImageDisplay();
                autoSave();
                showAlert('‚úÖ Imagem carregada!', 'success');
            };
            reader.onerror = function() {
                showAlert('‚ùå Erro ao carregar imagem.', 'danger');
                e.target.value = '';
            };
            reader.readAsDataURL(file);
        });

        // Fun√ß√£o para exibir imagem do personagem
        function updateCharacterImageDisplay() {
            const char = getChar();
            const preview = document.getElementById('characterImagePreview');
            const removeBtn = document.getElementById('removeImageBtn');

            if (char.characterImage) {
                preview.innerHTML = `<img src="${char.characterImage}" alt="Personagem">`;
                removeBtn.style.display = 'inline-block';
            } else {
                preview.innerHTML = '<div class="character-image-placeholder">üé≠</div>';
                removeBtn.style.display = 'none';
            }
        }

        // Fun√ß√£o para remover imagem
        window.removeCharacterImage = function() {
            if (confirm('üóëÔ∏è Remover imagem do personagem?')) {
                const char = getChar();
                char.characterImage = '';
                updateCharacterImageDisplay();
                document.getElementById('characterImageInput').value = '';
                autoSave();
                showAlert('üóëÔ∏è Imagem removida.', 'success');
            }
        };

        let autoSaveTimeout;
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            
            autoSaveTimeout = setTimeout(() => {
                try {
                    if (window.saveToFirebase) {
                        console.log('üíæ Salvando dados...');
                        window.saveToFirebase();
                    } else {
                        console.warn('‚ö†Ô∏è Fun√ß√£o saveToFirebase n√£o dispon√≠vel');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar:', error);
                    // Mostrar alerta visual para o usu√°rio
                    const indicator = document.getElementById('autosaveIndicator');
                    if (indicator) {
                        indicator.textContent = '‚ùå Erro ao salvar!';
                        indicator.classList.add('show', 'error');
                        indicator.classList.remove('saving');
                        
                        setTimeout(() => {
                            indicator.classList.remove('show');
                        }, 3000);
                    }
                }
            }, 1000);
        }

        function createAttributeDots(attrName, maxDots) {
            const container = document.getElementById(`dots-${attrName}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const char = getChar();
            for (let i = 1; i <= maxDots; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (i <= char[attrName]) dot.classList.add('filled');
                
                dot.addEventListener('click', () => {
                    upgradeAttribute(attrName, i);
                });
                
                container.appendChild(dot);
            }
        }

        function updateAttributeDots(attrName) {
            const char = getChar();
            const dots = document.querySelectorAll(`#dots-${attrName} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < char[attrName]);
            });
        }


        function upgradeClassAbility(abilityId, targetLevel) {
            const char = getChar();
            const currentLevel = char.classAbilities[abilityId] || 0;
            
            // Se est√° diminuindo, permite sem custo
            if (targetLevel < currentLevel) {
                if (confirm(`‚ö†Ô∏è Tem certeza que deseja DIMINUIR esta habilidade de ${currentLevel} para ${targetLevel}?`)) {
                    char.classAbilities[abilityId] = targetLevel;
                    updateClassAbilityDots(abilityId);
                    updateClassTests();
                    updateClassResourcesDisplay();
                    updateAllCalculations();
                    autoSave();
                }
                return;
            }
            
            // Se est√° no mesmo n√≠vel, ignora
            if (targetLevel === currentLevel) return;
            
            // Determinar multiplicador baseado na classe
            const classe = char.classe;
            let multiplier = 2; // Padr√£o
            if (classe === 'Pallacerdote' || classe === 'Ritualista (Abismancia)') {
                multiplier = 4;
            }
            
            // Calcular custo total
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * multiplier;
            }
            
            // Verificar EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa de: ${totalCost} EXP\nVoc√™ tem: ${currentEXP} EXP\nFaltam: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            // Confirmar
            const levelDiff = targetLevel - currentLevel;
            const abilityName = abilityId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const message = levelDiff === 1 
                ? `Deseja aumentar ${abilityName} de ${currentLevel} para ${targetLevel}?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`
                : `Deseja aumentar ${abilityName} de ${currentLevel} para ${targetLevel} (+${levelDiff} n√≠veis)?\n\nCusto total: ${totalCost} EXP (√ó${multiplier})`;
            
            if (confirm(message)) {
                char.classAbilities[abilityId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateClassAbilityDots(abilityId);
                updateClassTests();
                updateClassResourcesDisplay();
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${abilityName} aumentado para ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }

        function createClassAbilityDots(abilityId, maxLevel) {
            const container = document.getElementById(`dots-class-${abilityId}`);
            if (!container) return;
            
            container.innerHTML = '';
            
            const char = getChar();
            for (let i = 1; i <= maxLevel; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                if (i <= (char.classAbilities[abilityId] || 0)) {
                    dot.classList.add('filled');
                }
                
                dot.addEventListener('click', () => {
                    upgradeClassAbility(abilityId, i);
                });
                
                container.appendChild(dot);
            }
        }

        function updateClassAbilityDots(abilityId) {
            const char = getChar();
            const dots = document.querySelectorAll(`#dots-class-${abilityId} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < (char.classAbilities[abilityId] || 0));
            });
        }


        function upgradeSkill(skillId, targetLevel, skillDiv) {
            const char = getChar();
            const currentLevel = char.skills[skillId] || 0;
            
            // Se est√° diminuindo, permite sem custo
            if (targetLevel < currentLevel) {
                if (confirm(`‚ö†Ô∏è Tem certeza que deseja DIMINUIR esta habilidade de ${currentLevel} para ${targetLevel}?`)) {
                    char.skills[skillId] = targetLevel;
                    updateSkillDots(skillId);
                    skillDiv.classList.toggle('inapto', targetLevel === 0);
                    updateAllCalculations();
                    updateClassTests();
                    autoSave();
                }
                return;
            }
            
            // Se est√° no mesmo n√≠vel, ignora
            if (targetLevel === currentLevel) return;
            
            // Calcular custo total
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 4;
            }
            
            // Verificar EXP
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa de: ${totalCost} EXP\nVoc√™ tem: ${currentEXP} EXP\nFaltam: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            // Confirmar
            const levelDiff = targetLevel - currentLevel;
            const skillName = skillId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const message = levelDiff === 1 
                ? `Deseja aumentar ${skillName} de ${currentLevel} para ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Deseja aumentar ${skillName} de ${currentLevel} para ${targetLevel} (+${levelDiff} n√≠veis)?\n\nCusto total: ${totalCost} EXP`;
            
            if (confirm(message)) {
                char.skills[skillId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateSkillDots(skillId);
                skillDiv.classList.toggle('inapto', targetLevel === 0);
                updateAllCalculations();
                updateClassTests();
                updateEXPDisplay();
                showAlert(`‚úÖ ${skillName} aumentado para ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }

        function createSkills() {
            const char = getChar();
            Object.keys(SKILLS).forEach(category => {
                const container = document.getElementById(`skills-${category}`);
                if (!container) return;
                
                SKILLS[category].forEach(skill => {
                    const skillId = skill.name.toLowerCase().replace(/\s+/g, '-').replace(/\./g, '');
                    if (!char.skills[skillId]) char.skills[skillId] = 0;
                    if (!char.skillInputs[skillId]) char.skillInputs[skillId] = '';
                    
                    const skillDiv = document.createElement('div');
                    skillDiv.className = 'skill-item';
                    if (char.skills[skillId] === 0) skillDiv.classList.add('inapto');
                    
                    skillDiv.innerHTML = `
                        <div class="skill-header">
                            <div class="skill-info">
                                <div class="skill-name">${skill.name}</div>
                                <div class="skill-attrs">${skill.attr}</div>
                            </div>
                            <div class="dots" id="skill-${skillId}"></div>
                        </div>
                        <input type="text" class="skill-input" id="input-${skillId}" placeholder="Ex: ${skill.placeholder || 'Especialidade...'}" value="${char.skillInputs[skillId] || ''}" style="margin-top: 8px;">
                    `;
                    
                    container.appendChild(skillDiv);
                    
                    const inputEl = skillDiv.querySelector(`#input-${skillId}`);
                    if (inputEl) {
                        inputEl.addEventListener('change', (e) => {
                            char.skillInputs[skillId] = e.target.value;
                            autoSave();
                        });
                    }
                    
                    const dotsContainer = skillDiv.querySelector('.dots');
                    for (let i = 1; i <= 5; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        if (i <= char.skills[skillId]) dot.classList.add('filled');
                        
                        dot.addEventListener('click', () => {
                            upgradeSkill(skillId, i, skillDiv);
                        });
                        
                        dotsContainer.appendChild(dot);
                    }
                });
            });
        }

        function updateSkillDots(skillId) {
            const char = getChar();
            const dots = document.querySelectorAll(`#skill-${skillId} .dot`);
            dots.forEach((dot, index) => {
                dot.classList.toggle('filled', index < char.skills[skillId]);
            });
        }

        function getResourceMax(resource) {
            const char = getChar();
            if (typeof resource.max === 'number') {
                return resource.max;
            } else if (resource.max === 'calc-fantoches') {
                const lideranca = char.skills['lideran√ßa'] || 0;
                const servos = char.classAbilities['servos'] || 0;
                return char.int + lideranca + servos;
            } else {
                return char.classAbilities[resource.max] || 0;
            }
        }

        function updateClassTests() {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const container = document.getElementById('class-tests-container');
            if (!container) return;
            
            const classData = CLASS_ABILITIES[classe];
            let html = '';
            
            classData.quickTests.forEach(test => {
                const result = test.calculate(char);
                
                html += `
                    <div class="test-card">
                        <div class="test-name">${test.name}</div>
                        <div class="test-formula">${test.formula}</div>
                        <div class="test-result">${result} dados</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateClassResourcesDisplay() {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            if (!classData.resources) return;
            
            classData.resources.forEach(resource => {
                const maxValue = getResourceMax(resource);
                const displayEl = document.getElementById(`resource-${resource.id}`);
                const inputEl = document.getElementById(`resource-input-${resource.id}`);
                
                if (displayEl) {
                    displayEl.textContent = `${char.classResources[resource.id]} / ${maxValue}`;
                }
                if (inputEl) {
                    inputEl.max = maxValue;
                    if (char.classResources[resource.id] > maxValue) {
                        char.classResources[resource.id] = maxValue;
                        inputEl.value = maxValue;
                    }
                }
            });
        }

        window.adjustResource = function(resourceId, amount) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = Math.max(0, Math.min(
                (char.classResources[resourceId] || 0) + amount,
                max
            ));
            updateResourceDisplay(resourceId);
            autoSave();
        };

        window.setResource = function(resourceId, value) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = Math.max(0, Math.min(parseInt(value) || 0, max));
            updateResourceDisplay(resourceId);
            autoSave();
        };

        window.resetResource = function(resourceId) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            char.classResources[resourceId] = max;
            updateResourceDisplay(resourceId);
            autoSave();
        };

        function updateResourceDisplay(resourceId) {
            const char = getChar();
            const classe = char.classe;
            if (!classe || !CLASS_ABILITIES[classe]) return;
            
            const classData = CLASS_ABILITIES[classe];
            const resource = classData.resources.find(r => r.id === resourceId);
            if (!resource) return;
            
            const max = getResourceMax(resource);
            const displayEl = document.getElementById(`resource-${resource.id}`);
            const inputEl = document.getElementById(`resource-input-${resource.id}`);
            
            if (displayEl) {
                displayEl.textContent = `${char.classResources[resourceId]} / ${max}`;
            }
            if (inputEl) {
                inputEl.value = char.classResources[resourceId];
                inputEl.max = max;
            }
        }

        function updateAllCalculations() {
            try {
                const char = getChar();
                const agilidade = char.skills['agilidade'] || 0;
                const abismo = char.skills['abismo'] || 0;
                
                // Fun√ß√£o auxiliar para atualizar elemento com seguran√ßa
                const safeUpdate = (id, value) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    } else {
                        console.warn(`‚ö†Ô∏è Elemento ${id} n√£o encontrado`);
                    }
                };
                
                // Atualizar c√°lculos com prote√ß√£o
                safeUpdate('calc-iniciativa', char.rac + char.des + char.aut + agilidade - char.tamanho);
                safeUpdate('calc-reacao', Math.min(char.des, char.rac) + agilidade);
                safeUpdate('calc-deslocamento', (char.for + char.des + char.tamanho + agilidade) + 'm');
                
                const vitalidadeMax = char.vig + char.tamanho;
                safeUpdate('calc-vitalidade-max', vitalidadeMax);
                
                const determinacaoMax = char.prs + char.aut;
                safeUpdate('calc-determinacao-max', determinacaoMax);
                
                const cargaMax = char.for + char.vig;
                safeUpdate('calc-carga', cargaMax);
                
                const sanidadeMax = (char.int + char.aut - (abismo * 2)) * 10;
                safeUpdate('calc-sanidade', sanidadeMax);
                
                safeUpdate('calc-blindagem', char.blindagem);
                
                // Ajustar valores atuais se necess√°rio
                if (!char.hpCurrent || char.hpCurrent > vitalidadeMax) {
                    char.hpCurrent = vitalidadeMax;
                }
                if (!char.detCurrent || char.detCurrent > determinacaoMax) {
                    char.detCurrent = determinacaoMax;
                }
                if (!char.sanCurrent || char.sanCurrent > sanidadeMax) {
                    char.sanCurrent = sanidadeMax;
                }
                
                // Atualizar barras
                updateHPBar();
                updateDETBar();
                updateSANBar();
                
                // Atualizar displays
                const expDisplay = document.getElementById('exp-display');
                if (expDisplay) {
                    expDisplay.textContent = char.exp || 0;
                }
                
                // Atualizar testes da classe e recursos
                updateClassTests();
                updateClassResourcesDisplay();
                
                console.log('‚úÖ C√°lculos atualizados com sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro em updateAllCalculations:', error);
                // N√ÉO impedir o salvamento mesmo se houver erro aqui
            }
        }

        window.updateHPBar = function() {
            const char = getChar();
            const max = char.vig + char.tamanho;
            const current = parseInt(document.getElementById('hp-current').value) || 0;
            char.hpCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('hp-current').value = char.hpCurrent;
            const percent = (char.hpCurrent / max) * 100;
            document.getElementById('hp-fill').style.width = percent + '%';
            document.getElementById('hp-text').textContent = `${char.hpCurrent} / ${max}`;
            autoSave();
        };

        window.adjustHP = function(amount) {
            const char = getChar();
            const max = char.vig + char.tamanho;
            char.hpCurrent = Math.max(0, Math.min(char.hpCurrent + amount, max));
            document.getElementById('hp-current').value = char.hpCurrent;
            updateHPBar();
        };

        window.resetHP = function() {
            const char = getChar();
            const max = char.vig + char.tamanho;
            char.hpCurrent = max;
            document.getElementById('hp-current').value = char.hpCurrent;
            updateHPBar();
        };

        window.updateDETBar = function() {
            const char = getChar();
            const max = char.prs + char.aut;
            const current = parseInt(document.getElementById('det-current').value) || 0;
            char.detCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('det-current').value = char.detCurrent;
            const percent = (char.detCurrent / max) * 100;
            document.getElementById('det-fill').style.width = percent + '%';
            document.getElementById('det-text').textContent = `${char.detCurrent} / ${max}`;
            autoSave();
        };

        window.adjustDET = function(amount) {
            const char = getChar();
            const max = char.prs + char.aut;
            char.detCurrent = Math.max(0, Math.min(char.detCurrent + amount, max));
            document.getElementById('det-current').value = char.detCurrent;
            updateDETBar();
        };

        window.resetDET = function() {
            const char = getChar();
            const max = char.prs + char.aut;
            char.detCurrent = max;
            document.getElementById('det-current').value = char.detCurrent;
            updateDETBar();
        };

        window.updateSANBar = function() {
            const char = getChar();
            const abismo = char.skills['abismo'] || 0;
            const max = (char.int + char.aut - (abismo * 2)) * 10;
            const current = parseInt(document.getElementById('san-current').value) || 0;
            char.sanCurrent = Math.max(0, Math.min(current, max));
            document.getElementById('san-current').value = char.sanCurrent;
            const percent = (char.sanCurrent / max) * 100;
            document.getElementById('san-fill').style.width = percent + '%';
            document.getElementById('san-text').textContent = `${char.sanCurrent} / ${max}`;
            autoSave();
        };

        window.adjustSAN = function(amount) {
            const char = getChar();
            const abismo = char.skills['abismo'] || 0;
            const max = (char.int + char.aut - (abismo * 2)) * 10;
            char.sanCurrent = Math.max(0, Math.min(char.sanCurrent + amount, max));
            document.getElementById('san-current').value = char.sanCurrent;
            updateSANBar();
        };

        window.resetSAN = function() {
            const char = getChar();
            const abismo = char.skills['abismo'] || 0;
            const max = (char.int + char.aut - (abismo * 2)) * 10;
            char.sanCurrent = max;
            document.getElementById('san-current').value = char.sanCurrent;
            updateSANBar();
        };

        window.rollDice = function() {
            const count = parseInt(document.getElementById('dice-count').value) || 1;
            let results = [];
            let successes = 0;
            let failures = 0;
            
            for (let i = 0; i < count; i++) {
                const roll = Math.floor(Math.random() * 10) + 1;
                results.push(roll);
                
                if (roll === 1) {
                    failures++;
                } else if (roll >= 8) {
                    successes++;
                    
                    if (roll === 10) {
                        let explode = roll;
                        while (explode === 10) {
                            explode = Math.floor(Math.random() * 10) + 1;
                            results.push(explode);
                            if (explode >= 8) successes++;
                        }
                    }
                }
            }
            
            const netSuccesses = successes - failures;
            
            document.getElementById('roll-result').textContent = netSuccesses;
            document.getElementById('roll-details').innerHTML = `
                <strong>Dados:</strong> ${results.join(', ')}<br>
                <strong>Sucessos:</strong> ${successes} | <strong>Falhas:</strong> ${failures}<br>
                <strong>Total:</strong> ${netSuccesses}
            `;
        };


        function updateEXPDisplay() {
            const char = getChar();
            const expDisplay = document.getElementById('exp-display');
            if (expDisplay) {
                expDisplay.textContent = char.exp || 0;
            }
        }

        // ============= FUN√á√ïES DE LUNS =============
        window.addLuns = function() {
            const char = getChar();
            const transactionInput = document.getElementById('luns-transaction');
            const amount = parseInt(transactionInput.value) || 0;
            
            if (amount <= 0) {
                alert('‚ö†Ô∏è Digite um valor v√°lido para adicionar!');
                return;
            }
            
            char.luns = (char.luns || 0) + amount;
            updateLunsDisplay();
            transactionInput.value = 0;
            
            showAlert(`‚úÖ +${amount} Luns adicionados! Saldo: ${char.luns}`, 'success');
            autoSave();
        };

        window.subtractLuns = function() {
            const char = getChar();
            const transactionInput = document.getElementById('luns-transaction');
            const amount = parseInt(transactionInput.value) || 0;
            
            if (amount <= 0) {
                alert('‚ö†Ô∏è Digite um valor v√°lido para retirar!');
                return;
            }
            
            if ((char.luns || 0) < amount) {
                alert('‚ö†Ô∏è Saldo insuficiente! Voc√™ tem ' + (char.luns || 0) + ' Luns.');
                return;
            }
            
            char.luns = (char.luns || 0) - amount;
            updateLunsDisplay();
            transactionInput.value = 0;
            
            showAlert(`‚úÖ -${amount} Luns retirados! Saldo: ${char.luns}`, 'success');
            autoSave();
        };

        window.quickLunsTransaction = function(amount) {
            const transactionInput = document.getElementById('luns-transaction');
            transactionInput.value = amount;
            transactionInput.focus();
        };

        function updateLunsDisplay() {
            const char = getChar();
            const lunsDisplay = document.getElementById('luns-display');
            const lunsHidden = document.getElementById('luns');
            
            if (lunsDisplay) {
                lunsDisplay.textContent = char.luns || 0;
            }
            if (lunsHidden) {
                lunsHidden.value = char.luns || 0;
            }
        }

        // ============= FUN√á√ïES DE CONDI√á√ïES =============
        window.addCondition = function() {
            const char = getChar();
            const name = prompt('Nome da Condi√ß√£o (ex: Fadiga, Fratura, Envenenado):');
            if (!name) return;
            
            const description = prompt('Descri√ß√£o da Condi√ß√£o (efeitos mec√¢nicos):') || '';
            
            if (!char.conditions) char.conditions = [];
            
            const newCondition = {
                id: Date.now(),
                name,
                description
            };
            
            char.conditions.push(newCondition);
            updateConditions();
            autoSave();
        };

        window.removeCondition = function(conditionId) {
            if (!confirm('‚ö†Ô∏è Remover esta condi√ß√£o?')) return;
            
            const char = getChar();
            if (!char.conditions) char.conditions = [];
            char.conditions = char.conditions.filter(c => c.id !== conditionId);
            updateConditions();
            autoSave();
        };

        function updateConditions() {
            const char = getChar();
            if (!char.conditions) char.conditions = [];
            
            const conditionsList = document.getElementById('conditions-list');
            if (!conditionsList) return;
            
            if (char.conditions.length === 0) {
                conditionsList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhuma condi√ß√£o ativa. Seu personagem est√° saud√°vel!</p>';
                return;
            }
            
            conditionsList.innerHTML = char.conditions.map(condition => `
                <div class="container-card" style="border-left: 4px solid var(--warning);">
                    <div class="container-header">
                        <div class="container-name">‚ö†Ô∏è ${condition.name}</div>
                    </div>
                    <div style="padding: 10px; color: #cbd5e1; font-size: 0.9rem; margin-bottom: 10px;">
                        ${condition.description || 'Sem descri√ß√£o'}
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeCondition(${condition.id})">üóëÔ∏è Remover</button>
                </div>
            `).join('');
        }

        window.addContainer = function() {
            const char = getChar();
            const name = prompt('Nome do container (ex: Mochila, Bolsa, Carro√ßa):');
            if (!name) return;
            
            const maxCapacity = parseInt(prompt('Capacidade m√°xima de carga:')) || 10;
            
            const newContainer = {
                id: Date.now(),
                name,
                maxCapacity,
                items: []
            };
            
            char.containers.push(newContainer);
            updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();
            autoSave();
        };

        window.removeContainer = function(containerId) {
            if (!confirm('‚ö†Ô∏è Remover este container e todos os itens dentro dele?')) return;
            
            const char = getChar();
            char.containers = char.containers.filter(c => c.id !== containerId);
            updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();
            autoSave();
        };

        window.addItemToContainer = function(containerId) {
            const name = prompt('Nome do item:');
            if (!name) return;
            
            const weight = parseInt(prompt('Peso (Carga):')) || 1;
            const quantity = parseInt(prompt('Quantidade:')) || 1;
            const description = prompt('Descri√ß√£o (opcional):') || '';
            
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (container) {
                const newItem = {
                    id: Date.now(),
                    name,
                    weight,
                    quantity,
                    description
                };
                
                container.items.push(newItem);
                updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();
                autoSave();
            }
        };

        window.removeItemFromContainer = function(containerId, itemId) {
            const char = getChar();
            const container = char.containers.find(c => c.id === containerId);
            if (container) {
                container.items = container.items.filter(i => i.id !== itemId);
                updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();
                autoSave();
            }
        };

        function updateContainers() {
            const char = getChar();
            const containersList = document.getElementById('containers-list');
            
            if (!char.containers || char.containers.length === 0) {
                containersList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px; font-size: 0.9rem;">Nenhum container. Adicione uma mochila, bolsa ou carro√ßa!</p>';
                return;
            }
            
            containersList.innerHTML = char.containers.map(container => {
                const currentLoad = container.items.reduce((sum, item) => 
                    sum + (item.weight * item.quantity), 0
                );
                
                const isOverload = currentLoad > container.maxCapacity;
                
                const itemsHTML = container.items.length === 0 
                    ? '<p style="color: #64748b; text-align: center; padding: 10px; font-size: 0.85rem;">Vazio</p>'
                    : container.items.map(item => `
                        <div class="inventory-item">
                            <div class="item-info">
                                <div class="item-name">${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''}</div>
                                <div class="item-details">
                                    Peso: ${item.weight} | Total: ${item.weight * item.quantity}
                                    ${item.description ? `<br>${item.description}` : ''}
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="removeItemFromContainer(${container.id}, ${item.id})">üóëÔ∏è</button>
                        </div>
                    `).join('');
                
                return `
                    <div class="container-card">
                        <div class="container-header">
                            <div class="container-name">üì¶ ${container.name}</div>
                            <div class="container-capacity ${isOverload ? 'overload' : ''}">
                                ${currentLoad} / ${container.maxCapacity} ${isOverload ? '‚ö†Ô∏è SOBRECARGA!' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary btn-small" onclick="addItemToContainer(${container.id})" style="flex: 1; min-width: 120px;">‚ûï Item</button>
                            <button class="btn btn-danger btn-small" onclick="removeContainer(${container.id})" style="min-width: 120px;">üóëÔ∏è Container</button>
                        </div>
                        ${itemsHTML}
                    </div>
                `;
            }).join('');
        }

        

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const targetTab = document.querySelector(`.tab-content[id="${tabName}"]`);
            
            if (!targetTab) {
                console.error('‚ùå Aba n√£o encontrada:', tabName);
                return;
            }
            
            event.target.classList.add('active');
            targetTab.classList.add('active');
            
            event.target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        };

        function loadCharacterData() {
            const char = getChar();
            ['nome', 'jogador', 'idade', 'raca', 'classe', 'virtude', 'vicio', 'tamanho'].forEach(key => {
                const el = document.getElementById(key);
                if (el) el.value = char[key] || (key === 'tamanho' ? 5 : '');
            });
            
            // Carregar Luns separadamente
            const lunsEl = document.getElementById('luns');
            if (lunsEl) lunsEl.value = char.luns || 0;
            
            const attributes = ['int', 'for', 'pre', 'rac', 'des', 'man', 'prs', 'vig', 'aut'];
            attributes.forEach(attr => updateAttributeDots(attr));
            
            Object.keys(char.skills).forEach(skillId => updateSkillDots(skillId));
            
            Object.keys(char.skillInputs || {}).forEach(skillId => {
                const inputEl = document.getElementById(`input-${skillId}`);
                if (inputEl) inputEl.value = char.skillInputs[skillId];
            });

            const notasTextarea = document.getElementById('notas-textarea');
            if (notasTextarea) {
                notasTextarea.value = char.notas || '';
            }
            
            updateContainers();
            updateEXPDisplay();
            updateConditions();
            updateLunsDisplay();
            updateEXPDisplay();

            // Update allies and properties
            updateAlliesList();
            updatePropertiesList();
            updateAlliesCombat();
            
            if (char.classe && CLASS_ABILITIES[char.classe]) {
                renderClassContent(char.classe);
            }

            updateCharacterImageDisplay();
        }

        function showAlert(message, type) {
            const alert = type === 'success' 
                ? document.getElementById('alertSuccess')
                : document.getElementById('alertError');
            
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // ========== SISTEMA DE PROGRESS√ÉO COM EXP ==========
        
        function upgradeAttribute(attr, targetLevel) {
            const char = getChar();
            const currentLevel = char[attr] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 5;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const msg = levelDiff === 1 
                ? `Aumentar ${attr.toUpperCase()} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Aumentar ${attr.toUpperCase()} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP`;
            
            if (confirm(msg)) {
                char[attr] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateAttributeDots(attr);
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${attr.toUpperCase()} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function upgradeSkill(skillId, targetLevel, skillDiv) {
            const char = getChar();
            const currentLevel = char.skills[skillId] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * 4;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const skillName = skillId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const msg = levelDiff === 1 
                ? `Aumentar ${skillName} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP`
                : `Aumentar ${skillName} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP`;
            
            if (confirm(msg)) {
                char.skills[skillId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateSkillDots(skillId);
                skillDiv.classList.toggle('inapto', targetLevel === 0);
                updateAllCalculations();
                updateClassTests();
                updateEXPDisplay();
                showAlert(`‚úÖ ${skillName} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function upgradeClassAbility(abilityId, targetLevel) {
            const char = getChar();
            const currentLevel = char.classAbilities[abilityId] || 0;
            
            // N√£o permite diminuir ou manter o mesmo n√≠vel
            if (targetLevel <= currentLevel) {
                return;
            }
            
            const classe = char.classe;
            let multiplier = 2;
            if (classe === 'Pallacerdote' || classe === 'Ritualista (Abismancia)') {
                multiplier = 4;
            }
            
            let totalCost = 0;
            for (let level = currentLevel + 1; level <= targetLevel; level++) {
                totalCost += level * multiplier;
            }
            
            const currentEXP = char.exp || 0;
            if (currentEXP < totalCost) {
                alert(`‚ùå EXP Insuficiente!\n\nPrecisa: ${totalCost} EXP\nTem: ${currentEXP} EXP\nFalta: ${totalCost - currentEXP} EXP`);
                return;
            }
            
            const levelDiff = targetLevel - currentLevel;
            const abilityName = abilityId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const msg = levelDiff === 1 
                ? `Aumentar ${abilityName} de ${currentLevel} ‚Üí ${targetLevel}?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`
                : `Aumentar ${abilityName} de ${currentLevel} ‚Üí ${targetLevel} (+${levelDiff})?\n\nCusto: ${totalCost} EXP (√ó${multiplier})`;
            
            if (confirm(msg)) {
                char.classAbilities[abilityId] = targetLevel;
                char.exp = currentEXP - totalCost;
                updateClassAbilityDots(abilityId);
                updateClassTests();
                updateClassResourcesDisplay();
                updateAllCalculations();
                updateEXPDisplay();
                showAlert(`‚úÖ ${abilityName} ‚Üí ${targetLevel}! (-${totalCost} EXP)`, 'success');
                autoSave();
            }
        }
        
        function updateEXPDisplay() {
            const char = getChar();
            const expDisplay = document.getElementById('exp-display');
            if (expDisplay) {
                expDisplay.textContent = char.exp || 0;
            }
        }
        
    </script>
</body>
</html>
