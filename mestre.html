<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Mestre</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0f172a;
      --panel: #1e293b;
      --border: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --accent: #8b5cf6;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, rgba(79,70,229,0.25), transparent 55%), var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem clamp(1rem, 5vw, 3rem);
      display: flex;
      justify-content: center;
    }

    main {
      width: min(1100px, 100%);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
    }

    h1 {
      font-size: clamp(1.5rem, 4vw, 2.4rem);
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    h1 span {
      color: var(--accent);
    }

    .status-area {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.75);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .status-message {
      font-size: 0.95rem;
      color: var(--muted);
    }

    button {
      appearance: none;
      border: none;
      border-radius: 0.75rem;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      font-weight: 600;
      color: #0b1120;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
    }

    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }

    button:hover:not([disabled]) {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .alert {
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
    }

    .alert-success { background: rgba(34,197,94,0.12); color: var(--success); border: 1px solid rgba(34,197,94,0.4); }
    .alert-danger { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.35); }

    .panel {
      border-radius: 1rem;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      padding: 1.5rem;
      display: none;
      flex-direction: column;
      gap: 1rem;
    }

    .panel.active {
      display: flex;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar input {
      flex: 1;
      min-width: min(220px, 100%);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.6);
      color: var(--text);
      padding: 0.65rem 1rem;
      font-size: 1rem;
      outline: none;
    }

    .toolbar input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(139,92,246,0.25);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 0.75rem;
      overflow: hidden;
      font-size: 0.95rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 0.9rem;
      text-align: left;
      border-bottom: 1px solid rgba(148,163,184,0.15);
      vertical-align: top;
    }

    tbody tr:hover {
      background: rgba(148,163,184,0.08);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(148,163,184,0.18);
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 600;
    }

    dialog::backdrop {
      background: rgba(15,23,42,0.55);
    }

    dialog {
      border: none;
      border-radius: 1rem;
      width: min(640px, 92vw);
      padding: 0;
      overflow: hidden;
      background: rgba(15,23,42,0.95);
      color: var(--text);
    }

    .modal-header {
      padding: 1.25rem 1.5rem 0.75rem;
      border-bottom: 1px solid rgba(148,163,184,0.12);
    }

    .modal-body {
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      padding: 1rem;
      background: rgba(2,6,23,0.85);
      color: var(--text);
      font-family: "Fira Code", "SFMono-Regular", "Consolas", monospace;
      font-size: 0.92rem;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(139,92,246,0.25);
    }

    .modal-footer {
      padding: 1rem 1.5rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid rgba(148,163,184,0.12);
    }

    @media (max-width: 640px) {
      th:nth-child(3), td:nth-child(3) {
        display: none;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>ðŸ‘‘ <span>Painel do Mestre</span></h1>
        <p class="status-message">Gerencie fichas em tempo real. Apenas mestres cadastrados possuem acesso.</p>
      </div>
      <div style="display:flex; gap:0.5rem; flex-wrap: wrap;">
        <button id="loginButton" style="display:none;">Entrar</button>
        <button id="logoutButton" class="btn-secondary" style="display:none;">Sair</button>
      </div>
    </header>

    <section class="status-area" id="accessArea">
      <strong id="accessTitle">Verificando autenticaÃ§Ã£o...</strong>
      <p class="status-message" id="accessMessage">Aguarde enquanto confirmamos suas permissÃµes de mestre.</p>
    </section>

    <section id="alertArea"></section>

    <section class="panel" id="masterPanel" aria-live="polite">
      <div class="toolbar">
        <input type="search" id="searchInput" placeholder="Buscar por ID, nome ou UID do dono" autocomplete="off">
        <span class="tag" id="charactersCount">0 fichas</span>
      </div>
      <div class="table-wrapper" style="overflow-x:auto;">
        <table aria-describedby="charactersCount">
          <thead>
            <tr>
              <th>ID da Ficha</th>
              <th>Nome</th>
              <th>Dono (ownerUid)</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody id="charactersBody">
            <tr>
              <td colspan="4" style="text-align:center; padding:1.5rem; color:var(--muted);">Nenhum personagem carregado.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <dialog id="editorModal">
    <div class="modal-header">
      <h2 style="font-size:1.25rem;">Editar ficha <span id="modalCharacterId" style="color:var(--accent);"></span></h2>
    </div>
    <div class="modal-body">
      <p class="status-message" style="color:var(--danger); font-weight:600;">
        Edite com cuidado. Campos desconhecidos serÃ£o salvos como enviados.
      </p>
      <textarea id="jsonTextarea"></textarea>
      <div id="modalError" class="alert alert-danger" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="cancelEdit">Cancelar</button>
      <button type="button" id="saveEdit">Salvar</button>
    </div>
  </dialog>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      onSnapshot,
      writeBatch,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA6r79XcsMr3KZUT1YZ8vQntIGspgULXcE",
      authDomain: "rpg-lendasereliquias.firebaseapp.com",
      projectId: "rpg-lendasereliquias",
      storageBucket: "rpg-lendasereliquias.firebasestorage.app",
      messagingSenderId: "546994339773",
      appId: "1:546994339773:web:0116cf7c8667f113075cd4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const state = {
      unsubscribeCharacters: null,
      characters: new Map(),
      selectedCharacterId: null,
      isSaving: false
    };

    const accessArea = document.getElementById('accessArea');
    const accessTitle = document.getElementById('accessTitle');
    const accessMessage = document.getElementById('accessMessage');
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const masterPanel = document.getElementById('masterPanel');
    const charactersBody = document.getElementById('charactersBody');
    const searchInput = document.getElementById('searchInput');
    const charactersCount = document.getElementById('charactersCount');
    const alertArea = document.getElementById('alertArea');
    const modal = document.getElementById('editorModal');
    const modalCharacterId = document.getElementById('modalCharacterId');
    const jsonTextarea = document.getElementById('jsonTextarea');
    const modalError = document.getElementById('modalError');
    const cancelEdit = document.getElementById('cancelEdit');
    const saveEdit = document.getElementById('saveEdit');

    loginButton.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    logoutButton.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        showAlert(`Erro ao sair: ${error.message}`, 'danger');
      }
    });

    cancelEdit.addEventListener('click', () => closeModal());
    saveEdit.addEventListener('click', () => handleSave());
    searchInput.addEventListener('input', () => renderTable());

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        teardownCharactersListener();
        masterPanel.classList.remove('active');
        accessTitle.textContent = 'SessÃ£o nÃ£o iniciada';
        accessMessage.textContent = 'Clique em "Entrar" para autenticar-se e acessar as fichas.';
        loginButton.style.display = '';
        logoutButton.style.display = 'none';
        return;
      }

      loginButton.style.display = 'none';
      logoutButton.style.display = '';

      try {
        accessTitle.textContent = 'Validando permissÃµes...';
        accessMessage.textContent = 'Checando se seu usuÃ¡rio estÃ¡ cadastrado como mestre.';

        const masterDoc = await getDoc(doc(db, 'masters', user.uid));

        if (!masterDoc.exists()) {
          teardownCharactersListener();
          masterPanel.classList.remove('active');
          accessTitle.textContent = 'Acesso negado (nÃ£o Ã© mestre)';
          accessMessage.textContent = 'Entre em contato com o administrador para ser adicionado em masters/{uid}.';
          showAlert('Seu usuÃ¡rio nÃ£o possui perfil de mestre. Painel bloqueado.', 'danger');
          return;
        }

        accessTitle.textContent = 'Acesso concedido';
        accessMessage.textContent = `Logado como mestre: ${user.email ?? user.uid}`;
        masterPanel.classList.add('active');
        listenCharacters();
      } catch (error) {
        console.error('Erro ao validar mestre', error);
        teardownCharactersListener();
        masterPanel.classList.remove('active');
        accessTitle.textContent = 'Erro ao validar acesso';
        accessMessage.textContent = 'NÃ£o foi possÃ­vel confirmar suas permissÃµes. Tente novamente mais tarde.';
        showAlert(`Erro: ${error.message}`, 'danger');
      }
    });

    function listenCharacters() {
      if (state.unsubscribeCharacters) {
        return;
      }

      const charactersRef = collection(db, 'characters');
      state.unsubscribeCharacters = onSnapshot(charactersRef, (snapshot) => {
        state.characters.clear();
        snapshot.forEach((docSnap) => {
          state.characters.set(docSnap.id, docSnap.data());
        });
        renderTable();
      }, (error) => {
        console.error('Erro ao escutar personagens', error);
        showAlert(`Erro ao carregar fichas: ${error.message}`, 'danger');
      });
    }

    function teardownCharactersListener() {
      if (state.unsubscribeCharacters) {
        state.unsubscribeCharacters();
        state.unsubscribeCharacters = null;
      }
      state.characters.clear();
      renderTable();
    }

    function renderTable() {
      const rows = [];
      const query = searchInput.value.trim().toLowerCase();
      const entries = Array.from(state.characters.entries());

      const filtered = !query ? entries : entries.filter(([id, data]) => {
        const name = (data.nome || data.name || '').toString().toLowerCase();
        const owner = (data.ownerUid || '').toString().toLowerCase();
        return id.toLowerCase().includes(query) || name.includes(query) || owner.includes(query);
      });

      charactersCount.textContent = `${filtered.length} ficha${filtered.length === 1 ? '' : 's'}`;

      if (!filtered.length) {
        charactersBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:1.5rem; color:var(--muted);">Nenhum personagem encontrado.</td></tr>';
        return;
      }

      for (const [id, data] of filtered) {
        const characterName = data.nome || data.name || 'â€”';
        const owner = data.ownerUid || 'â€”';
        rows.push(`
          <tr>
            <td style="font-family:monospace;">${escapeHtml(id)}</td>
            <td>${escapeHtml(characterName)}</td>
            <td><span class="tag">${escapeHtml(owner)}</span></td>
            <td><button data-id="${encodeURIComponent(id)}" class="btn-edit" style="font-size:0.9rem;">Editar</button></td>
          </tr>
        `);
      }

      charactersBody.innerHTML = rows.join('');

      charactersBody.querySelectorAll('button.btn-edit').forEach((button) => {
        button.addEventListener('click', () => openModal(decodeURIComponent(button.dataset.id)));
      });
    }

    function openModal(characterId) {
      const data = state.characters.get(characterId);
      if (!data) {
        showAlert('NÃ£o foi possÃ­vel localizar os dados da ficha selecionada.', 'danger');
        return;
      }

      state.selectedCharacterId = characterId;
      modalCharacterId.textContent = characterId;
      jsonTextarea.value = jsonPretty(data);
      modalError.style.display = 'none';
      modal.showModal();
    }

    function closeModal() {
      if (modal.open) {
        modal.close();
      }
      jsonTextarea.value = '';
      modalError.style.display = 'none';
      state.selectedCharacterId = null;
      setSaving(false);
    }

    async function handleSave() {
      if (state.isSaving) return;

      const characterId = state.selectedCharacterId;
      if (!characterId) {
        showAlert('Nenhuma ficha selecionada para salvar.', 'danger');
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(jsonTextarea.value);
      } catch (error) {
        modalError.textContent = `JSON invÃ¡lido: ${error.message}`;
        modalError.style.display = '';
        return;
      }

      const before = state.characters.get(characterId) || {};
      const changes = buildDiff(before, parsed);

      try {
        setSaving(true);
        const batch = writeBatch(db);
        const characterRef = doc(db, 'characters', characterId);
        batch.update(characterRef, parsed);

        const logRef = doc(collection(db, 'logs'));
        batch.set(logRef, {
          characterId,
          userUid: auth.currentUser?.uid || null,
          source: 'master-panel',
          changes,
          ts: serverTimestamp()
        });

        await batch.commit();
        showAlert('Salvo com sucesso!', 'success');
        closeModal();
      } catch (error) {
        console.error('Erro ao salvar ficha', error);
        modalError.textContent = `Erro ao salvar: ${error.message}`;
        modalError.style.display = '';
      } finally {
        setSaving(false);
      }
    }

    function setSaving(saving) {
      state.isSaving = saving;
      saveEdit.disabled = saving;
      saveEdit.textContent = saving ? 'Salvando...' : 'Salvar';
    }

    function jsonPretty(obj) {
      return JSON.stringify(obj, null, 2);
    }

    function buildDiff(before, after) {
      const changes = [];
      const keys = new Set([
        ...Object.keys(before || {}),
        ...Object.keys(after || {})
      ]);
      for (const key of keys) {
        const prev = before?.[key];
        const next = after?.[key];
        if (JSON.stringify(prev) !== JSON.stringify(next)) {
          changes.push({
            field: key,
            before: prev === undefined ? null : prev,
            after: next === undefined ? null : next
          });
        }
      }
      return changes;
    }

    function escapeHtml(value) {
      return value
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function showAlert(message, type = 'success') {
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.textContent = message;
      alertArea.appendChild(div);
      setTimeout(() => {
        if (div.parentNode === alertArea) {
          alertArea.removeChild(div);
        }
      }, 6000);
    }

    window.addEventListener('beforeunload', () => {
      teardownCharactersListener();
    });
  </script>
</body>
</html>
